!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("@angular/core"),require("@c8y/ngx-components"),require("lodash-es"),require("@c8y/client"),require("@ngx-translate/core"),require("@angular/common"),require("ngx-bootstrap/modal"),require("ngx-bootstrap/dropdown"),require("ngx-bootstrap/tooltip"),require("angular"),require("@c8y/ng1-modules/core/bootstrap"),require("@angular/upgrade/static")):"function"==typeof define&&define.amd?define("@c8y/ngx-components/reports",["exports","@angular/core","@c8y/ngx-components","lodash-es","@c8y/client","@ngx-translate/core","@angular/common","ngx-bootstrap/modal","ngx-bootstrap/dropdown","ngx-bootstrap/tooltip","angular","@c8y/ng1-modules/core/bootstrap","@angular/upgrade/static"],n):n(((e=e||self).c8y=e.c8y||{},e.c8y["ngx-components"]=e.c8y["ngx-components"]||{},e.c8y["ngx-components"].reports={}),e.ng.core,e.c8y["ngx-components"],e.lodashEs,e.client,e.core$1,e.ng.common,e.modal,e.dropdown,e.tooltip,e.angular,e.bootstrap,e.ng.upgrade.static)}(this,(function(e,n,t,o,a,i,s,r,l,c,u,d,h){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function p(e,n,t,o){var a,i=arguments.length,s=i<3?n:null===o?o=Object.getOwnPropertyDescriptor(n,t):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,n,t,o);else for(var r=e.length-1;r>=0;r--)(a=e[r])&&(s=(i<3?a(s):i>3?a(n,t,s):a(n,t))||s);return i>3&&s&&Object.defineProperty(n,t,s),s}function m(e,n,t,o){return new(t||(t=Promise))((function(a,i){function s(e){try{l(o.next(e))}catch(e){i(e)}}function r(e){try{l(o.throw(e))}catch(e){i(e)}}function l(e){var n;e.done?a(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,r)}l((o=o.apply(e,n||[])).next())}))}function v(e,n){var t,o,a,i,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function r(i){return function(r){return function(i){if(t)throw new TypeError("Generator is already executing.");for(;s;)try{if(t=1,o&&(a=2&i[0]?o.return:i[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,i[1])).done)return a;switch(o=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(a=s.trys,(a=a.length>0&&a[a.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){s.label=i[1];break}if(6===i[0]&&s.label<a[1]){s.label=a[1],a=i;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(i);break}a[2]&&s.ops.pop(),s.trys.pop();continue}i=n.call(e,s)}catch(e){i=[6,e],o=0}finally{t=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,r])}}}var f,g,y=function(){function e(e,n,t){this.alertService=e,this.inventoryService=n,this.client=t,this.microserviceUrl="/service/reporting/schedule",this.headers={"Content-Type":"application/json"}}return e.prototype.getExport=function(e){return m(this,void 0,void 0,(function(){var n,t,o,a;return v(this,(function(i){switch(i.label){case 0:return[4,this.inventoryService.detail(e)];case 1:return t=i.sent(),o=t.data,200!==(a=t.res).status?this.alertService.addServerFailure({data:o,res:a}):n=o||{},[2,n]}}))}))},e.prototype.getScheduleList=function(e){return m(this,void 0,void 0,(function(){var n;return v(this,(function(t){switch(t.label){case 0:return[4,this.getExport(e)];case 1:return n=t.sent(),[2,this.extractScheduleListFromExport(n)]}}))}))},e.prototype.extractScheduleListFromExport=function(e){var n;return e&&(n=e.c8y_ScheduleConfiguration?e.c8y_ScheduleConfiguration:[]),o.orderBy(n,["timestamp"],["desc"])},e.prototype.addSchedule=function(e,n){return m(this,void 0,void 0,(function(){return v(this,(function(t){switch(t.label){case 0:return[4,this.updateSchedules(n,[],[e])];case 1:return[2,t.sent()]}}))}))},e.prototype.updateSchedule=function(e,n,t){return m(this,void 0,void 0,(function(){return v(this,(function(o){switch(o.label){case 0:return[4,this.updateSchedules(t,[e],[n])];case 1:return[2,o.sent()]}}))}))},e.prototype.updateSchedules=function(e,n,t){return void 0===n&&(n=[]),void 0===t&&(t=[]),m(this,void 0,void 0,(function(){var a,i,s,r,l,c;return v(this,(function(u){switch(u.label){case 0:return a=!1,[4,this.getExport(e)];case 1:return i=u.sent(),s=this.extractScheduleListFromExport(i),o.remove(s,(function(e){return o.some(n,(function(n){return o.isEqual(e,n)}))})),s.push.apply(s,t),i.c8y_ScheduleConfiguration=s,[4,this.inventoryService.update(i)];case 2:return r=u.sent(),l=r.data,200!==(c=r.res).status?[3,4]:[4,this.reschedule(e)];case 3:return a=u.sent(),[3,5];case 4:this.alertService.addServerFailure({data:l,res:c}),u.label=5;case 5:return[2,a]}}))}))},e.prototype.reschedule=function(e){return m(this,void 0,void 0,(function(){var n;return v(this,(function(t){switch(t.label){case 0:return n={method:"PUT",headers:this.headers},[4,this.client.fetch(this.microserviceUrl+"/"+e,n)];case 1:return[2,200===t.sent().status]}}))}))},e.prototype.deleteSchedule=function(e,n){return m(this,void 0,void 0,(function(){return v(this,(function(t){switch(t.label){case 0:return[4,this.updateSchedules(n,[e],[])];case 1:return[2,t.sent()]}}))}))},e.ctorParameters=function(){return[{type:t.AlertService},{type:a.InventoryService},{type:a.FetchClient}]},e=p([n.Injectable()],e)}();(f=e.ActionType||(e.ActionType={})).CREATE="create",f.EDIT="edit",f.DUPLICATE="duplicate",(g=e.Base||(e.Base={}))[g.Initial=1]="Initial",g[g.Hour=2]="Hour",g[g.Day=3]="Day",g[g.Week=4]="Week",g[g.Month=5]="Month",g[g.Year=6]="Year";var b=function(){function o(e){this.translateService=e,this.daysOfWeekPosix=[],this.daysOfMonth=[{value:"1",label:"1."},{value:"2",label:"2."},{value:"3",label:"3."},{value:"4",label:"4."},{value:"5",label:"5."},{value:"6",label:"6."},{value:"7",label:"7."},{value:"8",label:"8."},{value:"9",label:"9."},{value:"10",label:"10."},{value:"11",label:"11."},{value:"12",label:"12."},{value:"13",label:"13."},{value:"14",label:"14."},{value:"15",label:"15."},{value:"16",label:"16."},{value:"17",label:"17."},{value:"18",label:"18."},{value:"19",label:"19."},{value:"20",label:"20."},{value:"21",label:"21."},{value:"22",label:"22."},{value:"23",label:"23."},{value:"24",label:"24."},{value:"25",label:"25."},{value:"26",label:"26."},{value:"27",label:"27."},{value:"28",label:"28."},{value:"29",label:"29."},{value:"30",label:"30."},{value:"31",label:"31."}],this.months=[],this.hours=[],this.minutes=[],this.intervals=[{value:2,label:t.gettext("Hour")},{value:3,label:t.gettext("Day")},{value:4,label:t.gettext("Week")},{value:5,label:t.gettext("Month")},{value:6,label:t.gettext("Year")}];for(var n=0;n<24;n++)this.hours.push({value:n.toString(),label:""+n});for(n=0;n<60;n+=5)this.minutes.push({value:n.toString(),label:""+n});for(n=0;n<7;n++)this.daysOfWeekPosix.push({value:n.toString(),label:this.getWeekDayName({weekday:n})});for(n=1;n<13;n++)this.months.push({value:n.toString(),label:this.getMonthName({month:n})})}return o.prototype.generateCron=function(e){var n="";return n=e.minute?""+e.minute:"*",n+=e.hour?" "+e.hour:" *",n+=e.day?" "+e.day:" *",n+=e.month?" "+e.month:" *",n+=e.weekday?" "+e.weekday:" *"},o.prototype.generateCronConfig=function(e){var n=e.split(/\s+/);return{minute:n[0],hour:n[1],day:n[2],month:n[3],weekday:n[4]}},o.prototype.getBase=function(n){var t=e.Base.Initial;return"*"!==n.minute&&"*"===n.hour&&"*"===n.day&&"*"===n.month&&"*"===n.weekday?t=e.Base.Hour:"*"!==n.minute&&"*"!==n.hour&&"*"===n.day&&"*"===n.month&&"*"===n.weekday?t=e.Base.Day:"*"!==n.minute&&"*"!==n.hour&&"*"===n.day&&"*"===n.month&&"*"!==n.weekday?t=e.Base.Week:"*"!==n.minute&&"*"!==n.hour&&"*"!==n.day&&"*"===n.month&&"*"===n.weekday?t=e.Base.Month:"*"!==n.minute&&"*"!==n.hour&&"*"!==n.day&&"*"!==n.month&&"*"===n.weekday&&(t=e.Base.Year),t},o.prototype.validateModels=function(n,t){var o;switch(n){case e.Base.Initial:o=!1;break;case e.Base.Hour:o="*"!==t.minute;break;case e.Base.Day:o="*"!==t.minute&&"*"!==t.hour;break;case e.Base.Week:o="*"!==t.minute&&"*"!==t.hour&&"*"!==t.weekday;break;case e.Base.Month:o="*"!==t.minute&&"*"!==t.hour&&"*"!==t.day;break;case e.Base.Year:o="*"!==t.minute&&"*"!==t.hour&&"*"!==t.day&&"*"!==t.month;break;default:o=!1}return o},o.prototype.clearNextModels=function(n,t){n===e.Base.Initial?(t.minute="*",t.hour="*",t.day="*",t.month="*",t.weekday="*"):n===e.Base.Hour?(t.minute="*"===t.minute?this.minutes[0].value:t.minute,t.hour="*",t.day="*",t.month="*",t.weekday="*"):n===e.Base.Day?(t.minute="*"===t.minute?this.minutes[0].value:t.minute,t.hour="*"===t.hour?this.hours[0].value:t.hour,t.day="*",t.month="*",t.weekday="*"):n===e.Base.Week?(t.minute="*"===t.minute?this.minutes[0].value:t.minute,t.hour="*"===t.hour?this.hours[0].value:t.hour,t.day="*",t.month="*",t.weekday="*"===t.weekday||"?"===t.weekday?this.daysOfWeekPosix[0].value:t.weekday):n===e.Base.Month?(t.minute="*"===t.minute?this.minutes[0].value:t.minute,t.hour="*"===t.hour?this.hours[0].value:t.hour,t.day="*"===t.day?this.daysOfMonth[0].value:t.day,t.month="*",t.weekday="*"):n===e.Base.Year&&(t.minute="*"===t.minute?this.minutes[0].value:t.minute,t.hour="*"===t.hour?this.hours[0].value:t.hour,t.day="*"===t.day?this.daysOfMonth[0].value:t.day,t.month="*"===t.month?this.months[0].value:t.month,t.weekday="*")},o.prototype.getWeekDayName=function(e){var n=new Date(0),t=n.getDate()+3;return n.setDate(t+parseInt(e.weekday,10)),s.formatDate(n,"EEEE",this.translateService.currentLang)},o.prototype.getMonthDayName=function(e){var n="";return this.daysOfMonth.forEach((function(t){t.value===e.day&&(n=t.label)})),n},o.prototype.getMonthName=function(e){var n=new Date(0);return n.setMonth(parseInt(e.month,10)-1),s.formatDate(n,"LLLL",this.translateService.currentLang)},o.ctorParameters=function(){return[{type:i.TranslateService}]},o=p([n.Injectable()],o)}(),S=function(){function a(o,a,i){this.reportsService=o,this.modalRef=a,this.cronService=i,this.emitter=new n.EventEmitter,this.ActionType=e.ActionType,this.cronExpression="* * * * *",this.validCron=!1,this.emitterPayload={success:!1,message:"",schedule:{timestamp:void 0,emailConfig:void 0,cronConfig:void 0}},this.placeholdersInfo=t.gettext("Available placeholders: {tenant-domain}, {host}, {binaryId}. Whole link to downloadable file is: {tenant-domain}/inventory/binaries/{binaryId}.")}return a.prototype.ngOnInit=function(){this.oldSchedule=o.cloneDeep(this.schedule),this.populateEmailFieldsFromSchedule(this.schedule),this.cronExpression=this.cronService.generateCron(this.schedule.cronConfig),this.validCron=this.cronService.validateModels(this.cronService.getBase(this.schedule.cronConfig),this.schedule.cronConfig)},a.prototype.populateEmailFieldsFromSchedule=function(e){e.emailConfig.to&&e.emailConfig.to.length&&(this.emailTo=e.emailConfig.to.toString()),e.emailConfig.cc&&e.emailConfig.cc.length&&(this.emailCc=e.emailConfig.cc.toString()),e.emailConfig.bcc&&e.emailConfig.bcc.length&&(this.emailBcc=e.emailConfig.bcc.toString()),e.emailConfig.replyTo&&(this.emailReplyTo=e.emailConfig.replyTo),e.emailConfig.subject&&(this.emailSubject=e.emailConfig.subject),e.emailConfig.text&&(this.emailText=e.emailConfig.text)},a.prototype.save=function(){if(this.populateScheduleFromCronExpression(),this.populateScheduleFromEmailFields(),this.actionType===e.ActionType.CREATE||this.actionType===e.ActionType.DUPLICATE){var n=(new Date).getTime();this.schedule.timestamp=n}this.emitterPayload.success=!0,this.emitterPayload.schedule=this.schedule,this.modalRef.hide(),this.emitter.emit(this.emitterPayload)},a.prototype.cancel=function(){this.modalRef.hide()},a.prototype.getCron=function(e){this.validCron=e.valid,e.valid&&(this.cronExpression=e.cron)},a.prototype.populateScheduleFromCronExpression=function(){this.schedule.cronConfig=this.cronService.generateCronConfig(this.cronExpression)},a.prototype.convertStringOfEmailsToArray=function(e){var n=[];e&&e.split(",").forEach((function(e){e&&n.push(e)}));return n},a.prototype.populateScheduleFromEmailFields=function(){this.schedule.emailConfig.to=this.emailTo?this.convertStringOfEmailsToArray(this.emailTo):null,this.schedule.emailConfig.cc=this.emailCc?this.convertStringOfEmailsToArray(this.emailCc):null,this.schedule.emailConfig.bcc=this.emailBcc?this.convertStringOfEmailsToArray(this.emailBcc):null,this.schedule.emailConfig.replyTo=this.emailReplyTo,this.schedule.emailConfig.subject=this.emailSubject,this.schedule.emailConfig.text=this.emailText},a.ctorParameters=function(){return[{type:y},{type:r.BsModalRef},{type:b}]},p([n.Output()],a.prototype,"emitter",void 0),a=p([n.Component({selector:"schedule-modal",template:'<div class="modal-header text-center bg-primary">\n  <header class="text-white">\n    <div style="font-size: 62px;">\n      <span c8yIcon="c8y-report"></span>\n    </div>\n    <h4 class="text-uppercase">\n      <span *ngIf="actionType === ActionType.CREATE" translate>New export schedule</span>\n      <span *ngIf="actionType === ActionType.EDIT" translate>Edit export schedule</span>\n      <span *ngIf="actionType === ActionType.DUPLICATE" translate>Duplicate export schedule</span>\n    </h4>\n  </header>\n</div>\n\n<div class="modal-body">\n  <p class="lead text-center p-t-24 m-b-0" translate>On schedule send export via email</p>\n</div>\n<div class="modal-inner-scroll smart-rule-control">\n  <form #scheduleForm="ngForm" class="edit-smart-rule-details">\n    <div class="list-group">\n      <div class="list-group-item bg-gray-white">\n        <div class="smart-list-icon-label">\n          <span class="dot bg-primary-light m-r-8">1</span>\n          <strong translate>Frequency</strong>\n        </div>\n        <div class="p-t-16">\n          <div class="form-group">\n            <cron [cronIn]="cronExpression" (emitter)="getCron($event)" name="cron"></cron>\n          </div>\n        </div>\n      </div>\n      <div class="list-group-item">\n        <div class="smart-list-icon-label">\n          <span class="dot bg-primary-light m-r-8">2</span>\n          <div class="d-inline-block">\n            <strong translate>Send email</strong>\n            <p class="help-block text-muted small p-absolute">\n              <i class="text-info m-r-4 text-14" c8yIcon="info-circle"></i>\n              <span translate\n                >Enter one or more valid email addresses, separated with a comma.</span\n              >\n            </p>\n          </div>\n        </div>\n        <div class="p-t-24">\n          <div class="form-group">\n            <label class="control-label" translate>Send to</label>\n            <c8y-form-group>\n              <input\n                emails\n                type="text"\n                class="form-control"\n                name="to"\n                [(ngModel)]="emailTo"\n                placeholder="{{\n                  \'e.g. joe.doe@example.com,john.smith@example.com`LOCALIZE`\' | translate\n                }}"\n                required\n              />\n            </c8y-form-group>\n          </div>\n\n          <div class="form-group">\n            <label class="control-label" translate>CC</label>\n            <c8y-form-group>\n              <input\n                emails\n                type="text"\n                class="form-control span"\n                name="cc"\n                placeholder="{{\n                  \'e.g. joe.doe@example.com,john.smith@example.com`LOCALIZE`\' | translate\n                }}"\n                [(ngModel)]="emailCc"\n              />\n            </c8y-form-group>\n          </div>\n\n          <div class="form-group">\n            <label class="control-label" translate>BCC</label>\n            <c8y-form-group>\n              <input\n                emails\n                type="text"\n                class="form-control span"\n                name="bcc"\n                placeholder="{{\n                  \'e.g. joe.doe@example.com,john.smith@example.com`LOCALIZE`\' | translate\n                }}"\n                [(ngModel)]="emailBcc"\n              />\n            </c8y-form-group>\n          </div>\n\n          <div class="form-group">\n            <label class="control-label" translate>Reply to (single email address)</label>\n            <c8y-form-group>\n              <input\n                email\n                type="text"\n                class="form-control span"\n                name="replyTo"\n                placeholder="{{ \'e.g. joe.doe@example.com`LOCALIZE`\' | translate }}"\n                [(ngModel)]="emailReplyTo"\n              />\n            </c8y-form-group>\n          </div>\n\n          <div class="form-group">\n            <label class="control-label" translate>Subject</label>\n            <c8y-form-group>\n              <input\n                type="text"\n                class="form-control span"\n                name="subject"\n                [(ngModel)]="emailSubject"\n                placeholder="{{ \'e.g. Daily report\' | translate }}"\n                required\n              />\n            </c8y-form-group>\n          </div>\n\n          <div class="form-group">\n            <label class="control-label" translate>Message</label>\n            <c8y-form-group>\n              <textarea\n                class="form-control"\n                name="text"\n                [(ngModel)]="emailText"\n                placeholder="{{ \'Message\' | translate }}"\n                rows="4"\n                required\n              ></textarea>\n              <p class="help-block text-muted">\n                {{ placeholdersInfo | translate }}\n              </p>\n            </c8y-form-group>\n          </div>\n        </div>\n      </div>\n    </div>\n  </form>\n</div>\n\n<div class="modal-footer">\n  <button class="btn btn-default" (click)="cancel()" title="{{ \'Cancel\' | translate }}">\n    {{ \'Cancel\' | translate }}\n  </button>\n  <button\n    class="btn btn-primary"\n    (click)="save()"\n    [disabled]="!validCron || !scheduleForm.form.valid"\n  >\n    <span>\n      <span *ngIf="actionType === ActionType.CREATE" title="{{ \'Create\' | translate }}">\n        {{ \'Create\' | translate }}\n      </span>\n      <span *ngIf="actionType === ActionType.EDIT" title="{{ \'Save\' | translate }}">\n        {{ \'Save\' | translate }}\n      </span>\n      <span *ngIf="actionType === ActionType.DUPLICATE" title="{{ \'Duplicate\' | translate }}">\n        {{ \'Duplicate\' | translate }}\n      </span>\n    </span>\n  </button>\n</div>\n'})],a)}(),x=function(){function s(e,o,a,i,s,r){this.reportsService=e,this.bsModalService=o,this.cronService=a,this.translateService=i,this.userService=s,this.optionsService=r,this.onSchedulesUpdate=new n.EventEmitter,this.scheduleList=[],this.initialSchedule={timestamp:null,emailConfig:{to:[],cc:[],bcc:[],replyTo:"",text:"",subject:""},cronConfig:{minute:"0",hour:"0",day:"1",month:"1",weekday:"?"}},this.listClass="interact-list",this.sortReverse=!1,this.isOpen={},this.isEditMenuOpen=!1,this.currentUserEmail="",this.hasRequiredRole=!1,this.defaultExportEmailTemplate=this.translateService.instant(t.gettext("File with exported data can be downloaded from {tenant-domain}/inventory/binaries/{binaryId}.")),this.loadingStatus={inProgress:!1,done:!1,error:!1}}return Object.defineProperty(s.prototype,"exportId",{set:function(e){this._exportId=e},enumerable:!0,configurable:!0}),s.prototype.ngOnInit=function(){return m(this,void 0,void 0,(function(){var e,n,o,a;return v(this,(function(i){switch(i.label){case 0:return e=this,[4,this.checkRole()];case 1:return e.hasRequiredRole=i.sent(),this.getScheduleList(!0),[4,this.getCurrentUserEmail()];case 2:return n=i.sent(),o=this.initialSchedule.emailConfig,[4,this.optionsService.getTenantOption("configuration","export.data.mail.text",this.defaultExportEmailTemplate)];case 3:return o.text=i.sent(),this.initialSchedule.emailConfig.to=n,a=this,[4,this.reportsService.getExport(this._exportId)];case 4:return a.exp=i.sent(),this.initialSchedule.emailConfig.subject=this.translateService.instant(t.gettext('Export of "{{expName}}"'),{expName:this.exp.name}),[2]}}))}))},s.prototype.ngOnChanges=function(){this.translateButtonTitles()},s.prototype.translateButtonTitles=function(){this.buttonLabels={edit:this.translateService.instant(t.gettext("Edit schedule")),editNoPermission:this.translateService.instant(t.gettext("Edit schedule - no permissions")),duplicate:this.translateService.instant(t.gettext("Duplicate schedule")),duplicateNoPermission:this.translateService.instant(t.gettext("Duplicate schedule - no permissions")),delete:this.translateService.instant(t.gettext("Delete schedule")),deleteNoPermission:this.translateService.instant(t.gettext("Delete schedule - no permissions"))}},s.prototype.getCurrentUserEmail=function(){return m(this,void 0,void 0,(function(){var e;return v(this,(function(n){switch(n.label){case 0:return[4,this.userService.current()];case 1:return[2,(e=n.sent().data)&&e.email?[e.email]:[]]}}))}))},s.prototype.checkRole=function(){return m(this,void 0,void 0,(function(){var e;return v(this,(function(n){switch(n.label){case 0:return[4,this.userService.current()];case 1:return e=n.sent().data,"ROLE_SCHEDULE_REPORT_ADMIN",[2,this.userService.hasRole(e,"ROLE_SCHEDULE_REPORT_ADMIN")]}}))}))},s.prototype.getScheduleList=function(e){return m(this,void 0,void 0,(function(){var n;return v(this,(function(t){switch(t.label){case 0:return e&&(this.loadingStatus.inProgress=!0),n=this,[4,this.reportsService.getScheduleList(this._exportId)];case 1:return n.scheduleList=t.sent(),e&&(this.loadingStatus.inProgress=!1),[2]}}))}))},s.prototype.addSchedule=function(){this.openAddEditModal(this._exportId,this.initialSchedule,e.ActionType.CREATE)},s.prototype.editSchedule=function(n,t,o){this.hasRequiredRole&&(o.preventDefault(),this.openAddEditModal(this._exportId,n,e.ActionType.EDIT,t))},s.prototype.duplicateSchedule=function(n,t){t.preventDefault(),this.openAddEditModal(this._exportId,n,e.ActionType.DUPLICATE)},s.prototype.openAddEditModal=function(e,n,t,a){var i=this,s={class:"modal-sm",initialState:{actionType:t,exportId:e,schedule:o.cloneDeep(n)}};this.modalRef=this.bsModalService.show(S,s),this.modalRef.content.emitter.subscribe((function(e){return i.getMessageFromModal(e,a)}))},s.prototype.getMessageFromModal=function(e,n){e.success&&(void 0!==n?this.scheduleList[n]=e.schedule:this.scheduleList.push(e.schedule),this.onSchedulesUpdate.emit(this.scheduleList))},s.prototype.removeSchedule=function(e,n,t){t.preventDefault(),this.scheduleList.splice(n,1),this.onSchedulesUpdate.emit(this.scheduleList)},s.ctorParameters=function(){return[{type:y},{type:r.BsModalService},{type:b},{type:i.TranslateService},{type:a.UserService},{type:t.OptionsService}]},p([n.Input()],s.prototype,"exportId",null),p([n.Output()],s.prototype,"onSchedulesUpdate",void 0),s=p([n.Component({selector:"export-schedules",template:'<div>\n  <div *ngIf="loadingStatus.inProgress" class="flex-row">\n    <c8y-loading></c8y-loading>\n    <span translate>Retrieving schedules…</span>\n  </div>\n\n  <div *ngIf="!loadingStatus.inProgress && loadingStatus.done && loadingStatus.error">\n    <div class="alert alert-warning max-width-100" translate>\n      Could not load schedules list.\n    </div>\n  </div>\n\n  <div *ngIf="!loadingStatus.inProgress && !loadingStatus.done && !loadingStatus.error">\n    <div class="c8y-empty-state text-center max-width-100" *ngIf="!scheduleList.length">\n      <h1 c8yIcon="c8y-report" class="c8y-icon-duocolor"></h1>\n      <h3 translate>No export schedules defined.</h3>\n    </div>\n\n    <div class="c8y-list__group" *ngIf="scheduleList.length">\n      <div class="c8y-list__item hidden-xs">\n        <div class="c8y-list__item__block">\n          <div class="c8y-list__item__icon">\n            <i class="fa"></i>\n          </div>\n          <div class="c8y-list__item__body">\n            <div class="flex-row">\n              <div class="col-sm-6">\n                <label class="m-0">\n                  {{ \'Description\' | translate }}\n                </label>\n              </div>\n              <div class="col-sm-6 m-r-40">\n                <label class="m-0">\n                  {{ \'Frequency\' | translate }}\n                </label>\n              </div>\n            </div>\n          </div>\n          <span></span>\n        </div>\n      </div>\n\n      <div\n        class="c8y-list__item flex-row pointer"\n        *ngFor="let schedule of scheduleList; index as i"\n        (click)="editSchedule(schedule, i, $event)"\n      >\n        <div class="c8y-list__item__block">\n          <div class="c8y-list__item__icon">\n            <i c8yIcon="c8y-report" class="c8y-icon-duocolor"></i>\n          </div>\n          <div class="c8y-list__item__body flex-row">\n            <div class="col-sm-6 col-xs-6">\n              <div class="text-truncate" title="{{ schedule.emailConfig.subject }}">\n                {{ schedule.emailConfig.subject }}\n              </div>\n            </div>\n            <div class="col-sm-6 col-xs-6">\n              <div class="flex-row a-i-baseline">\n                <i c8yIcon="calendar" class="text-muted m-r-4"></i>\n                <span class="smart-rule-information">\n                  <span\n                    *ngIf="cronService.getBase(schedule.cronConfig) === 2"\n                    ngNonBindable\n                    translate\n                    [translateParams]="{ minutes: schedule.cronConfig.minute | number: \'2.0-0\' }"\n                  >\n                    Hourly: {{ minutes }} minute(s) past the hour.\n                  </span>\n                  <span\n                    *ngIf="cronService.getBase(schedule.cronConfig) === 3"\n                    ngNonBindable\n                    translate\n                    [translateParams]="{\n                      hour: schedule.cronConfig.hour | number: \'2.0-0\',\n                      minutes: schedule.cronConfig.minute | number: \'2.0-0\'\n                    }"\n                  >\n                    Daily: at {{ hour }}:{{ minutes }}.\n                  </span>\n                  <span\n                    *ngIf="cronService.getBase(schedule.cronConfig) === 4"\n                    ngNonBindable\n                    translate\n                    [translateParams]="{\n                      weekDay: cronService.getWeekDayName(schedule.cronConfig),\n                      hour: schedule.cronConfig.hour | number: \'2.0-0\',\n                      minutes: schedule.cronConfig.minute | number: \'2.0-0\'\n                    }"\n                  >\n                    Weekly: {{ weekDay }}, at {{ hour }}:{{ minutes }}.\n                  </span>\n                  <span\n                    *ngIf="cronService.getBase(schedule.cronConfig) === 5"\n                    ngNonBindable\n                    translate\n                    [translateParams]="{\n                      monthDay: cronService.getMonthDayName(schedule.cronConfig),\n                      hour: schedule.cronConfig.hour | number: \'2.0-0\',\n                      minutes: schedule.cronConfig.minute | number: \'2.0-0\'\n                    }"\n                  >\n                    Monthly: {{ monthDay }} day of the month, at {{ hour }}:{{ minutes }}.\n                  </span>\n                  <span\n                    *ngIf="cronService.getBase(schedule.cronConfig) === 6"\n                    ngNonBindable\n                    translate\n                    [translateParams]="{\n                      month: cronService.getMonthName(schedule.cronConfig),\n                      monthDay: cronService.getMonthDayName(schedule.cronConfig),\n                      hour: schedule.cronConfig.hour | number: \'2.0-0\',\n                      minutes: schedule.cronConfig.minute | number: \'2.0-0\'\n                    }"\n                  >\n                    Yearly: {{ month }}, {{ monthDay }} day of the month, at {{ hour }}:{{\n                      minutes\n                    }}.\n                  </span>\n                </span>\n              </div>\n            </div>\n          </div>\n          <div class="c8y-list__item__actions" (click)="$event.stopPropagation()">\n            <div class="settings dropdown" dropdown>\n              <button\n                class="dropdown-toggle c8y-dropdown"\n                dropdownToggle\n                aria-haspopup="true"\n                aria-expanded="false"\n                title="{{ \'Actions\' | translate }}"\n              >\n                <i [c8yIcon]="\'ellipsis-v\'"></i>\n              </button>\n              <ul class="dropdown-menu dropdown-menu-right" *dropdownMenu>\n                <li role="menuitem">\n                  <button\n                    [title]="hasRequiredRole ? buttonLabels.edit : buttonLabels.editNoPermission"\n                    (click)="editSchedule(schedule, i, $event)"\n                    [disabled]="!hasRequiredRole"\n                  >\n                    <i [c8yIcon]="\'pencil\'"></i> {{ \'Edit\' | translate }}\n                  </button>\n                </li>\n                <li role="menuitem">\n                  <button\n                    [title]="\n                      hasRequiredRole ? buttonLabels.duplicate : buttonLabels.duplicateNoPermission\n                    "\n                    (click)="duplicateSchedule(schedule, $event)"\n                    [disabled]="!hasRequiredRole"\n                  >\n                    <i [c8yIcon]="\'copy\'"></i> {{ \'Duplicate\' | translate }}\n                  </button>\n                </li>\n                <li role="menuitem">\n                  <button\n                    [title]="\n                      hasRequiredRole ? buttonLabels.delete : buttonLabels.deleteNoPermission\n                    "\n                    (click)="removeSchedule(schedule, i, $event)"\n                    [disabled]="!hasRequiredRole"\n                  >\n                    <i [c8yIcon]="\'trash\'"></i> {{ \'Delete\' | translate }}\n                  </button>\n                </li>\n              </ul>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class="alert alert-warning max-width-100" *ngIf="!hasRequiredRole" role="alert" translate>\n    You don\'t have the permission required to schedule exports.\n  </div>\n  <button\n    type="button"\n    class="btn-add-block m-t-16"\n    title="{{ \'Add schedule\' | translate }}"\n    (click)="addSchedule()"\n    [disabled]="!hasRequiredRole"\n  >\n    <i [c8yIcon]="\'plus-circle\'"></i>\n    {{ \'Add schedule\' | translate }}\n  </button>\n</div>\n'})],s)}(),C=function(){function t(t){this.cronService=t,this.emitter=new n.EventEmitter,this.emittedCron={valid:!1,cron:""},this.base=e.Base.Initial}return t.prototype.ngOnInit=function(){this.daysOfWeekPosix=this.cronService.daysOfWeekPosix,this.daysOfMonth=this.cronService.daysOfMonth,this.months=this.cronService.months,this.hours=this.cronService.hours,this.minutes=this.cronService.minutes,this.intervals=this.cronService.intervals,this.cronConfig=this.cronService.generateCronConfig(this.cronIn),this.base=this.cronService.getBase(this.cronConfig)},t.prototype.onChangeSelect=function(){this.cronService.clearNextModels(this.base,this.cronConfig),this.emittedCron.valid=this.cronService.validateModels(this.base,this.cronConfig),this.emittedCron.cron=this.cronService.generateCron(this.cronConfig),this.emitter.emit(this.emittedCron)},t.ctorParameters=function(){return[{type:b}]},p([n.Input()],t.prototype,"cronIn",void 0),p([n.Output()],t.prototype,"emitter",void 0),t=p([n.Component({selector:"cron",template:'<div class="cron-wrap">\n  <div class="form-group smart-cron-job-every">\n    <label for="smart-cron-job-every" class="control-label" translate>\n      Interval\n    </label>\n    <div class="">\n      <div class="c8y-select-wrapper">\n        <select\n          class="cron-select form-control"\n          id="smart-cron-job-every"\n          [(ngModel)]="base"\n          required="true"\n          (change)="onChangeSelect()"\n        >\n          <option *ngIf="base === 1" value="1" translate>\n            Select…\n          </option>\n          <option *ngFor="let baseInterval of intervals" [ngValue]="baseInterval.value">\n            {{ baseInterval.label | translate }}\n          </option>\n        </select>\n        <span></span>\n      </div>\n    </div>\n  </div>\n  <div class="row">\n    <div class="form-group smart-cron-job-on col-md-6" *ngIf="base == 4">\n      <label class="control-label" for="smart-cron-job-on" translate>\n        Day\n      </label>\n\n      <div class="c8y-select-wrapper">\n        <select\n          class="cron-select form-control day-value"\n          id="smart-cron-job-on"\n          [(ngModel)]="cronConfig.weekday"\n          (change)="onChangeSelect()"\n        >\n          <option *ngFor="let dayOfWeek of daysOfWeekPosix" [ngValue]="dayOfWeek.value">\n            {{ dayOfWeek.label | translate }}\n          </option>\n        </select>\n        <span></span>\n      </div>\n    </div>\n\n    <div class="form-group smart-cron-job-of col-md-6" *ngIf="base == 6">\n      <label for="smart-cron-job-of" class="control-label" translate>\n        Month\n      </label>\n      <div>\n        <div class="c8y-select-wrapper">\n          <select\n            id="smart-cron-job-of"\n            class="cron-select form-control month-value"\n            [(ngModel)]="cronConfig.month"\n            (change)="onChangeSelect()"\n          >\n            <option *ngFor="let month of months" [ngValue]="month.value">\n              {{ month.label | translate }}\n            </option>\n          </select>\n          <span></span>\n        </div>\n      </div>\n    </div>\n\n    <div class="form-group smart-cron-job-on-the col-md-6" *ngIf="base >= 5">\n      <label for="smart-cron-job-on-the" class="control-label" translate>\n        Day\n      </label>\n      <div>\n        <div class="c8y-select-wrapper">\n          <select\n            id="smart-cron-job-on-the"\n            class="cron-select form-control day-of-month-value"\n            [(ngModel)]="cronConfig.day"\n            (change)="onChangeSelect()"\n          >\n            <option *ngFor="let dayOfMonth of daysOfMonth" [ngValue]="dayOfMonth.value">\n              {{ dayOfMonth.label | translate }}\n            </option>\n          </select>\n          <span></span>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <div class="form-group smart-cron-job-at" *ngIf="base >= 2">\n    <label for="smart-cron-job-at-hour" class="control-label">\n      <span *ngIf="base >= 3" translate>Time</span>\n      <span *ngIf="base < 3" translate>Minutes</span>\n    </label>\n    <div>\n      <div class="form-inline">\n        <div class="c8y-select-wrapper" *ngIf="base >= 3">\n          <select\n            id="smart-cron-job-at-hour"\n            class="cron-select form-control hour-value"\n            [(ngModel)]="cronConfig.hour"\n            (change)="onChangeSelect()"\n          >\n            <option *ngFor="let hour of hours" [ngValue]="hour.value">\n              {{ hour.value | number: \'2.0-0\' }}\n            </option>\n          </select>\n          <span></span>\n        </div>\n        <span *ngIf="base >= 3"> : </span>\n        <div class="c8y-select-wrapper">\n          <select\n            class="cron-select form-control minute-value"\n            id="smart-cron-job-at-minute"\n            [(ngModel)]="cronConfig.minute"\n            (change)="onChangeSelect()"\n          >\n            <option *ngFor="let minute of minutes" [ngValue]="minute.value">\n              {{ minute.value | number: \'2.0-0\' }}\n            </option>\n          </select>\n          <span></span>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n'})],t)}(),w=function(){function e(){}return e=p([n.NgModule({declarations:[x,S,C],imports:[t.CoreModule,t.FormsModule,l.BsDropdownModule,c.TooltipModule],entryComponents:[x,S,C],providers:[y,b],exports:[x,S,C]})],e)}(),I=h.downgradeComponent({component:x}),E=h.downgradeInjectable(y),T="c8y.upgrade.reports",M=(u.module(T,[]).directive("c8yExportSchedules",I).service("c8yReportsService",E),[T]);d.registerNgModule(M),e.CronComponent=C,e.CronService=b,e.ExportSchedulesComponent=x,e.ReportsModule=w,e.ReportsService=y,e.ScheduleModalComponent=S,e.ng1Modules=M,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=c8y-ngx-components-reports.umd.min.js.map