import * as tslib_1 from "tslib";
import { Component, Input, Output, EventEmitter, ViewChild } from '@angular/core';
import { gettext, DropAreaComponent } from '@c8y/ngx-components';
import { cloneDeep, has } from 'lodash-es';
import { OpcuaService } from './opcuaService';
var OpcuaServerConfigComponent = /** @class */ (function () {
    function OpcuaServerConfigComponent(opcuaService) {
        this.fileName = '';
        this.targetConnectionState = '1';
        this.minIntervalNumber = 1;
        this.connectionStatusLabel = '';
        this.canceled = new EventEmitter();
        this.removed = new EventEmitter();
        this.saved = new EventEmitter();
        this.changePassword = false;
        this.initialPasswordRequired = true;
        this.NONE = 'NONE';
        this.SIGN = 'SIGN';
        this.SIGN_ENC = 'SIGN_ENCRYPT';
        this.securityPolicies = {
            sign: [
                "BASIC256_" + this.SIGN,
                "BASIC128RSA15_" + this.SIGN,
                "BASIC256SHA256_" + this.SIGN
            ],
            sign_enc: [
                "BASIC256_" + this.SIGN_ENC,
                "BASIC128RSA15_" + this.SIGN_ENC,
                "BASIC256SHA256_" + this.SIGN_ENC,
            ]
        };
        this.ANONYM = {
            id: 1,
            value: gettext('Anonymous')
        };
        this.USER_PASSWORD = {
            id: 2,
            value: gettext('Username/Password')
        };
        this.KEY_BASED = {
            id: 3,
            value: gettext('Key-based Authentication')
        };
        this.initialKeystore = {
            lastModified: 0,
            name: '',
            type: '',
            slice: null,
            size: 0
        };
        this.keystore = this.initialKeystore;
        this.authSwitch = false;
        this.opcuaService = opcuaService;
    }
    Object.defineProperty(OpcuaServerConfigComponent.prototype, "server", {
        get: function () {
            return this._server;
        },
        set: function (server) {
            if (server) {
                this._server = cloneDeep(server);
                this.model = cloneDeep(server);
                this.fileName = this.model.config.keystoreFilename;
                if (server.id && server.id === 'new') {
                    // enabled connection state
                    this.targetConnectionState = '1';
                    this.model.config.targetConnectionState = 'enabled';
                }
                else {
                    this.targetConnectionState = (this.model.config.targetConnectionState === 'enabled') ? '1' : '0';
                }
                this.updateConnectionStatusLabel(this._server);
                this.setNewPassword();
            }
        },
        enumerable: true,
        configurable: true
    });
    OpcuaServerConfigComponent.prototype.ngOnInit = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                this.authSwitch = false;
                this.securityModes = [
                    this.NONE,
                    this.SIGN,
                    this.SIGN_ENC
                ];
                this.authenticationModes = [
                    this.ANONYM,
                    this.USER_PASSWORD,
                    this.KEY_BASED
                ];
                this.setCurrentAuthenticationMode();
                this.setCurrentSecurityMode();
                return [2 /*return*/];
            });
        });
    };
    OpcuaServerConfigComponent.prototype.ngOnChanges = function () {
        this.setCurrentSecurityMode();
        this.setCurrentAuthenticationMode();
    };
    OpcuaServerConfigComponent.prototype.cancel = function () {
        this.canceled.emit(this.model);
    };
    OpcuaServerConfigComponent.prototype.remove = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0: return [4 /*yield*/, this.removeKeystore(this.model)];
                    case 1:
                        _a.sent();
                        this.removed.emit(this.model);
                        return [2 /*return*/];
                }
            });
        });
    };
    OpcuaServerConfigComponent.prototype.save = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var response, userPassword;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!(this.keystore && this.keystore.size > 0 && this.keystore.name && this.keystore.name.length > 0)) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.uploadKeystore(this.model.config.keystoreBinaryId)];
                    case 1:
                        response = _a.sent();
                        if (response && response.data && response.data.id) {
                            this.model.config.keystoreBinaryId = response.data.id;
                        }
                        // if the keystore was uploaded successful we can remove
                        // the local keystore. This will prevent another request to binary api
                        // when the user will edit other inputs in the form and hit save again.
                        this.keystore = this.initialKeystore;
                        _a.label = 2;
                    case 2:
                        // will remove keystore (binary) when the user switched
                        // authentication settings from key-based to anonymous or username/password
                        if (this.authSwitch) {
                            this.removeKeystore(this.server);
                        }
                        userPassword = this.getModelConfig('userPassword');
                        if (userPassword && userPassword.length > 0) {
                            this.model.config.passwordEncrypted = false;
                        }
                        this.saved.emit(this.model);
                        return [2 /*return*/];
                }
            });
        });
    };
    OpcuaServerConfigComponent.prototype.uploadFile = function (droppedFiles) {
        if (droppedFiles.length === 1) {
            this.keystore = droppedFiles[0].file;
            this.fileName = this.keystore.name;
        }
        else {
            // dropped more than one file
            console.warn('Tried to import... Import aborted.');
        }
    };
    OpcuaServerConfigComponent.prototype.setPolicy = function (data) {
        if (data === this.NONE) {
            this.model.config.securityMode = this.NONE;
        }
        else if (data === this.SIGN) {
            this.model.config.securityMode = this.securityPolicies.sign[0];
        }
        else if (data === this.SIGN_ENC) {
            this.model.config.securityMode = this.securityPolicies.sign_enc[0];
        }
    };
    OpcuaServerConfigComponent.prototype.setServerConnection = function (data) {
        this.model.config.targetConnectionState = (data !== '0') ? 'enabled' : 'disabled';
    };
    OpcuaServerConfigComponent.prototype.updateAuthentication = function (data) {
        if (data && data.id) {
            switch (data.id) {
                // Anonymous
                case 1:
                    this.resetUserAuthentication();
                    this.resetKeyBasedAuthentication();
                    break;
                // User/Password
                case 2:
                    this.resetKeyBasedAuthentication();
                    this.restoreUserData();
                    this.setNewPassword();
                    break;
                // Key-based
                case 3:
                    this.resetUserAuthentication();
                    this.restoreKeyBasedData();
                    break;
                default:
                    console.warn('Invalid authentication id', data.id);
                    break;
            }
        }
    };
    OpcuaServerConfigComponent.prototype.updateConnectionStatusLabel = function (server) {
        var connected = server.c8y_Connection && server.c8y_Connection.status === 'CONNECTED';
        var label = connected ? gettext('Connected') : gettext('Disconnected');
        this.connectionStatusLabel = label;
    };
    OpcuaServerConfigComponent.prototype.setNewPassword = function () {
        var username = this.getModelConfig('userName');
        if (username && username.length > 0) {
            // userName is given, NO need to change the password because it is already set
            this.changePassword = false;
            this.initialPasswordRequired = false;
        }
        else {
            // no userName in response, so require the user to set the initial pw
            this.changePassword = true;
            this.initialPasswordRequired = true;
        }
    };
    OpcuaServerConfigComponent.prototype.toggleChangePassword = function () {
        this.changePassword = !this.changePassword;
        // When the user hides the pw-input field but has entered a
        // string to it before, we need to discard the changes reflected in the model
        // otherwise we PUT it with the model when user hits the save button
        if (!this.changePassword) {
            if (this.getModelConfig('userPassword')) {
                delete this.model.config.userPassword;
            }
        }
    };
    OpcuaServerConfigComponent.prototype.uploadKeystore = function (binaryId) {
        if (!binaryId) {
            return this.opcuaService.uploadKeystore(this.keystore);
        }
        else if (binaryId && binaryId.length > 0) {
            // update existing binary
            return this.opcuaService.updateKeystore(binaryId, this.keystore);
        }
    };
    OpcuaServerConfigComponent.prototype.removeKeystore = function (server) {
        if (server &&
            server.config &&
            server.config.keystoreBinaryId &&
            server.config.keystoreBinaryId.length > 0) {
            this.authSwitch = false;
            return this.opcuaService.removeKeystore(this.server.config.keystoreBinaryId);
        }
    };
    OpcuaServerConfigComponent.prototype.resetUserAuthentication = function () {
        this.model.config.userName = null;
        this.model.config.userPassword = null;
        this.model.config.userIdentityMode = 'none';
    };
    OpcuaServerConfigComponent.prototype.resetKeyBasedAuthentication = function () {
        this.authSwitch = true;
        this.model.config.keystorePass = null;
        this.model.config.certificatePass = null;
        this.model.config.keystoreBinaryId = '';
        this.model.config.keystoreFilename = '';
        this.model.config.userIdentityMode = 'none';
    };
    OpcuaServerConfigComponent.prototype.restoreUserData = function () {
        this.model.config.userName = this._server.config.userName;
        this.model.config.userIdentityMode = 'userAndPassword';
    };
    OpcuaServerConfigComponent.prototype.restoreKeyBasedData = function () {
        this.authSwitch = false;
        this.model.config.keystorePass = this._server.config.keystorePass;
        this.model.config.certificatePass = this._server.config.certificatePass;
        this.model.config.keystoreBinaryId = this._server.config.keystoreBinaryId;
        this.model.config.keystoreFilename = this._server.config.keystoreFilename;
        this.model.config.userIdentityMode = 'certificate';
    };
    OpcuaServerConfigComponent.prototype.getServerConfig = function () {
        var cfg = {
            securityMode: this.NONE,
            userIdentityMode: 'none'
        };
        if (this.server && this.server.config) {
            cfg = this.server.config;
        }
        return cfg;
    };
    OpcuaServerConfigComponent.prototype.setCurrentSecurityMode = function () {
        var securityMode = this.getServerConfig().securityMode;
        if (securityMode) {
            var foundInSign = this.securityPolicies.sign.find(function (el) { return el === securityMode; });
            if (foundInSign) {
                this.currentSecMode = this.SIGN;
            }
            else {
                var foundInSignEncrypt = this.securityPolicies.sign_enc.find(function (el) { return el === securityMode; });
                foundInSignEncrypt ? this.currentSecMode = this.SIGN_ENC : this.currentSecMode = this.NONE;
            }
        }
    };
    OpcuaServerConfigComponent.prototype.setCurrentAuthenticationMode = function () {
        var userIdentityMode = this.getServerConfig().userIdentityMode;
        switch (userIdentityMode) {
            case 'certificate':
                this.authenticationMode = this.KEY_BASED;
                break;
            case 'userAndPassword':
                this.authenticationMode = this.USER_PASSWORD;
                break;
            case 'Anonymous':
                this.authenticationMode = this.ANONYM;
                break;
            case 'UserName':
                this.authenticationMode = this.USER_PASSWORD;
                break;
            case 'Certificate':
                this.authenticationMode = this.KEY_BASED;
                break;
            default:
                this.authenticationMode = this.ANONYM;
                break;
        }
    };
    OpcuaServerConfigComponent.prototype.getModelConfig = function (fragment) {
        if (this.model && this.model.config) {
            if (fragment && fragment.length > 0) {
                return has(this.model.config, fragment) ? this.model.config["" + fragment] : undefined;
            }
        }
        return undefined;
    };
    OpcuaServerConfigComponent.ctorParameters = function () { return [
        { type: OpcuaService }
    ]; };
    tslib_1.__decorate([
        ViewChild('opcuaConfigForm', { static: false })
    ], OpcuaServerConfigComponent.prototype, "opcuaConfigForm", void 0);
    tslib_1.__decorate([
        ViewChild(DropAreaComponent, { static: false })
    ], OpcuaServerConfigComponent.prototype, "dropArea", void 0);
    tslib_1.__decorate([
        Output()
    ], OpcuaServerConfigComponent.prototype, "canceled", void 0);
    tslib_1.__decorate([
        Output()
    ], OpcuaServerConfigComponent.prototype, "removed", void 0);
    tslib_1.__decorate([
        Output()
    ], OpcuaServerConfigComponent.prototype, "saved", void 0);
    tslib_1.__decorate([
        Input()
    ], OpcuaServerConfigComponent.prototype, "server", null);
    OpcuaServerConfigComponent = tslib_1.__decorate([
        Component({
            selector: 'opcua-server-config',
            template: "<form #opcuaConfigForm=\"ngForm\" class=\"card card-scroll\" *ngIf=\"server\">\n  <div class=\"card-header flex-wrap\">\n    <button\n      class=\"btn btn-clean visible-sm visible-xs\"\n      title=\"{{ 'Back' | translate }}\"\n      (click)=\"cancel()\"\n    >\n      <i c8yIcon=\"chevron-left\"></i\n      ><span translate>Back</span></button\n    ><br />\n    <!-- SERVER NAME -->\n    <label class=\"editable\" style=\"width: 100%;\">\n      <input\n        type=\"text\"\n        class=\"form-control input-lg\"\n        placeholder=\"{{ 'Server name' | translate }}\"\n        id=\"name\"\n        name=\"name\"\n        [(ngModel)]=\"model.name\"\n        required\n      />\n    </label>\n  </div>\n  <div class=\"inner-scroll\">\n    <div class=\"card-block bg-gray-lighter p-t-16\">\n      <div class=\"tight-grid\">\n        <div class=\"col-sm-6\">\n          <label style=\"width: 100%;\" translate>Server connection</label>\n          <button\n            type=\"button\"\n            class=\"btn m-t-4\"\n            name=\"serverConnection\"\n            [(ngModel)]=\"targetConnectionState\"\n            (ngModelChange)=\"setServerConnection($event)\"\n            btnCheckbox\n            btnCheckboxTrue=\"1\"\n            btnCheckboxFalse=\"0\"\n          >\n            <span\n              title=\"{{ 'Enabled' | translate }}\"\n              [hidden]=\"targetConnectionState !== '1'\"\n              translate\n              >Enabled</span\n            >\n            <span\n              title=\"{{ 'Disabled' | translate }}\"\n              [hidden]=\"targetConnectionState !== '0'\"\n              translate\n              >Disabled</span\n            >\n          </button>\n        </div>\n        <div class=\"col-sm-6\">\n          <label translate>Connection status</label>\n          <div class=\"form-control-static\">\n            <device-status class=\"p-r-8\" [mo]=\"server\"></device-status>\n            <span>{{ connectionStatusLabel | translate }}</span>\n          </div>\n        </div>\n      </div>\n    </div>\n    <div class=\"card-block\">\n      <!-- SERVER URL-->\n      <c8y-form-group>\n        <label for=\"configServerUrl\" translate>Server URL</label>\n        <input\n          type=\"text\"\n          class=\"form-control\"\n          id=\"configServerUrl\"\n          name=\"serverUrl\"\n          [(ngModel)]=\"model.config.serverUrl\"\n          c8yDefaultValidation=\"opcuaBrowsePath\"\n          required\n        />\n      </c8y-form-group>\n\n      <!-- TIMEOUT & STATUS-CHECK-INTERVAL-->\n      <div class=\"tight-grid\">\n        <div class=\"col-md-6\">\n          <c8y-form-group>\n            <label for=\"config.timeout\" translate>Timeout</label>\n            <div class=\"input-group\">\n              <input\n                type=\"number\"\n                class=\"form-control\"\n                id=\"config.timeout\"\n                name=\"timeout\"\n                [min]=\"minIntervalNumber\"\n                placeholder=\"{{ 'e.g.' | translate }} 30\"\n                [(ngModel)]=\"model.config.timeout\"\n                required\n              />\n              <span class=\"input-group-addon units\" translate>\n                seconds\n              </span>\n            </div>\n          </c8y-form-group>\n        </div>\n        <div class=\"col-md-6\">\n          <c8y-form-group>\n            <label for=\"config.statusCheckInterval\" translate>Status check interval</label>\n            <div class=\"input-group\">\n              <input\n                type=\"number\"\n                class=\"form-control\"\n                id=\"config.statusCheckInterval\"\n                name=\"statusCheckInterval\"\n                [min]=\"minIntervalNumber\"\n                placeholder=\"{{ 'e.g.' | translate }} 40\"\n                [(ngModel)]=\"model.config.statusCheckInterval\"\n                required\n              />\n              <span class=\"input-group-addon units\" translate>\n                seconds\n              </span>\n            </div>\n          </c8y-form-group>\n        </div>\n      </div>\n\n      <!-- SECURITY MODE -->\n      <div class=\"tight-grid\">\n        <div class=\"col-md-6\">\n          <div class=\"form-group\">\n            <!-- NONE, SIGN, SIGN & ENCRYPT-->\n            <label for=\"config.securityMode\" translate>Security mode</label>\n            <div class=\"c8y-select-wrapper\">\n              <select\n                class=\"form-control\"\n                id=\"config.securityMode\"\n                [(ngModel)]=\"currentSecMode\"\n                (ngModelChange)=\"setPolicy($event)\"\n                name=\"securityMode\"\n                required\n              >\n                <option *ngFor=\"let mode of securityModes\" [ngValue]=\"mode\">{{ mode }}</option>\n              </select>\n              <span></span>\n            </div>\n          </div>\n        </div>\n        <div *ngIf=\"currentSecMode === NONE\" class=\"col-md-6\">\n          <div class=\"form-group\">\n            <label for=\"config.securityPolicy\" translate>Security policy</label>\n            <input\n              type=\"text\"\n              class=\"form-control\"\n              id=\"config.securityPolicy\"\n              name=\"securityPolicy\"\n              [readonly]=\"true\"\n              [(ngModel)]=\"model.config.securityMode\"\n              required\n            />\n          </div>\n        </div>\n        <div *ngIf=\"currentSecMode !== NONE\" class=\"col-md-6\">\n          <div class=\"form-group\">\n            <label for=\"config.securityPolicy\" translate>Security policy</label>\n            <div class=\"c8y-select-wrapper\">\n              <select\n                *ngIf=\"currentSecMode === SIGN\"\n                class=\"form-control\"\n                id=\"config.securityPolicy\"\n                [(ngModel)]=\"model.config.securityMode\"\n                name=\"securityPolicy\"\n                required\n              >\n                <option *ngFor=\"let policy of securityPolicies.sign\" [ngValue]=\"policy\">{{\n                  policy\n                }}</option>\n              </select>\n              <select\n                *ngIf=\"currentSecMode === SIGN_ENC\"\n                class=\"form-control\"\n                id=\"config.securityPolicy\"\n                [(ngModel)]=\"model.config.securityMode\"\n                name=\"securityPolicy\"\n                required\n              >\n                <option *ngFor=\"let policy of securityPolicies.sign_enc\" [ngValue]=\"policy\">{{\n                  policy\n                }}</option>\n              </select>\n              <span></span>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <!-- AUTHENTICATION -->\n      <div class=\"form-group\">\n        <label for=\"config.authenticationMode\" translate>Authentication</label>\n        <div class=\"c8y-select-wrapper\">\n          <select\n            class=\"form-control\"\n            id=\"config.authenticationMode\"\n            [(ngModel)]=\"authenticationMode\"\n            name=\"authenticationMode\"\n            (ngModelChange)=\"updateAuthentication($event)\"\n            required\n          >\n            <option *ngFor=\"let auth of authenticationModes\" [ngValue]=\"auth\">{{\n              auth.value | translate\n            }}</option>\n          </select>\n          <span></span>\n        </div>\n      </div>\n\n      <!-- User/Pw-->\n      <div *ngIf=\"authenticationMode.id === 2\" class=\"tight-grid\">\n        <div class=\"col-md-12\">\n          <div class=\"form-group\">\n            <label for=\"config.userName\" translate>Username</label>\n            <input\n              type=\"text\"\n              class=\"form-control\"\n              id=\"config.userName\"\n              name=\"userName\"\n              placeholder=\"{{ 'e.g. joe.doe`LOCALIZE`' | translate }}\"\n              [(ngModel)]=\"model.config.userName\"\n              autocomplete=\"new-password\"\n              required\n            />\n          </div>\n        </div>\n        <!-- change password section BEGINS-->\n        <div class=\"col-md-6\">\n          <div class=\"form-group\" *ngIf=\"!initialPasswordRequired\">\n            <button type=\"button\" class=\"btn btn-default\" (click)=\"toggleChangePassword()\">\n              <ng-container *ngIf=\"!changePassword\">\n                {{ 'Change password' | translate }}\n              </ng-container>\n              <ng-container *ngIf=\"changePassword\">\n                {{ 'Cancel password change' | translate }}\n              </ng-container>\n            </button>\n          </div>\n\n          <div class=\"form-group\">\n            <div *ngIf=\"changePassword\">\n              <label for=\"config.password\" translate>Password</label>\n              <input\n                type=\"password\"\n                class=\"form-control\"\n                id=\"config.userPassword\"\n                name=\"password\"\n                [(ngModel)]=\"model.config.userPassword\"\n                autocomplete=\"new-password\"\n                required\n              />\n            </div>\n          </div>\n        </div>\n        <!-- change password section ENDS-->\n      </div>\n      <!-- Key-based -->\n      <div *ngIf=\"authenticationMode.id === 3\" class=\"tight-grid\">\n        <!-- KEYSTORE PASSWORD -->\n        <div class=\"col-md-6\">\n          <div class=\"form-group\">\n            <label for=\"config.keystorePass\" translate>Keystore password</label>\n            <input\n              type=\"password\"\n              class=\"form-control\"\n              id=\"config.keystorePass\"\n              name=\"keystorePass\"\n              [(ngModel)]=\"model.config.keystorePass\"\n              required\n            />\n          </div>\n        </div>\n        <div class=\"col-md-6\">\n          <div class=\"form-group\">\n            <label for=\"config.certificatePass\" translate>Certificate password</label>\n            <input\n              type=\"password\"\n              class=\"form-control\"\n              id=\"config.certificatePass\"\n              name=\"keystorePass\"\n              [(ngModel)]=\"model.config.certificatePass\"\n              required\n            />\n          </div>\n        </div>\n        <!-- UPLOAD KEYSTORE -->\n        <div class=\"col-md-12\">\n          <div class=\"form-group\">\n            <label for=\"certificateUpload\" translate>Upload keystore</label>\n            <input\n              type=\"text\"\n              [readonly]=\"true\"\n              name=\"certificateUpload\"\n              class=\"form-control m-b-8\"\n              [ngModel]=\"fileName\"\n              placeholder=\"{{ 'e.g.' | translate }} yourKeystore.jks\"\n              required\n            />\n            <c8y-drop-area\n              (dropped)=\"uploadFile($event)\"\n              [loadingMessage]=\"'Importing, please wait.' | translate\"\n              [title]=\"'Import keystore with jks file extension' | translate\"\n            >\n            </c8y-drop-area>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class=\"card-footer separator text-center\">\n    <button title=\"{{ 'Cancel' | translate }}\" class=\"btn btn-default\" (click)=\"cancel()\" translate>\n      Cancel\n    </button>\n    <button title=\"{{ 'Remove' | translate }}\" class=\"btn btn-danger\" (click)=\"remove()\" translate>\n      Remove\n    </button>\n    <!-- Add [disabled]=\"method()\" when form is invalid-->\n    <button\n      title=\"{{ 'Save' | translate }}\"\n      class=\"btn btn-primary\"\n      (click)=\"save()\"\n      [disabled]=\"!opcuaConfigForm.valid\"\n      translate\n    >\n      Save\n    </button>\n  </div> \n</form>\n"
        })
    ], OpcuaServerConfigComponent);
    return OpcuaServerConfigComponent;
}());
export { OpcuaServerConfigComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtc2VydmVyLWNvbmZpZy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL3Byb3RvY29sLW9wY3VhLyIsInNvdXJjZXMiOlsib3BjdWEtc2VydmVyLWNvbmZpZy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFVLE1BQU0sRUFBRSxZQUFZLEVBQWEsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JHLE9BQU8sRUFBRSxPQUFPLEVBQWUsaUJBQWlCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUU5RSxPQUFPLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBQyxNQUFNLFdBQVcsQ0FBQztBQUMxQyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFNOUM7SUE4RUUsb0NBQVksWUFBMEI7UUE1RXRDLGFBQVEsR0FBVyxFQUFFLENBQUM7UUFDdEIsMEJBQXFCLEdBQVcsR0FBRyxDQUFDO1FBQ3BDLHNCQUFpQixHQUFXLENBQUMsQ0FBQztRQUM5QiwwQkFBcUIsR0FBVyxFQUFFLENBQUM7UUFHekIsYUFBUSxHQUFHLElBQUksWUFBWSxFQUFlLENBQUM7UUFDM0MsWUFBTyxHQUFHLElBQUksWUFBWSxFQUFlLENBQUM7UUFDMUMsVUFBSyxHQUFHLElBQUksWUFBWSxFQUFlLENBQUM7UUF3QmxELG1CQUFjLEdBQVksS0FBSyxDQUFDO1FBQ2hDLDRCQUF1QixHQUFZLElBQUksQ0FBQztRQUl4QyxTQUFJLEdBQVcsTUFBTSxDQUFDO1FBQ3RCLFNBQUksR0FBVyxNQUFNLENBQUM7UUFDdEIsYUFBUSxHQUFXLGNBQWMsQ0FBQztRQUNsQyxxQkFBZ0IsR0FBUTtZQUN0QixJQUFJLEVBQUU7Z0JBQ0osY0FBWSxJQUFJLENBQUMsSUFBTTtnQkFDdkIsbUJBQWlCLElBQUksQ0FBQyxJQUFNO2dCQUM1QixvQkFBa0IsSUFBSSxDQUFD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T3V0cHV0LCBFdmVudEVtaXR0ZXIsIE9uQ2hhbmdlcywgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBnZXR0ZXh0LCBEcm9wcGVkRmlsZSwgRHJvcEFyZWFDb21wb25lbnQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IE9wY3VhU2VydmVyLCBPcGN1YVNlcnZlckNvbmZpZyB9IGZyb20gJy4vb3BjdWEtc2VydmVyLmludGVyZmFjZSc7XG5pbXBvcnQgeyBjbG9uZURlZXAsIGhhc30gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IE9wY3VhU2VydmljZSB9IGZyb20gJy4vb3BjdWFTZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnb3BjdWEtc2VydmVyLWNvbmZpZycsXG4gIHRlbXBsYXRlVXJsOiAnLi9vcGN1YS1zZXJ2ZXItY29uZmlnLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBPcGN1YVNlcnZlckNvbmZpZ0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcbiAgY3VycmVudFNlY01vZGU6IHN0cmluZztcbiAgZmlsZU5hbWU6IHN0cmluZyA9ICcnO1xuICB0YXJnZXRDb25uZWN0aW9uU3RhdGU6IHN0cmluZyA9ICcxJztcbiAgbWluSW50ZXJ2YWxOdW1iZXI6IG51bWJlciA9IDE7XG4gIGNvbm5lY3Rpb25TdGF0dXNMYWJlbDogc3RyaW5nID0gJyc7XG4gIEBWaWV3Q2hpbGQoJ29wY3VhQ29uZmlnRm9ybScsIHtzdGF0aWM6IGZhbHNlfSkgb3BjdWFDb25maWdGb3JtOiBhbnk7XG4gIEBWaWV3Q2hpbGQoRHJvcEFyZWFDb21wb25lbnQsIHtzdGF0aWM6IGZhbHNlfSkgZHJvcEFyZWE6IERyb3BBcmVhQ29tcG9uZW50O1xuICBAT3V0cHV0KCkgY2FuY2VsZWQgPSBuZXcgRXZlbnRFbWl0dGVyPE9wY3VhU2VydmVyPigpO1xuICBAT3V0cHV0KCkgcmVtb3ZlZCA9IG5ldyBFdmVudEVtaXR0ZXI8T3BjdWFTZXJ2ZXI+KCk7XG4gIEBPdXRwdXQoKSBzYXZlZCA9IG5ldyBFdmVudEVtaXR0ZXI8T3BjdWFTZXJ2ZXI+KCk7XG4gIEBJbnB1dCgpIHNldCBzZXJ2ZXIoc2VydmVyOiBPcGN1YVNlcnZlcikge1xuICAgIGlmIChzZXJ2ZXIpIHtcbiAgICAgIHRoaXMuX3NlcnZlciA9IGNsb25lRGVlcChzZXJ2ZXIpO1xuICAgICAgdGhpcy5tb2RlbCA9IGNsb25lRGVlcChzZXJ2ZXIpO1xuICAgICAgdGhpcy5maWxlTmFtZSA9IHRoaXMubW9kZWwuY29uZmlnLmtleXN0b3JlRmlsZW5hbWU7XG5cbiAgICAgIGlmIChzZXJ2ZXIuaWQgJiYgc2VydmVyLmlkID09PSAnbmV3Jykge1xuICAgICAgICAvLyBlbmFibGVkIGNvbm5lY3Rpb24gc3RhdGVcbiAgICAgICAgdGhpcy50YXJnZXRDb25uZWN0aW9uU3RhdGUgPSAnMSc7XG4gICAgICAgIHRoaXMubW9kZWwuY29uZmlnLnRhcmdldENvbm5lY3Rpb25TdGF0ZSA9ICdlbmFibGVkJztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMudGFyZ2V0Q29ubmVjdGlvblN0YXRlID0gKHRoaXMubW9kZWwuY29uZmlnLnRhcmdldENvbm5lY3Rpb25TdGF0ZSA9PT0gJ2VuYWJsZWQnKSA/ICcxJyA6ICcwJztcbiAgICAgIH1cbiAgICAgIHRoaXMudXBkYXRlQ29ubmVjdGlvblN0YXR1c0xhYmVsKHRoaXMuX3NlcnZlcik7XG4gICAgICB0aGlzLnNldE5ld1Bhc3N3b3JkKCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0IHNlcnZlcigpOiBPcGN1YVNlcnZlciB7XG4gICAgcmV0dXJuIHRoaXMuX3NlcnZlcjtcbiAgfVxuXG4gIG1vZGVsOiBPcGN1YVNlcnZlcjtcbiAgY2hhbmdlUGFzc3dvcmQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgaW5pdGlhbFBhc3N3b3JkUmVxdWlyZWQ6IGJvb2xlYW4gPSB0cnVlO1xuICBzZWN1cml0eU1vZGVzOiBzdHJpbmdbXTtcbiAgYXV0aGVudGljYXRpb25Nb2RlOiBhbnk7XG4gIGF1dGhlbnRpY2F0aW9uTW9kZXM6IGFueVtdO1xuICBOT05FOiBzdHJpbmcgPSAnTk9ORSc7XG4gIFNJR046IHN0cmluZyA9ICdTSUdOJztcbiAgU0lHTl9FTkM6IHN0cmluZyA9ICdTSUdOX0VOQ1JZUFQnO1xuICBzZWN1cml0eVBvbGljaWVzOiBhbnkgPSB7XG4gICAgc2lnbjogW1xuICAgICAgYEJBU0lDMjU2XyR7dGhpcy5TSUdOfWAsXG4gICAgICBgQkFTSUMxMjhSU0ExNV8ke3RoaXMuU0lHTn1gLFxuICAgICAgYEJBU0lDMjU2U0hBMjU2XyR7dGhpcy5TSUdOfWBcbiAgICBdLFxuICAgIHNpZ25fZW5jOiBbXG4gICAgICBgQkFTSUMyNTZfJHt0aGlzLlNJR05fRU5DfWAsXG4gICAgICBgQkFTSUMxMjhSU0ExNV8ke3RoaXMuU0lHTl9FTkN9YCxcbiAgICAgIGBCQVNJQzI1NlNIQTI1Nl8ke3RoaXMuU0lHTl9FTkN9YCxcbiAgICBdXG4gIH07XG4gIHByaXZhdGUgQU5PTllNID0ge1xuICAgIGlkOiAxLFxuICAgIHZhbHVlOiBnZXR0ZXh0KCdBbm9ueW1vdXMnKVxuICB9O1xuICBwcml2YXRlIFVTRVJfUEFTU1dPUkQgPSB7XG4gICAgaWQ6IDIsXG4gICAgdmFsdWU6IGdldHRleHQoJ1VzZXJuYW1lL1Bhc3N3b3JkJylcbiAgfTtcbiAgcHJpdmF0ZSBLRVlfQkFTRUQgPSB7XG4gICAgaWQ6IDMsXG4gICAgdmFsdWU6IGdldHRleHQoJ0tleS1iYXNlZCBBdXRoZW50aWNhdGlvbicpXG4gIH07XG4gIHByaXZhdGUgX3NlcnZlcjogT3BjdWFTZXJ2ZXI7XG4gIHByaXZhdGUgb3BjdWFTZXJ2aWNlOiBPcGN1YVNlcnZpY2U7XG4gIHByaXZhdGUgaW5pdGlhbEtleXN0b3JlOiBGaWxlID0ge1xuICAgIGxhc3RNb2RpZmllZDogMCxcbiAgICBuYW1lOiAnJyxcbiAgICB0eXBlOiAnJyxcbiAgICBzbGljZTogbnVsbCxcbiAgICBzaXplOiAwXG4gIH07XG4gIHByaXZhdGUga2V5c3RvcmU6IEZpbGUgPSB0aGlzLmluaXRpYWxLZXlzdG9yZTtcbiAgcHJpdmF0ZSBhdXRoU3dpdGNoOiBib29sZWFuID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3Iob3BjdWFTZXJ2aWNlOiBPcGN1YVNlcnZpY2UpIHtcbiAgICB0aGlzLm9wY3VhU2VydmljZSA9IG9wY3VhU2VydmljZTtcbiAgfVxuXG4gIGFzeW5jIG5nT25Jbml0KCkge1xuICAgIHRoaXMuYXV0aFN3aXRjaCA9IGZhbHNlO1xuXG4gICAgdGhpcy5zZWN1cml0eU1vZGVzID0gW1xuICAgICAgdGhpcy5OT05FLFxuICAgICAgdGhpcy5TSUdOLFxuICAgICAgdGhpcy5TSUdOX0VOQ1xuICAgIF07XG5cbiAgICB0aGlzLmF1dGhlbnRpY2F0aW9uTW9kZXMgPSBbXG4gICAgICB0aGlzLkFOT05ZTSxcbiAgICAgIHRoaXMuVVNFUl9QQVNTV09SRCxcbiAgICAgIHRoaXMuS0VZX0JBU0VEXG4gICAgXTtcblxuICAgIHRoaXMuc2V0Q3VycmVudEF1dGhlbnRpY2F0aW9uTW9kZSgpO1xuICAgIHRoaXMuc2V0Q3VycmVudFNlY3VyaXR5TW9kZSgpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoKSB7XG4gICAgdGhpcy5zZXRDdXJyZW50U2VjdXJpdHlNb2RlKCk7XG4gICAgdGhpcy5zZXRDdXJyZW50QXV0aGVudGljYXRpb25Nb2RlKCk7XG4gIH1cblxuICBjYW5jZWwoKSB7XG4gICAgdGhpcy5jYW5jZWxlZC5lbWl0KHRoaXMubW9kZWwpO1xuICB9XG5cbiAgYXN5bmMgcmVtb3ZlKCkge1xuICAgIGF3YWl0IHRoaXMucmVtb3ZlS2V5c3RvcmUodGhpcy5tb2RlbCk7XG4gICAgdGhpcy5yZW1vdmVkLmVtaXQodGhpcy5tb2RlbCk7XG4gIH1cblxuICBhc3luYyBzYXZlKCkge1xuICAgIGlmICh0aGlzLmtleXN0b3JlICYmIHRoaXMua2V5c3RvcmUuc2l6ZSA+IDAgJiYgdGhpcy5rZXlzdG9yZS5uYW1lICYmIHRoaXMua2V5c3RvcmUubmFtZS5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMudXBsb2FkS2V5c3RvcmUodGhpcy5tb2RlbC5jb25maWcua2V5c3RvcmVCaW5hcnlJZCk7XG5cbiAgICAgIGlmIChyZXNwb25zZSAmJiByZXNwb25zZS5kYXRhICYmIHJlc3BvbnNlLmRhdGEuaWQpIHtcbiAgICAgICAgdGhpcy5tb2RlbC5jb25maWcua2V5c3RvcmVCaW5hcnlJZCA9IHJlc3BvbnNlLmRhdGEuaWQ7XG4gICAgICB9XG5cbiAgICAgIC8vIGlmIHRoZSBrZXlzdG9yZSB3YXMgdXBsb2FkZWQgc3VjY2Vzc2Z1bCB3ZSBjYW4gcmVtb3ZlXG4gICAgICAvLyB0aGUgbG9jYWwga2V5c3RvcmUuIFRoaXMgd2lsbCBwcmV2ZW50IGFub3RoZXIgcmVxdWVzdCB0byBiaW5hcnkgYXBpXG4gICAgICAvLyB3aGVuIHRoZSB1c2VyIHdpbGwgZWRpdCBvdGhlciBpbnB1dHMgaW4gdGhlIGZvcm0gYW5kIGhpdCBzYXZlIGFnYWluLlxuICAgICAgdGhpcy5rZXlzdG9yZSA9IHRoaXMuaW5pdGlhbEtleXN0b3JlO1xuICAgIH1cblxuICAgIC8vIHdpbGwgcmVtb3ZlIGtleXN0b3JlIChiaW5hcnkpIHdoZW4gdGhlIHVzZXIgc3dpdGNoZWRcbiAgICAvLyBhdXRoZW50aWNhdGlvbiBzZXR0aW5ncyBmcm9tIGtleS1iYXNlZCB0byBhbm9ueW1vdXMgb3IgdXNlcm5hbWUvcGFzc3dvcmRcbiAgICBpZiAodGhpcy5hdXRoU3dpdGNoKSB7XG4gICAgICB0aGlzLnJlbW92ZUtleXN0b3JlKHRoaXMuc2VydmVyKTtcbiAgICB9XG5cbiAgICAvLyB3aGVuIHRoZSB1c2VyIHNldHMgYSBuZXcgcGFzc3dvcmQsIG1ha2Ugc3VyZSB0byBtYXJrIGl0IGFzXG4gICAgLy8gXCJub3QgZW5jcnlwdGVkXCIgYnkgc2V0dGluZyBwYXNzd29yZEVuY3J5cHRlZCB0byBmYWxzZVxuICAgIGNvbnN0IHVzZXJQYXNzd29yZDogc3RyaW5nID0gdGhpcy5nZXRNb2RlbENvbmZpZygndXNlclBhc3N3b3JkJyk7XG4gICAgaWYgKHVzZXJQYXNzd29yZCAmJiB1c2VyUGFzc3dvcmQubGVuZ3RoID4gMCkge1xuICAgICAgICB0aGlzLm1vZGVsLmNvbmZpZy5wYXNzd29yZEVuY3J5cHRlZCA9IGZhbHNlO1xuICAgIH1cblxuICAgIHRoaXMuc2F2ZWQuZW1pdCh0aGlzLm1vZGVsKTtcbiAgfVxuXG4gIHVwbG9hZEZpbGUoZHJvcHBlZEZpbGVzOiBEcm9wcGVkRmlsZVtdKSB7XG4gICAgaWYgKGRyb3BwZWRGaWxlcy5sZW5ndGggPT09IDEpIHtcbiAgICAgIHRoaXMua2V5c3RvcmUgPSBkcm9wcGVkRmlsZXNbMF0uZmlsZTtcbiAgICAgIHRoaXMuZmlsZU5hbWUgPSB0aGlzLmtleXN0b3JlLm5hbWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGRyb3BwZWQgbW9yZSB0aGFuIG9uZSBmaWxlXG4gICAgICBjb25zb2xlLndhcm4oJ1RyaWVkIHRvIGltcG9ydC4uLiBJbXBvcnQgYWJvcnRlZC4nKTtcbiAgICB9XG4gIH1cblxuICBzZXRQb2xpY3koZGF0YTogYW55KSB7XG4gICAgaWYgKGRhdGEgPT09IHRoaXMuTk9ORSkge1xuICAgICAgdGhpcy5tb2RlbC5jb25maWcuc2VjdXJpdHlNb2RlID0gdGhpcy5OT05FO1xuICAgIH0gZWxzZSBpZiAoZGF0YSA9PT0gdGhpcy5TSUdOKSB7XG4gICAgICB0aGlzLm1vZGVsLmNvbmZpZy5zZWN1cml0eU1vZGUgPSB0aGlzLnNlY3VyaXR5UG9saWNpZXMuc2lnblswXTtcbiAgICB9IGVsc2UgaWYgKGRhdGEgPT09IHRoaXMuU0lHTl9FTkMpIHtcbiAgICAgIHRoaXMubW9kZWwuY29uZmlnLnNlY3VyaXR5TW9kZSA9IHRoaXMuc2VjdXJpdHlQb2xpY2llcy5zaWduX2VuY1swXTtcbiAgICB9XG4gIH1cblxuICBzZXRTZXJ2ZXJDb25uZWN0aW9uKGRhdGE6IHN0cmluZykge1xuICAgIHRoaXMubW9kZWwuY29uZmlnLnRhcmdldENvbm5lY3Rpb25TdGF0ZSA9IChkYXRhICE9PSAnMCcpID8gJ2VuYWJsZWQnIDogJ2Rpc2FibGVkJztcbiAgfVxuXG4gIHVwZGF0ZUF1dGhlbnRpY2F0aW9uKGRhdGE6IGFueSkge1xuICAgIGlmIChkYXRhICYmIGRhdGEuaWQpIHtcbiAgICAgIHN3aXRjaCAoZGF0YS5pZCkge1xuICAgICAgICAvLyBBbm9ueW1vdXNcbiAgICAgICAgY2FzZSAxOlxuICAgICAgICAgIHRoaXMucmVzZXRVc2VyQXV0aGVudGljYXRpb24oKTtcbiAgICAgICAgICB0aGlzLnJlc2V0S2V5QmFzZWRBdXRoZW50aWNhdGlvbigpO1xuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIC8vIFVzZXIvUGFzc3dvcmRcbiAgICAgICAgY2FzZSAyOlxuICAgICAgICAgIHRoaXMucmVzZXRLZXlCYXNlZEF1dGhlbnRpY2F0aW9uKCk7XG4gICAgICAgICAgdGhpcy5yZXN0b3JlVXNlckRhdGEoKTtcbiAgICAgICAgICB0aGlzLnNldE5ld1Bhc3N3b3JkKCk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgLy8gS2V5LWJhc2VkXG4gICAgICAgIGNhc2UgMzpcbiAgICAgICAgICB0aGlzLnJlc2V0VXNlckF1dGhlbnRpY2F0aW9uKCk7XG4gICAgICAgICAgdGhpcy5yZXN0b3JlS2V5QmFzZWREYXRhKCk7XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBjb25zb2xlLndhcm4oJ0ludmFsaWQgYXV0aGVudGljYXRpb24gaWQnLCBkYXRhLmlkKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICB1cGRhdGVDb25uZWN0aW9uU3RhdHVzTGFiZWwoc2VydmVyKSB7XG4gICAgY29uc3QgY29ubmVjdGVkID0gc2VydmVyLmM4eV9Db25uZWN0aW9uICYmIHNlcnZlci5jOHlfQ29ubmVjdGlvbi5zdGF0dXMgPT09ICdDT05ORUNURUQnO1xuICAgIGNvbnN0IGxhYmVsID0gY29ubmVjdGVkID8gZ2V0dGV4dCgnQ29ubmVjdGVkJykgOiBnZXR0ZXh0KCdEaXNjb25uZWN0ZWQnKTtcbiAgICB0aGlzLmNvbm5lY3Rpb25TdGF0dXNMYWJlbCA9IGxhYmVsO1xuICB9XG5cbiAgc2V0TmV3UGFzc3dvcmQoKSB7XG4gICAgY29uc3QgdXNlcm5hbWU6IHN0cmluZyA9IHRoaXMuZ2V0TW9kZWxDb25maWcoJ3VzZXJOYW1lJyk7XG4gICAgaWYgKHVzZXJuYW1lICYmIHVzZXJuYW1lLmxlbmd0aCA+IDApIHtcbiAgICAgIC8vIHVzZXJOYW1lIGlzIGdpdmVuLCBOTyBuZWVkIHRvIGNoYW5nZSB0aGUgcGFzc3dvcmQgYmVjYXVzZSBpdCBpcyBhbHJlYWR5IHNldFxuICAgICAgdGhpcy5jaGFuZ2VQYXNzd29yZCA9IGZhbHNlO1xuICAgICAgdGhpcy5pbml0aWFsUGFzc3dvcmRSZXF1aXJlZCA9IGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBubyB1c2VyTmFtZSBpbiByZXNwb25zZSwgc28gcmVxdWlyZSB0aGUgdXNlciB0byBzZXQgdGhlIGluaXRpYWwgcHdcbiAgICAgIHRoaXMuY2hhbmdlUGFzc3dvcmQgPSB0cnVlO1xuICAgICAgdGhpcy5pbml0aWFsUGFzc3dvcmRSZXF1aXJlZCA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgdG9nZ2xlQ2hhbmdlUGFzc3dvcmQoKSB7XG4gICAgdGhpcy5jaGFuZ2VQYXNzd29yZCA9ICF0aGlzLmNoYW5nZVBhc3N3b3JkO1xuICAgIC8vIFdoZW4gdGhlIHVzZXIgaGlkZXMgdGhlIHB3LWlucHV0IGZpZWxkIGJ1dCBoYXMgZW50ZXJlZCBhXG4gICAgLy8gc3RyaW5nIHRvIGl0IGJlZm9yZSwgd2UgbmVlZCB0byBkaXNjYXJkIHRoZSBjaGFuZ2VzIHJlZmxlY3RlZCBpbiB0aGUgbW9kZWxcbiAgICAvLyBvdGhlcndpc2Ugd2UgUFVUIGl0IHdpdGggdGhlIG1vZGVsIHdoZW4gdXNlciBoaXRzIHRoZSBzYXZlIGJ1dHRvblxuICAgIGlmICghdGhpcy5jaGFuZ2VQYXNzd29yZCkge1xuICAgICAgaWYgKHRoaXMuZ2V0TW9kZWxDb25maWcoJ3VzZXJQYXNzd29yZCcpKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLm1vZGVsLmNvbmZpZy51c2VyUGFzc3dvcmQ7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGxvYWRLZXlzdG9yZShiaW5hcnlJZD86IHN0cmluZykge1xuICAgIGlmICghYmluYXJ5SWQpIHtcbiAgICAgIHJldHVybiB0aGlzLm9wY3VhU2VydmljZS51cGxvYWRLZXlzdG9yZSh0aGlzLmtleXN0b3JlKTtcbiAgICB9IGVsc2UgaWYgKGJpbmFyeUlkICYmIGJpbmFyeUlkLmxlbmd0aCA+IDApIHtcbiAgICAgIC8vIHVwZGF0ZSBleGlzdGluZyBiaW5hcnlcbiAgICAgIHJldHVybiB0aGlzLm9wY3VhU2VydmljZS51cGRhdGVLZXlzdG9yZShiaW5hcnlJZCwgdGhpcy5rZXlzdG9yZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVLZXlzdG9yZShzZXJ2ZXI6IE9wY3VhU2VydmVyKSB7XG4gICAgaWYgKHNlcnZlciAmJlxuICAgICAgc2VydmVyLmNvbmZpZyAmJlxuICAgICAgc2VydmVyLmNvbmZpZy5rZXlzdG9yZUJpbmFyeUlkICYmXG4gICAgICBzZXJ2ZXIuY29uZmlnLmtleXN0b3JlQmluYXJ5SWQubGVuZ3RoID4gMCkge1xuICAgICAgdGhpcy5hdXRoU3dpdGNoID0gZmFsc2U7XG4gICAgICByZXR1cm4gdGhpcy5vcGN1YVNlcnZpY2UucmVtb3ZlS2V5c3RvcmUodGhpcy5zZXJ2ZXIuY29uZmlnLmtleXN0b3JlQmluYXJ5SWQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVzZXRVc2VyQXV0aGVudGljYXRpb24oKSB7XG4gICAgdGhpcy5tb2RlbC5jb25maWcudXNlck5hbWUgPSBudWxsO1xuICAgIHRoaXMubW9kZWwuY29uZmlnLnVzZXJQYXNzd29yZCA9IG51bGw7XG4gICAgdGhpcy5tb2RlbC5jb25maWcudXNlcklkZW50aXR5TW9kZSA9ICdub25lJztcbiAgfVxuXG4gIHByaXZhdGUgcmVzZXRLZXlCYXNlZEF1dGhlbnRpY2F0aW9uKCkge1xuICAgIHRoaXMuYXV0aFN3aXRjaCA9IHRydWU7XG5cbiAgICB0aGlzLm1vZGVsLmNvbmZpZy5rZXlzdG9yZVBhc3MgPSBudWxsO1xuICAgIHRoaXMubW9kZWwuY29uZmlnLmNlcnRpZmljYXRlUGFzcyA9IG51bGw7XG4gICAgdGhpcy5tb2RlbC5jb25maWcua2V5c3RvcmVCaW5hcnlJZCA9ICcnO1xuICAgIHRoaXMubW9kZWwuY29uZmlnLmtleXN0b3JlRmlsZW5hbWUgPSAnJztcbiAgICB0aGlzLm1vZGVsLmNvbmZpZy51c2VySWRlbnRpdHlNb2RlID0gJ25vbmUnO1xuICB9XG5cbiAgcHJpdmF0ZSByZXN0b3JlVXNlckRhdGEoKSB7XG4gICAgdGhpcy5tb2RlbC5jb25maWcudXNlck5hbWUgPSB0aGlzLl9zZXJ2ZXIuY29uZmlnLnVzZXJOYW1lO1xuICAgIHRoaXMubW9kZWwuY29uZmlnLnVzZXJJZGVudGl0eU1vZGUgPSAndXNlckFuZFBhc3N3b3JkJztcbiAgfVxuXG4gIHByaXZhdGUgcmVzdG9yZUtleUJhc2VkRGF0YSgpIHtcbiAgICB0aGlzLmF1dGhTd2l0Y2ggPSBmYWxzZTtcbiAgICB0aGlzLm1vZGVsLmNvbmZpZy5rZXlzdG9yZVBhc3MgPSB0aGlzLl9zZXJ2ZXIuY29uZmlnLmtleXN0b3JlUGFzcztcbiAgICB0aGlzLm1vZGVsLmNvbmZpZy5jZXJ0aWZpY2F0ZVBhc3MgPSB0aGlzLl9zZXJ2ZXIuY29uZmlnLmNlcnRpZmljYXRlUGFzcztcbiAgICB0aGlzLm1vZGVsLmNvbmZpZy5rZXlzdG9yZUJpbmFyeUlkID0gdGhpcy5fc2VydmVyLmNvbmZpZy5rZXlzdG9yZUJpbmFyeUlkO1xuICAgIHRoaXMubW9kZWwuY29uZmlnLmtleXN0b3JlRmlsZW5hbWUgPSB0aGlzLl9zZXJ2ZXIuY29uZmlnLmtleXN0b3JlRmlsZW5hbWU7XG4gICAgdGhpcy5tb2RlbC5jb25maWcudXNlcklkZW50aXR5TW9kZSA9ICdjZXJ0aWZpY2F0ZSc7XG4gIH1cblxuICBwcml2YXRlIGdldFNlcnZlckNvbmZpZygpOiBPcGN1YVNlcnZlckNvbmZpZyB7XG4gICAgbGV0IGNmZzogT3BjdWFTZXJ2ZXJDb25maWcgPSB7XG4gICAgICBzZWN1cml0eU1vZGU6IHRoaXMuTk9ORSxcbiAgICAgIHVzZXJJZGVudGl0eU1vZGU6ICdub25lJ1xuICAgIH07XG4gICAgaWYgKHRoaXMuc2VydmVyICYmIHRoaXMuc2VydmVyLmNvbmZpZykge1xuICAgICAgY2ZnID0gdGhpcy5zZXJ2ZXIuY29uZmlnO1xuICAgIH1cbiAgICByZXR1cm4gY2ZnO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRDdXJyZW50U2VjdXJpdHlNb2RlKCkge1xuICAgIGNvbnN0IHsgc2VjdXJpdHlNb2RlIH0gPSB0aGlzLmdldFNlcnZlckNvbmZpZygpO1xuICAgIGlmIChzZWN1cml0eU1vZGUpIHtcbiAgICAgIGNvbnN0IGZvdW5kSW5TaWduID0gdGhpcy5zZWN1cml0eVBvbGljaWVzLnNpZ24uZmluZCgoZWwpID0+IGVsID09PSBzZWN1cml0eU1vZGUpO1xuICAgICAgaWYgKGZvdW5kSW5TaWduKSB7XG4gICAgICAgIHRoaXMuY3VycmVudFNlY01vZGUgPSB0aGlzLlNJR047XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBmb3VuZEluU2lnbkVuY3J5cHQgPSB0aGlzLnNlY3VyaXR5UG9saWNpZXMuc2lnbl9lbmMuZmluZCgoZWwpID0+IGVsID09PSBzZWN1cml0eU1vZGUpO1xuICAgICAgICBmb3VuZEluU2lnbkVuY3J5cHQgPyB0aGlzLmN1cnJlbnRTZWNNb2RlID0gdGhpcy5TSUdOX0VOQyA6IHRoaXMuY3VycmVudFNlY01vZGUgPSB0aGlzLk5PTkU7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRDdXJyZW50QXV0aGVudGljYXRpb25Nb2RlKCkge1xuICAgIGNvbnN0IHtcbiAgICAgIHVzZXJJZGVudGl0eU1vZGVcbiAgICB9ID0gdGhpcy5nZXRTZXJ2ZXJDb25maWcoKTtcblxuICAgIHN3aXRjaCAodXNlcklkZW50aXR5TW9kZSkge1xuICAgICAgY2FzZSAnY2VydGlmaWNhdGUnOlxuICAgICAgICB0aGlzLmF1dGhlbnRpY2F0aW9uTW9kZSA9IHRoaXMuS0VZX0JBU0VEO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAndXNlckFuZFBhc3N3b3JkJzpcbiAgICAgICAgdGhpcy5hdXRoZW50aWNhdGlvbk1vZGUgPSB0aGlzLlVTRVJfUEFTU1dPUkQ7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlICdBbm9ueW1vdXMnOlxuICAgICAgICB0aGlzLmF1dGhlbnRpY2F0aW9uTW9kZSA9IHRoaXMuQU5PTllNO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAnVXNlck5hbWUnOlxuICAgICAgICB0aGlzLmF1dGhlbnRpY2F0aW9uTW9kZSA9IHRoaXMuVVNFUl9QQVNTV09SRDtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgJ0NlcnRpZmljYXRlJzpcbiAgICAgICAgdGhpcy5hdXRoZW50aWNhdGlvbk1vZGUgPSB0aGlzLktFWV9CQVNFRDtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRoaXMuYXV0aGVudGljYXRpb25Nb2RlID0gdGhpcy5BTk9OWU07XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0TW9kZWxDb25maWcoZnJhZ21lbnQ6IHN0cmluZykge1xuICAgIGlmICh0aGlzLm1vZGVsICYmIHRoaXMubW9kZWwuY29uZmlnKSB7XG4gICAgICBpZiAoZnJhZ21lbnQgJiYgZnJhZ21lbnQubGVuZ3RoID4gMCkge1xuICAgICAgICByZXR1cm4gaGFzKHRoaXMubW9kZWwuY29uZmlnLCBmcmFnbWVudCkgPyB0aGlzLm1vZGVsLmNvbmZpZ1tgJHtmcmFnbWVudH1gXSA6IHVuZGVmaW5lZDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxufVxuIl19