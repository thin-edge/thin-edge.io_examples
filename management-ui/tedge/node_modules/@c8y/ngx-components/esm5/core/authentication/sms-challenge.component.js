import * as tslib_1 from "tslib";
import { Component, Output, EventEmitter, Input } from '@angular/core';
import { UserService, ICredentials } from '@c8y/client';
import { LoginService } from '../login/login.service';
import { AlertService } from '../alert/alert.service';
import { gettext } from '../i18n/gettext';
var SmsChallengeComponent = /** @class */ (function () {
    function SmsChallengeComponent(loginService, users, alert) {
        this.loginService = loginService;
        this.users = users;
        this.alert = alert;
        this.onCancel = new EventEmitter();
        this.model = {
            smsToken: ''
        };
        this.isLoading = false;
        this.resendTfa = '0';
    }
    SmsChallengeComponent.prototype.verifyTFACode = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        this.isLoading = true;
                        if (!this.useOAuthInternal()) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.verifyCodeWithOauth()];
                    case 1:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 2: return [4 /*yield*/, this.verifyCodeWithBasicAuth()];
                    case 3:
                        _a.sent();
                        _a.label = 4;
                    case 4:
                        this.isLoading = false;
                        return [2 /*return*/];
                }
            });
        });
    };
    SmsChallengeComponent.prototype.resendTFASms = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var e_1;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, 3, 4]);
                        this.isLoading = true;
                        return [4 /*yield*/, this.users.verifyTFACode(this.resendTfa)];
                    case 1:
                        _a.sent();
                        return [3 /*break*/, 4];
                    case 2:
                        e_1 = _a.sent();
                        if (e_1.res.status === 403) {
                            this.loginService.cleanMessages();
                            this.loginService.addSuccessMessage('resend_sms');
                        }
                        else {
                            this.alert.addServerFailure(e_1);
                        }
                        return [3 /*break*/, 4];
                    case 3:
                        this.isLoading = false;
                        return [7 /*endfinally*/];
                    case 4: return [2 /*return*/];
                }
            });
        });
    };
    SmsChallengeComponent.prototype.useOAuthInternal = function () {
        return this.loginService.isPasswordGrantLogin(this.credentials);
    };
    SmsChallengeComponent.prototype.verifyCodeWithOauth = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var credentials, e_2, resStatus;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 4, , 5]);
                        credentials = this.credentials;
                        return [4 /*yield*/, this.loginService.switchLoginMode(tslib_1.__assign({}, credentials, { tfa: this.model.smsToken }))];
                    case 1:
                        _a.sent();
                        return [4 /*yield*/, this.loginService.verifyAppAccess()];
                    case 2:
                        _a.sent();
                        return [4 /*yield*/, this.loginService.authFulfilled()];
                    case 3:
                        _a.sent();
                        return [3 /*break*/, 5];
                    case 4:
                        e_2 = _a.sent();
                        resStatus = e_2.res && e_2.res.status;
                        if (resStatus === 401) {
                            // it is assumed that the user and password are correct so it must be the tfa code
                            this.alert.danger(gettext('Invalid code'));
                        }
                        else {
                            this.alert.addServerFailure(e_2);
                        }
                        return [3 /*break*/, 5];
                    case 5: return [2 /*return*/];
                }
            });
        });
    };
    SmsChallengeComponent.prototype.verifyCodeWithBasicAuth = function () {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var res, tfaToken, e_3, resStatus;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, this.users.verifyTFACode(this.model.smsToken)];
                    case 1:
                        res = (_a.sent()).res;
                        tfaToken = res.headers.get('tfatoken');
                        this.credentials.tfa = tfaToken;
                        this.loginWithTFA(tfaToken);
                        return [3 /*break*/, 3];
                    case 2:
                        e_3 = _a.sent();
                        resStatus = e_3.res && e_3.res.status;
                        // BE returns 403 in case of invalid tfa code
                        if (resStatus === 403) {
                            this.alert.danger(gettext('Invalid code'));
                        }
                        else {
                            this.alert.addServerFailure(e_3);
                        }
                        return [3 /*break*/, 3];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    SmsChallengeComponent.prototype.loginWithTFA = function (tfaToken) {
        return tslib_1.__awaiter(this, void 0, void 0, function () {
            var e_4;
            return tslib_1.__generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, this.loginService.login(this.loginService.useBasicAuth({ tfa: tfaToken }), this.credentials)];
                    case 1:
                        _a.sent();
                        this.loginService.saveTFAToken(tfaToken, sessionStorage);
                        if (this.loginService.rememberMe) {
                            this.loginService.saveTFAToken(tfaToken, localStorage);
                        }
                        return [3 /*break*/, 3];
                    case 2:
                        e_4 = _a.sent();
                        this.alert.addServerFailure(e_4);
                        return [3 /*break*/, 3];
                    case 3: return [2 /*return*/];
                }
            });
        });
    };
    SmsChallengeComponent.ctorParameters = function () { return [
        { type: LoginService },
        { type: UserService },
        { type: AlertService }
    ]; };
    tslib_1.__decorate([
        Input()
    ], SmsChallengeComponent.prototype, "credentials", void 0);
    tslib_1.__decorate([
        Output()
    ], SmsChallengeComponent.prototype, "onCancel", void 0);
    SmsChallengeComponent = tslib_1.__decorate([
        Component({
            selector: 'c8y-sms-challenge',
            template: "<form #twoFactorForm=\"ngForm\" role=\"form\" class=\"loginForm\" (ngSubmit)=\"verifyTFACode()\" novalidate>\n  <div class=\"legend form-block center\" translate>\n    Two-factor authentication\n  </div>\n\n  <c8y-form-group>\n    <label translate>Verification code</label>\n    <input\n      [(ngModel)]=\"model.smsToken\"\n      #sms_token=\"ngModel\"\n      type=\"text\"\n      name=\"sms_token\"\n      autocapitalize=\"off\"\n      autocorrect=\"off\"\n      class=\"form-control\"\n      placeholder=\"{{ 'e.g.' | translate }} 624327\"\n      required\n    />\n    <p *ngIf=\"!twoFactorForm.form.valid || isLoading \" class=\"help-block\" translate>\n      Insert the code received via SMS.\n    </p>\n  </c8y-form-group>\n\n  <button\n    title=\"{{ 'Verify' | translate }}\"\n    [disabled]=\"!twoFactorForm.form.valid || isLoading\"\n    type=\"submit\"\n    class=\"btn btn-primary btn-lg btn-block form-group\"\n    translate\n  >\n    Verify\n  </button>\n\n  <div class=\"d-flex m-t-8\">\n    <a\n      title=\"{{ 'Send new code' | translate }}\"\n      [ngClass]=\"{ disabled: isLoading }\"\n      class=\"small pointer m-r-auto\"\n      (click)=\"resendTFASms()\"\n      translate\n    >\n      Send new code\n    </a>\n    <a\n      title=\"{{ 'Log in' | translate }}\"\n      class=\"small pointer m-l-auto\"\n      (click)=\"onCancel.emit()\"\n      translate\n    >\n      Log in\n    </a>\n  </div>\n</form>\n"
        })
    ], SmsChallengeComponent);
    return SmsChallengeComponent;
}());
export { SmsChallengeComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic21zLWNoYWxsZW5nZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiY29yZS9hdXRoZW50aWNhdGlvbi9zbXMtY2hhbGxlbmdlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RSxPQUFPLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN4RCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3RELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQVExQztJQVlFLCtCQUNTLFlBQTBCLEVBQ3pCLEtBQWtCLEVBQ2xCLEtBQW1CO1FBRnBCLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQ3pCLFVBQUssR0FBTCxLQUFLLENBQWE7UUFDbEIsVUFBSyxHQUFMLEtBQUssQ0FBYztRQVpuQixhQUFRLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUV4QyxVQUFLLEdBQUc7WUFDTixRQUFRLEVBQUUsRUFBRTtTQUNiLENBQUM7UUFDRixjQUFTLEdBQUcsS0FBSyxDQUFDO1FBRVYsY0FBUyxHQUFXLEdBQUcsQ0FBQztJQU03QixDQUFDO0lBRUUsNkNBQWEsR0FBbkI7Ozs7O3dCQUNFLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDOzZCQUNsQixJQUFJLENBQUMsZ0JBQWdCLEVBQUUsRUFBdkIsd0JBQXVCO3dCQUN6QixxQkFBTSxJQUFJLENBQUMsbUJBQW1CLEVBQUUsRUFBQTs7d0JBQWhDLFNBQWdDLENBQUM7OzRCQUVqQyxxQkFBTSxJQUFJLENBQUMsdUJBQXVCLEVBQUUsRUFBQTs7d0JBQXBD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QUFDLFlBQVksQ0FBQyxFQUFDLEdBQUcsRUFBRSxRQUFRLEVBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBQTs7d0JBQWhHLFNBQWdHLENBQUM7d0JBQ2pHLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxjQUFjLENBQUMsQ0FBQzt3QkFDekQsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRTs0QkFDaEMsSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsUUFBUSxFQUFFLFlBQVksQ0FBQyxDQUFDO3lCQUN4RDs7Ozt3QkFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLEdBQUMsQ0FBQyxDQUFDOzs7Ozs7S0FFbEM7O2dCQS9Fc0IsWUFBWTtnQkFDbEIsV0FBVztnQkFDWCxZQUFZOztJQWJwQjtRQUFSLEtBQUssRUFBRTs4REFBMkI7SUFDekI7UUFBVCxNQUFNLEVBQUU7MkRBQStCO0lBSDdCLHFCQUFxQjtRQU5qQyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsbUJBQW1CO1lBQzdCLGs2Q0FBNkM7U0FFOUMsQ0FBQztPQUVXLHFCQUFxQixDQTZGakM7SUFBRCw0QkFBQztDQUFBLEFBN0ZELElBNkZDO1NBN0ZZLHFCQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT3V0cHV0LCBFdmVudEVtaXR0ZXIsIElucHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBVc2VyU2VydmljZSwgSUNyZWRlbnRpYWxzIH0gZnJvbSAnQGM4eS9jbGllbnQnO1xuaW1wb3J0IHsgTG9naW5TZXJ2aWNlIH0gZnJvbSAnLi4vbG9naW4vbG9naW4uc2VydmljZSc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UgfSBmcm9tICcuLi9hbGVydC9hbGVydC5zZXJ2aWNlJztcbmltcG9ydCB7IGdldHRleHQgfSBmcm9tICcuLi9pMThuL2dldHRleHQnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjOHktc21zLWNoYWxsZW5nZScsXG4gIHRlbXBsYXRlVXJsOiAnLi9zbXMtY2hhbGxlbmdlLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVzOiBbXVxufSlcblxuZXhwb3J0IGNsYXNzIFNtc0NoYWxsZW5nZUNvbXBvbmVudCB7XG5cbiAgQElucHV0KCkgY3JlZGVudGlhbHM6IElDcmVkZW50aWFscztcbiAgQE91dHB1dCgpIG9uQ2FuY2VsID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gIG1vZGVsID0ge1xuICAgIHNtc1Rva2VuOiAnJ1xuICB9O1xuICBpc0xvYWRpbmcgPSBmYWxzZTtcblxuICBwcml2YXRlIHJlc2VuZFRmYTogc3RyaW5nID0gJzAnO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBsb2dpblNlcnZpY2U6IExvZ2luU2VydmljZSxcbiAgICBwcml2YXRlIHVzZXJzOiBVc2VyU2VydmljZSxcbiAgICBwcml2YXRlIGFsZXJ0OiBBbGVydFNlcnZpY2VcbiAgKSB7fVxuXG4gIGFzeW5jIHZlcmlmeVRGQUNvZGUoKSB7XG4gICAgdGhpcy5pc0xvYWRpbmcgPSB0cnVlO1xuICAgIGlmICh0aGlzLnVzZU9BdXRoSW50ZXJuYWwoKSkge1xuICAgICAgYXdhaXQgdGhpcy52ZXJpZnlDb2RlV2l0aE9hdXRoKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMudmVyaWZ5Q29kZVdpdGhCYXNpY0F1dGgoKTtcbiAgICB9XG4gICAgdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTtcbiAgfVxuXG4gIGFzeW5jIHJlc2VuZFRGQVNtcygpIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5pc0xvYWRpbmcgPSB0cnVlO1xuICAgICAgYXdhaXQgdGhpcy51c2Vycy52ZXJpZnlURkFDb2RlKHRoaXMucmVzZW5kVGZhKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoZS5yZXMuc3RhdHVzID09PSA0MDMpIHtcbiAgICAgICAgdGhpcy5sb2dpblNlcnZpY2UuY2xlYW5NZXNzYWdlcygpO1xuICAgICAgICB0aGlzLmxvZ2luU2VydmljZS5hZGRTdWNjZXNzTWVzc2FnZSgncmVzZW5kX3NtcycpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5hbGVydC5hZGRTZXJ2ZXJGYWlsdXJlKGUpO1xuICAgICAgfVxuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLmlzTG9hZGluZyA9IGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdXNlT0F1dGhJbnRlcm5hbCgpIHtcbiAgICByZXR1cm4gdGhpcy5sb2dpblNlcnZpY2UuaXNQYXNzd29yZEdyYW50TG9naW4odGhpcy5jcmVkZW50aWFscyk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHZlcmlmeUNvZGVXaXRoT2F1dGgoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHsgY3JlZGVudGlhbHMgfSA9IHRoaXM7XG4gICAgICBhd2FpdCB0aGlzLmxvZ2luU2VydmljZS5zd2l0Y2hMb2dpbk1vZGUoey4uLmNyZWRlbnRpYWxzLCB0ZmE6IHRoaXMubW9kZWwuc21zVG9rZW59KTtcbiAgICAgIGF3YWl0IHRoaXMubG9naW5TZXJ2aWNlLnZlcmlmeUFwcEFjY2VzcygpO1xuICAgICAgYXdhaXQgdGhpcy5sb2dpblNlcnZpY2UuYXV0aEZ1bGZpbGxlZCgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnN0IHJlc1N0YXR1cyA9IGUucmVzICYmIGUucmVzLnN0YXR1cztcbiAgICAgIGlmIChyZXNTdGF0dXMgPT09IDQwMSkge1xuICAgICAgICAvLyBpdCBpcyBhc3N1bWVkIHRoYXQgdGhlIHVzZXIgYW5kIHBhc3N3b3JkIGFyZSBjb3JyZWN0IHNvIGl0IG11c3QgYmUgdGhlIHRmYSBjb2RlXG4gICAgICAgIHRoaXMuYWxlcnQuZGFuZ2VyKGdldHRleHQoJ0ludmFsaWQgY29kZScpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuYWxlcnQuYWRkU2VydmVyRmFpbHVyZShlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHZlcmlmeUNvZGVXaXRoQmFzaWNBdXRoKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7IHJlcyB9ID0gYXdhaXQgdGhpcy51c2Vycy52ZXJpZnlURkFDb2RlKHRoaXMubW9kZWwuc21zVG9rZW4pO1xuICAgICAgY29uc3QgdGZhVG9rZW4gPSByZXMuaGVhZGVycy5nZXQoJ3RmYXRva2VuJyk7XG4gICAgICB0aGlzLmNyZWRlbnRpYWxzLnRmYSA9IHRmYVRva2VuO1xuICAgICAgdGhpcy5sb2dpbldpdGhURkEodGZhVG9rZW4pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGNvbnN0IHJlc1N0YXR1cyA9IGUucmVzICYmIGUucmVzLnN0YXR1cztcbiAgICAgIC8vIEJFIHJldHVybnMgNDAzIGluIGNhc2Ugb2YgaW52YWxpZCB0ZmEgY29kZVxuICAgICAgaWYgKHJlc1N0YXR1cyA9PT0gNDAzKSB7XG4gICAgICAgIHRoaXMuYWxlcnQuZGFuZ2VyKGdldHRleHQoJ0ludmFsaWQgY29kZScpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuYWxlcnQuYWRkU2VydmVyRmFpbHVyZShlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGxvZ2luV2l0aFRGQSh0ZmFUb2tlbikge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmxvZ2luU2VydmljZS5sb2dpbih0aGlzLmxvZ2luU2VydmljZS51c2VCYXNpY0F1dGgoe3RmYTogdGZhVG9rZW59KSwgdGhpcy5jcmVkZW50aWFscyk7XG4gICAgICB0aGlzLmxvZ2luU2VydmljZS5zYXZlVEZBVG9rZW4odGZhVG9rZW4sIHNlc3Npb25TdG9yYWdlKTtcbiAgICAgIGlmICh0aGlzLmxvZ2luU2VydmljZS5yZW1lbWJlck1lKSB7XG4gICAgICAgIHRoaXMubG9naW5TZXJ2aWNlLnNhdmVURkFUb2tlbih0ZmFUb2tlbiwgbG9jYWxTdG9yYWdlKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aGlzLmFsZXJ0LmFkZFNlcnZlckZhaWx1cmUoZSk7XG4gICAgfVxuICB9XG59XG4iXX0=