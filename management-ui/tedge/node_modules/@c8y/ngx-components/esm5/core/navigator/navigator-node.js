import * as tslib_1 from "tslib";
import { matches, snakeCase } from 'lodash-es';
/**
 * Base navigator node. Represents a single entry in the navigator menu.
 * Is considered to be the basic building block of the navigator.
 */
var NavigatorNode = /** @class */ (function () {
    /**
     * @ignore
     */
    function NavigatorNode(data) {
        /**
         * Navigator node children (subentries).
         */
        this.children = [];
        /**
         * Navigator node parent nodes.
         */
        this.parents = [];
        /**
         * Indicates whether the navigator node should be active based on matching the node path and the URL path.
         * To match the URL exactly, set this option to true.
         *
         * routerLinkExact set to true:
         * When the URL path is set to /a/b/c and the node path to /a/b then the node will not be set active.
         *
         * routerLinkExact set to false:
         * When the URL path is set to /a/b/c and the node path to /a/b then the node will be set active.
         */
        this.routerLinkExact = true;
        /**
         * Indicates that the navigator node is expanded/collapsed.
         */
        this.open = false;
        /**
         * Indicates that the navigator node is visible/hidden.
         */
        this.hidden = false;
        /**
         * Indicates that the navigator node is draggable.
         */
        this.draggable = false;
        /**
         * Indicates that the navigator node is droppable.
         */
        this.droppable = false;
        /**
         * Indicates that the navigator node is dragged.
         */
        this.dragged = false;
        /**
         * Indicates that currently something is dragged over the node.
         */
        this.draggedHover = false;
        /**
         * Confirmation popover displayed at the end of the process of moving the navigator menu item.
         */
        this.confirm = undefined;
        this._priority = 0;
        this.update(data);
    }
    Object.defineProperty(NavigatorNode.prototype, "hasChildren", {
        /**
         * Returns information whether a navigator node has children.
         * @readonly
         */
        get: function () {
            return this.children.length > 0;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NavigatorNode.prototype, "id", {
        /**
         * Returns the ID of the navigator node.
         * @readonly
         */
        get: function () {
            return 'navigator_node_' + snakeCase(this.label);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NavigatorNode.prototype, "priority", {
        /**
         * Returns the priority value of the navigator node.
         * @readonly
         */
        get: function () {
            if (this._priority) {
                return this._priority;
            }
            else {
                var childrenPriorities = this.children.map(function (_a) {
                    var priority = _a.priority;
                    return priority || 0;
                });
                if (childrenPriorities.length) {
                    return childrenPriorities.length ? Math.max.apply(Math, tslib_1.__spread(childrenPriorities)) : 0;
                }
                return 0;
            }
        },
        /**
         * Sets the priority value of the navigator node.
         *
         * @param {number} priority Priority value.
         */
        set: function (priority) {
            this._priority = priority;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @ignore
     */
    NavigatorNode.prototype.openOnStart = function (url) {
        return false;
    };
    /**
     * Adds a child navigator node to the node.
     *
     * @param {NavigatorNode} node Child node.
     */
    NavigatorNode.prototype.add = function (node) {
        if (node === this) {
            throw new Error('Adding node to itself');
        }
        if (this.children.indexOf(node) === -1) {
            this.children.push(node);
        }
        if (node.parents.indexOf(this) === -1) {
            node.parents.push(this);
        }
        this.updateChildren();
    };
    /**
     * Removes the child navigator node from the node.
     *
     * @param {NavigatorNode} node Child node.
     */
    NavigatorNode.prototype.remove = function (node) {
        var ix = this.children.indexOf(node);
        var pix = node.parents.indexOf(this);
        if (ix > -1) {
            this.children.splice(ix, 1);
        }
        if (pix > -1) {
            node.parents.splice(pix, 1);
        }
        this.updateChildren();
    };
    /**
     * Updates the navigator node.
     *
     * @param {NavigatorNodeData} data Data to be upated.
     */
    NavigatorNode.prototype.update = function (data) {
        if (data) {
            Object.assign(this, data);
            if (data.hidden !== undefined) {
                this.parents.forEach(function (p) {
                    p.updateHidden();
                });
            }
        }
    };
    /**
     * Returns a child navigator node based on the predicate.
     *
     * @param {string|object} predicate Filter criteria.
     *
     * @example
     * ```ts
     * // The function will compare the labels to the string and return a matching result.
     * // The capitalization of the characters does not matter (case insensitive).
     * const predicate = 'group1';
     * const childNode = parentNode.find(predicate);
     *
     * // Check: [lodash matches](https://lodash.com/docs/4.17.15#matches)
     * const predicate = { label: 'group2' };
     * const childNode = parentNode.find(predicate);
     * ```
     */
    NavigatorNode.prototype.find = function (predicate) {
        if (typeof predicate === 'string') {
            var compareLabel_1 = predicate.toLocaleLowerCase();
            predicate = function (_a) {
                var label = _a.label;
                return compareLabel_1 === label.toLowerCase();
            };
        }
        if (typeof predicate === 'object') {
            predicate = matches(predicate);
        }
        if (typeof predicate !== 'function') {
            throw new Error('Invalid search predicate');
        }
        return this.children.reduce(function (found, child) { return found || child.find(predicate); }, this.children.find(predicate));
    };
    /**
     * Removes children nodes.
     */
    NavigatorNode.prototype.empty = function () {
        this.children.length = 0;
    };
    /**
     * @ignore
     */
    NavigatorNode.prototype.click = function (options) {
        if (options === void 0) { options = {}; }
        // do nothing
    };
    /**
     * This event is fired when an element is dropped on a valid drop target.
     * @param $event DOM event.
     */
    NavigatorNode.prototype.drop = function ($event) {
        $event.stopPropagation();
        clearTimeout(this.expandDragTimeout);
    };
    /**
     * This event is fired when the user starts dragging an element.
     * @param $event DOM event.
     */
    NavigatorNode.prototype.dragStart = function ($event) {
        $event.stopPropagation();
        // we can't pass a object to setData, so we do it via service
        // set data is still needed, to make the drag&drop work
        $event.dataTransfer.setData('node', 'node');
        this.dragged = true;
    };
    /**
     * This event is fired when a drag operation has ended.
     * @param $event DOM event.
     */
    NavigatorNode.prototype.dragEnd = function ($event) {
        $event.stopPropagation();
        this.dragged = false;
        $event.dataTransfer.clearData();
    };
    Object.defineProperty(NavigatorNode.prototype, "canDrop", {
        /**
         * Returns information whether the navigator node is droppable.
         * @readonly
         */
        get: function () {
            return this.droppable;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NavigatorNode.prototype, "canNavigate", {
        /**
         * Returns information whether navigation is possible.
         * @readonly
         */
        get: function () {
            return typeof this.path !== 'undefined';
        },
        enumerable: true,
        configurable: true
    });
    /**
     * This event is fired when a dragged element enters a valid drop target.
     * @param $event DOM event.
     */
    NavigatorNode.prototype.dragEnter = function ($event) {
        var _this = this;
        $event.preventDefault();
        $event.stopPropagation();
        this.draggedHover = true;
        if (!this.open) {
            this.expandDragTimeout = setTimeout(function () { return _this.expand(); }, 1000);
        }
    };
    /**
     * This event is fired when a dragged element leaves a valid drop target.
     * @param $event DOM event.
     */
    NavigatorNode.prototype.dragLeave = function ($event) {
        $event.preventDefault();
        $event.stopPropagation();
        this.draggedHover = false;
        clearTimeout(this.expandDragTimeout);
    };
    /**
     * Expands the navigator node if it is collapsed.
     */
    NavigatorNode.prototype.expand = function () {
        if (!this.open) {
            this.open = true;
            this.click({ open: true, expander: true });
        }
    };
    /**
     * Performs a callback function recursively on each of the navigator node's children down the hierarchy.
     * @param {function} callback Function to be called.
     *
     * @example
     * ```ts
     * const expandChild = (childNode) => childNode.expand();
     * parentNode.traverse(expandChild);
     * ```
     */
    NavigatorNode.prototype.traverse = function (callback) {
        if (this.children) {
            this.children.forEach(function (child) {
                callback(child);
                child.traverse(callback);
            });
        }
    };
    /**
     * @ignore
     */
    NavigatorNode.prototype.destroy = function () {
        // nothing todo here
    };
    /**
     * Updates the navigator node by sorting its children and also checking their visibility.
     */
    NavigatorNode.prototype.updateChildren = function () {
        this.sort();
        this.updateHidden();
    };
    /**
     * Sorts the children of the navigator node, by priority and name (ASC).
     * The higher the priority, the higher the position in the hierarchy.
     * For the same priority values, the alphabetical order will take precedence.
     */
    NavigatorNode.prototype.sort = function () {
        this.children.sort(function (a, b) {
            if (a.priority > b.priority) {
                return -1;
            }
            else if (a.priority < b.priority) {
                return 1;
            }
            else if ((a.label || '').toLowerCase() < (b.label || '').toLowerCase()) {
                return -1;
            }
            else if ((a.label || '').toLowerCase() > (b.label || '').toLowerCase()) {
                return 1;
            }
            else {
                return 0;
            }
        });
    };
    /**
     * Checks if the navigator node should be hidden based on the visibility of its child nodes.
     */
    NavigatorNode.prototype.updateHidden = function () {
        if (typeof this.path === 'undefined') {
            this.hidden = !this.children.some(function (_a) {
                var hidden = _a.hidden;
                return !hidden;
            });
        }
    };
    return NavigatorNode;
}());
export { NavigatorNode };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2aWdhdG9yLW5vZGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsiY29yZS9uYXZpZ2F0b3IvbmF2aWdhdG9yLW5vZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBeUIvQzs7O0dBR0c7QUFDSDtJQW1JRTs7T0FFRztJQUNILHVCQUFZLElBQXdCO1FBdEhwQzs7V0FFRztRQUNILGFBQVEsR0FBb0IsRUFBRSxDQUFDO1FBWS9COztXQUVHO1FBQ0gsWUFBTyxHQUFvQixFQUFFLENBQUM7UUFPOUI7Ozs7Ozs7OztXQVNHO1FBQ0gsb0JBQWUsR0FBWSxJQUFJLENBQUM7UUFFaEM7O1dBRUc7UUFDSCxTQUFJLEdBQVksS0FBSyxDQUFDO1FBRXRCOztXQUVHO1FBQ0gsV0FBTSxHQUFZLEtBQUssQ0FBQztRQUV4Qjs7V0FFRztRQUNILGNBQVMsR0FBWSxLQUFLLENBQUM7UUFFM0I7O1dBRUc7UUFDSCxjQUFTLEdBQVksS0FBSyxDQUFDO1FBRTNCOztXQUVHO1FBQ0gsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUVoQjs7V0FFRztRQUNILGlCQUFZLEdBQUcsS0FBSyxDQUFDO1FBRXJCOztXQUVHO1FBQ0gsWUFBTyxHQUE0QixTQUFTLENBQUM7UUFDckMsY0FBUyxHQUFXLENBQUMsQ0FBQztRQWdENUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNwQixDQUFDO0lBMUNELHNCQUFJLHNDQUFXO1FBSmY7OztXQUdHO2FBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUNsQyxDQUFDOzs7T0FBQTtJQU1ELHNCQUFJLDZCQUFFO1FBSk47OztXQUdHO2FBQ0g7WUFDRSxPQUFPLGlCQUFpQixHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbkQsQ0FBQzs7O09BQUE7SUFNRCxzQkFBSSxtQ0FBUTtRQUpaOzs7V0FHRzthQUNIO1lBQ0UsSUFBSSxJQUFJLENBQUMsU0FBUyxFQUFFO2dCQUNsQixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUM7YUFDdkI7aUJBQU07Z0JBQ0wsSUFBTSxrQkFBa0IsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFDLEVBQVk7d0JBQVYsc0JBQVE7b0JBQU8sT0FBQSxRQUFRLElBQUksQ0FBQztnQkFBYixDQUFhLENBQUMsQ0FBQztnQkFDOUUsSUFBSSxrQkFBa0IsQ0FBQyxNQUFNLEVBQUU7b0JBQzdCLE9BQU8sa0JBQWtCLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxPQUFSLElBQUksbUJBQVEsa0JBQWtCLEdBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDeEU7Z0JBQ0QsT0FBTyxDQUFDLENBQUM7YUFDVjtRQUNILENBQUM7UUFFRDs7OztXQUlHO2FBQ0gsVUFBYSxRQUFRO1lBQ25CLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO1FBQzVCLENBQUM7OztPQVRBO0lBa0JEOztPQUVHO0lBQ0gsbUNBQVcsR0FBWCxVQUFZLEdBQVc7UUFDckIsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILDJCQUFHLEdBQUgsVUFBSSxJQUFtQjtRQUNyQixJQUFJLElBQUksS0FBSyxJQUFJLEVBQUU7WUFDakIsTUFBTSxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1NBQzFDO1FBQ0QsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtZQUN0QyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUMxQjtRQUNELElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7WUFDckMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDekI7UUFDRCxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDeEIsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCw4QkFBTSxHQUFOLFVBQU8sSUFBbUI7UUFDeEIsSUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkMsSUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEVBQUU7WUFDWCxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7U0FDN0I7UUFDRCxJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUMsRUFBRTtZQUNaLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUM3QjtRQUNELElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILDhCQUFNLEdBQU4sVUFBTyxJQUF3QjtRQUM3QixJQUFJLElBQUksRUFBRTtZQUNSLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzFCLElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7Z0JBQzdCLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQUEsQ0FBQztvQkFDcEIsQ0FBQyxDQUFDLFlBQVksRUFBRSxDQUFDO2dCQUNuQixDQUFDLENBQUMsQ0FBQzthQUNKO1NBQ0Y7SUFDSCxDQUFDO0lBRUQ7Ozs7Ozs7Ozs7Ozs7Ozs7T0FnQkc7SUFDSCw0QkFBSSxHQUFKLFVBQUssU0FBUztRQUNaLElBQUksT0FBTyxTQUFTLEtBQUssUUFBUSxFQUFFO1lBQ2pDLElBQU0sY0FBWSxHQUFHLFNBQVMsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1lBQ25ELFNBQVMsR0FBRyxVQUFDLEVBQVM7b0JBQVAsZ0JBQUs7Z0JBQU8sT0FBQSxjQUFZLEtBQUssS0FBSyxDQUFDLFdBQVcsRUFBRTtZQUFwQyxDQUFvQyxDQUFDO1NBQ2pFO1FBQ0QsSUFBSSxPQUFPLFNBQVMsS0FBSyxRQUFRLEVBQUU7WUFDakMsU0FBUyxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNoQztRQUNELElBQUksT0FBTyxTQUFTLEtBQUssVUFBVSxFQUFFO1lBQ25DLE1BQU0sSUFBSSxLQUFLLENBQUMsMEJBQTBCLENBQUMsQ0FBQztTQUM3QztRQUNELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQ3pCLFVBQUMsS0FBSyxFQUFFLEtBQUssSUFBSyxPQUFBLEtBQUssSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUE5QixDQUE4QixFQUNoRCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FDOUIsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNILDZCQUFLLEdBQUw7UUFDRSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7SUFDM0IsQ0FBQztJQUVEOztPQUVHO0lBQ0gsNkJBQUssR0FBTCxVQUFNLE9BQTBCO1FBQTFCLHdCQUFBLEVBQUEsWUFBMEI7UUFDOUIsYUFBYTtJQUNmLENBQUM7SUFFRDs7O09BR0c7SUFDSCw0QkFBSSxHQUFKLFVBQUssTUFBTTtRQUNULE1BQU0sQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUN6QixZQUFZLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVEOzs7T0FHRztJQUNILGlDQUFTLEdBQVQsVUFBVSxNQUFNO1FBQ2QsTUFBTSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3pCLDZEQUE2RDtRQUM3RCx1REFBdUQ7UUFDdkQsTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO0lBQ3RCLENBQUM7SUFFRDs7O09BR0c7SUFDSCwrQkFBTyxHQUFQLFVBQVEsTUFBTTtRQUNaLE1BQU0sQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUNyQixNQUFNLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ2xDLENBQUM7SUFNRCxzQkFBSSxrQ0FBTztRQUpYOzs7V0FHRzthQUNIO1lBQ0UsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ3hCLENBQUM7OztPQUFBO0lBTUQsc0JBQUksc0NBQVc7UUFKZjs7O1dBR0c7YUFDSDtZQUNFLE9BQU8sT0FBTyxJQUFJLENBQUMsSUFBSSxLQUFLLFdBQVcsQ0FBQztRQUMxQyxDQUFDOzs7T0FBQTtJQUVEOzs7T0FHRztJQUNILGlDQUFTLEdBQVQsVUFBVSxNQUFNO1FBQWhCLGlCQU9DO1FBTkMsTUFBTSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3hCLE1BQU0sQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztRQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNkLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxVQUFVLENBQUMsY0FBTSxPQUFBLEtBQUksQ0FBQyxNQUFNLEVBQUUsRUFBYixDQUFhLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDaEU7SUFDSCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsaUNBQVMsR0FBVCxVQUFVLE1BQU07UUFDZCxNQUFNLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDeEIsTUFBTSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDO1FBQzFCLFlBQVksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCw4QkFBTSxHQUFOO1FBQ0UsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDZCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztZQUNqQixJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztTQUM1QztJQUNILENBQUM7SUFFRDs7Ozs7Ozs7O09BU0c7SUFDSCxnQ0FBUSxHQUFSLFVBQVMsUUFBUTtRQUNmLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNqQixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxVQUFBLEtBQUs7Z0JBQ3pCLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDaEIsS0FBSyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUMzQixDQUFDLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsK0JBQU8sR0FBUDtRQUNFLG9CQUFvQjtJQUN0QixDQUFDO0lBRUQ7O09BRUc7SUFDTyxzQ0FBYyxHQUF4QjtRQUNFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNaLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztJQUN0QixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNPLDRCQUFJLEdBQWQ7UUFDRSxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFDLENBQUMsRUFBRSxDQUFDO1lBQ3RCLElBQUksQ0FBQyxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUMsUUFBUSxFQUFFO2dCQUMzQixPQUFPLENBQUMsQ0FBQyxDQUFDO2FBQ1g7aUJBQU0sSUFBSSxDQUFDLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUU7Z0JBQ2xDLE9BQU8sQ0FBQyxDQUFDO2FBQ1Y7aUJBQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFO2dCQUN4RSxPQUFPLENBQUMsQ0FBQyxDQUFDO2FBQ1g7aUJBQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFO2dCQUN4RSxPQUFPLENBQUMsQ0FBQzthQUNWO2lCQUFNO2dCQUNMLE9BQU8sQ0FBQyxDQUFDO2FBQ1Y7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNPLG9DQUFZLEdBQXRCO1FBQ0UsSUFBSSxPQUFPLElBQUksQ0FBQyxJQUFJLEtBQUssV0FBVyxFQUFFO1lBQ3BDLElBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFDLEVBQVU7b0JBQVIsa0JBQU07Z0JBQU8sT0FBQSxDQUFDLE1BQU07WUFBUCxDQUFPLENBQUMsQ0FBQztTQUM1RDtJQUNILENBQUM7SUFDSCxvQkFBQztBQUFELENBQUMsQUFwWUQsSUFvWUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZW1wbGF0ZVJlZiwgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgbWF0Y2hlcywgc25ha2VDYXNlIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IE5hdmlnYXRvck5vZGVEYXRhIH0gZnJvbSAnLi9uYXZpZ2F0b3Itbm9kZS1kYXRhJztcbmltcG9ydCB7IFBvcG92ZXJDb25maXJtQ29tcG9uZW50IH0gZnJvbSAnLi4vbW9kYWwvcG9wb3Zlci1jb25maXJtLmNvbXBvbmVudCc7XG5cbi8qKlxuICogSW50ZXJmYWNlIHRoYXQgZGV0ZXJtaW5lcyB0aGUgYXZhaWxhYmxlIGNsaWNrIG9wdGlvbnMuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ2xpY2tPcHRpb25zIHtcbiAgLyoqXG4gICAqIEluZGljYXRlcyB0aGF0IHRoZSBzb3VyY2Ugb2YgdGhlIGV2ZW50IGlzIGEgY2xpY2sgb24gdGhlIG5vZGUgaWNvbi5cbiAgICovXG4gIGljb24/OiBib29sZWFuO1xuICAvKipcbiAgICogSW5kaWNhdGVzIHRoYXQgdGhlIHNvdXJjZSBvZiB0aGUgZXZlbnQgaXMgYSBjbGljayBvbiB0aGUgbm9kZSBleHBhbmRlci5cbiAgICovXG4gIGV4cGFuZGVyPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIEluZGljYXRlcyB0aGF0IHRoZSBuYXZpZ2F0b3Igbm9kZSBpcyBleHBhbmRlZC9jb2xsYXBzZWQuXG4gICAqL1xuICBvcGVuPzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIERPTSBldmVudC5cbiAgICovXG4gICRldmVudD86IGFueTsgLy8gVE9ETzogYWRkIHByb3BlciB0eXBlXG59XG4vKipcbiAqIEJhc2UgbmF2aWdhdG9yIG5vZGUuIFJlcHJlc2VudHMgYSBzaW5nbGUgZW50cnkgaW4gdGhlIG5hdmlnYXRvciBtZW51LlxuICogSXMgY29uc2lkZXJlZCB0byBiZSB0aGUgYmFzaWMgYnVpbGRpbmcgYmxvY2sgb2YgdGhlIG5hdmlnYXRvci5cbiAqL1xuZXhwb3J0IGNsYXNzIE5hdmlnYXRvck5vZGUge1xuICAvKipcbiAgICogTmF2aWdhdG9yIG5vZGUgaWNvbi5cbiAgICovXG4gIGljb246IHN0cmluZztcblxuICAvKipcbiAgICogQ3VzdG9tIGljb24gdGVtcGxhdGUuXG4gICAqL1xuICBpY29uVGVtcGxhdGU/OiBUZW1wbGF0ZVJlZjxhbnk+O1xuXG4gIC8qKlxuICAgKiBDdXN0b20gaWNvbiBjb21wb25lbnQuXG4gICAqL1xuICBpY29uQ29tcG9uZW50PzogVHlwZTxhbnk+O1xuXG4gIC8qKlxuICAgKiBOYXZpZ2F0b3Igbm9kZSBjaGlsZHJlbiAoc3ViZW50cmllcykuXG4gICAqL1xuICBjaGlsZHJlbjogTmF2aWdhdG9yTm9kZVtdID0gW107XG5cbiAgLyoqXG4gICAqIExhYmVsIHRvIGJlIGRpc3BsYXllZCBpbiB0aGUgbmF2aWdhdG9yIG5vZGUuXG4gICAqL1xuICBsYWJlbDtcblxuICAvKipcbiAgICogVGhlIHBhdGggdG8gd2hpY2ggdGhlIFVJIHdpbGwgYmUgcmVkaXJlY3RlZCBhZnRlciBjbGlja2luZyB0aGUgbmF2aWdhdG9yIG5vZGUuXG4gICAqL1xuICBwYXRoOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIE5hdmlnYXRvciBub2RlIHBhcmVudCBub2Rlcy5cbiAgICovXG4gIHBhcmVudHM6IE5hdmlnYXRvck5vZGVbXSA9IFtdO1xuXG4gIC8qKlxuICAgKiBMb2FkaW5nIHN0YXRlIGluZGljYXRvci5cbiAgICovXG4gIGxvYWRpbmc/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBJbmRpY2F0ZXMgd2hldGhlciB0aGUgbmF2aWdhdG9yIG5vZGUgc2hvdWxkIGJlIGFjdGl2ZSBiYXNlZCBvbiBtYXRjaGluZyB0aGUgbm9kZSBwYXRoIGFuZCB0aGUgVVJMIHBhdGguXG4gICAqIFRvIG1hdGNoIHRoZSBVUkwgZXhhY3RseSwgc2V0IHRoaXMgb3B0aW9uIHRvIHRydWUuXG4gICAqXG4gICAqIHJvdXRlckxpbmtFeGFjdCBzZXQgdG8gdHJ1ZTpcbiAgICogV2hlbiB0aGUgVVJMIHBhdGggaXMgc2V0IHRvIC9hL2IvYyBhbmQgdGhlIG5vZGUgcGF0aCB0byAvYS9iIHRoZW4gdGhlIG5vZGUgd2lsbCBub3QgYmUgc2V0IGFjdGl2ZS5cbiAgICpcbiAgICogcm91dGVyTGlua0V4YWN0IHNldCB0byBmYWxzZTpcbiAgICogV2hlbiB0aGUgVVJMIHBhdGggaXMgc2V0IHRvIC9hL2IvYyBhbmQgdGhlIG5vZGUgcGF0aCB0byAvYS9iIHRoZW4gdGhlIG5vZGUgd2lsbCBiZSBzZXQgYWN0aXZlLlxuICAgKi9cbiAgcm91dGVyTGlua0V4YWN0OiBib29sZWFuID0gdHJ1ZTtcblxuICAvKipcbiAgICogSW5kaWNhdGVzIHRoYXQgdGhlIG5hdmlnYXRvciBub2RlIGlzIGV4cGFuZGVkL2NvbGxhcHNlZC5cbiAgICovXG4gIG9wZW46IGJvb2xlYW4gPSBmYWxzZTtcblxuICAvKipcbiAgICogSW5kaWNhdGVzIHRoYXQgdGhlIG5hdmlnYXRvciBub2RlIGlzIHZpc2libGUvaGlkZGVuLlxuICAgKi9cbiAgaGlkZGVuOiBib29sZWFuID0gZmFsc2U7XG5cbiAgLyoqXG4gICAqIEluZGljYXRlcyB0aGF0IHRoZSBuYXZpZ2F0b3Igbm9kZSBpcyBkcmFnZ2FibGUuXG4gICAqL1xuICBkcmFnZ2FibGU6IGJvb2xlYW4gPSBmYWxzZTtcblxuICAvKipcbiAgICogSW5kaWNhdGVzIHRoYXQgdGhlIG5hdmlnYXRvciBub2RlIGlzIGRyb3BwYWJsZS5cbiAgICovXG4gIGRyb3BwYWJsZTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIC8qKlxuICAgKiBJbmRpY2F0ZXMgdGhhdCB0aGUgbmF2aWdhdG9yIG5vZGUgaXMgZHJhZ2dlZC5cbiAgICovXG4gIGRyYWdnZWQgPSBmYWxzZTtcblxuICAvKipcbiAgICogSW5kaWNhdGVzIHRoYXQgY3VycmVudGx5IHNvbWV0aGluZyBpcyBkcmFnZ2VkIG92ZXIgdGhlIG5vZGUuXG4gICAqL1xuICBkcmFnZ2VkSG92ZXIgPSBmYWxzZTtcblxuICAvKipcbiAgICogQ29uZmlybWF0aW9uIHBvcG92ZXIgZGlzcGxheWVkIGF0IHRoZSBlbmQgb2YgdGhlIHByb2Nlc3Mgb2YgbW92aW5nIHRoZSBuYXZpZ2F0b3IgbWVudSBpdGVtLlxuICAgKi9cbiAgY29uZmlybTogUG9wb3ZlckNvbmZpcm1Db21wb25lbnQgPSB1bmRlZmluZWQ7XG4gIHByaXZhdGUgX3ByaW9yaXR5OiBudW1iZXIgPSAwO1xuICBwcml2YXRlIGV4cGFuZERyYWdUaW1lb3V0O1xuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGluZm9ybWF0aW9uIHdoZXRoZXIgYSBuYXZpZ2F0b3Igbm9kZSBoYXMgY2hpbGRyZW4uXG4gICAqIEByZWFkb25seVxuICAgKi9cbiAgZ2V0IGhhc0NoaWxkcmVuKCkge1xuICAgIHJldHVybiB0aGlzLmNoaWxkcmVuLmxlbmd0aCA+IDA7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgSUQgb2YgdGhlIG5hdmlnYXRvciBub2RlLlxuICAgKiBAcmVhZG9ubHlcbiAgICovXG4gIGdldCBpZCgpIHtcbiAgICByZXR1cm4gJ25hdmlnYXRvcl9ub2RlXycgKyBzbmFrZUNhc2UodGhpcy5sYWJlbCk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgcHJpb3JpdHkgdmFsdWUgb2YgdGhlIG5hdmlnYXRvciBub2RlLlxuICAgKiBAcmVhZG9ubHlcbiAgICovXG4gIGdldCBwcmlvcml0eSgpIHtcbiAgICBpZiAodGhpcy5fcHJpb3JpdHkpIHtcbiAgICAgIHJldHVybiB0aGlzLl9wcmlvcml0eTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgY2hpbGRyZW5Qcmlvcml0aWVzID0gdGhpcy5jaGlsZHJlbi5tYXAoKHsgcHJpb3JpdHkgfSkgPT4gcHJpb3JpdHkgfHwgMCk7XG4gICAgICBpZiAoY2hpbGRyZW5Qcmlvcml0aWVzLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gY2hpbGRyZW5Qcmlvcml0aWVzLmxlbmd0aCA/IE1hdGgubWF4KC4uLmNoaWxkcmVuUHJpb3JpdGllcykgOiAwO1xuICAgICAgfVxuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgdGhlIHByaW9yaXR5IHZhbHVlIG9mIHRoZSBuYXZpZ2F0b3Igbm9kZS5cbiAgICpcbiAgICogQHBhcmFtIHtudW1iZXJ9IHByaW9yaXR5IFByaW9yaXR5IHZhbHVlLlxuICAgKi9cbiAgc2V0IHByaW9yaXR5KHByaW9yaXR5KSB7XG4gICAgdGhpcy5fcHJpb3JpdHkgPSBwcmlvcml0eTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBjb25zdHJ1Y3RvcihkYXRhPzogTmF2aWdhdG9yTm9kZURhdGEpIHtcbiAgICB0aGlzLnVwZGF0ZShkYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBvcGVuT25TdGFydCh1cmw6IHN0cmluZykge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGRzIGEgY2hpbGQgbmF2aWdhdG9yIG5vZGUgdG8gdGhlIG5vZGUuXG4gICAqXG4gICAqIEBwYXJhbSB7TmF2aWdhdG9yTm9kZX0gbm9kZSBDaGlsZCBub2RlLlxuICAgKi9cbiAgYWRkKG5vZGU6IE5hdmlnYXRvck5vZGUpIHtcbiAgICBpZiAobm9kZSA9PT0gdGhpcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdBZGRpbmcgbm9kZSB0byBpdHNlbGYnKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuY2hpbGRyZW4uaW5kZXhPZihub2RlKSA9PT0gLTEpIHtcbiAgICAgIHRoaXMuY2hpbGRyZW4ucHVzaChub2RlKTtcbiAgICB9XG4gICAgaWYgKG5vZGUucGFyZW50cy5pbmRleE9mKHRoaXMpID09PSAtMSkge1xuICAgICAgbm9kZS5wYXJlbnRzLnB1c2godGhpcyk7XG4gICAgfVxuICAgIHRoaXMudXBkYXRlQ2hpbGRyZW4oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIHRoZSBjaGlsZCBuYXZpZ2F0b3Igbm9kZSBmcm9tIHRoZSBub2RlLlxuICAgKlxuICAgKiBAcGFyYW0ge05hdmlnYXRvck5vZGV9IG5vZGUgQ2hpbGQgbm9kZS5cbiAgICovXG4gIHJlbW92ZShub2RlOiBOYXZpZ2F0b3JOb2RlKSB7XG4gICAgY29uc3QgaXggPSB0aGlzLmNoaWxkcmVuLmluZGV4T2Yobm9kZSk7XG4gICAgY29uc3QgcGl4ID0gbm9kZS5wYXJlbnRzLmluZGV4T2YodGhpcyk7XG4gICAgaWYgKGl4ID4gLTEpIHtcbiAgICAgIHRoaXMuY2hpbGRyZW4uc3BsaWNlKGl4LCAxKTtcbiAgICB9XG4gICAgaWYgKHBpeCA+IC0xKSB7XG4gICAgICBub2RlLnBhcmVudHMuc3BsaWNlKHBpeCwgMSk7XG4gICAgfVxuICAgIHRoaXMudXBkYXRlQ2hpbGRyZW4oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGVzIHRoZSBuYXZpZ2F0b3Igbm9kZS5cbiAgICpcbiAgICogQHBhcmFtIHtOYXZpZ2F0b3JOb2RlRGF0YX0gZGF0YSBEYXRhIHRvIGJlIHVwYXRlZC5cbiAgICovXG4gIHVwZGF0ZShkYXRhPzogTmF2aWdhdG9yTm9kZURhdGEpIHtcbiAgICBpZiAoZGF0YSkge1xuICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLCBkYXRhKTtcbiAgICAgIGlmIChkYXRhLmhpZGRlbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMucGFyZW50cy5mb3JFYWNoKHAgPT4ge1xuICAgICAgICAgIHAudXBkYXRlSGlkZGVuKCk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGEgY2hpbGQgbmF2aWdhdG9yIG5vZGUgYmFzZWQgb24gdGhlIHByZWRpY2F0ZS5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd8b2JqZWN0fSBwcmVkaWNhdGUgRmlsdGVyIGNyaXRlcmlhLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGB0c1xuICAgKiAvLyBUaGUgZnVuY3Rpb24gd2lsbCBjb21wYXJlIHRoZSBsYWJlbHMgdG8gdGhlIHN0cmluZyBhbmQgcmV0dXJuIGEgbWF0Y2hpbmcgcmVzdWx0LlxuICAgKiAvLyBUaGUgY2FwaXRhbGl6YXRpb24gb2YgdGhlIGNoYXJhY3RlcnMgZG9lcyBub3QgbWF0dGVyIChjYXNlIGluc2Vuc2l0aXZlKS5cbiAgICogY29uc3QgcHJlZGljYXRlID0gJ2dyb3VwMSc7XG4gICAqIGNvbnN0IGNoaWxkTm9kZSA9IHBhcmVudE5vZGUuZmluZChwcmVkaWNhdGUpO1xuICAgKlxuICAgKiAvLyBDaGVjazogW2xvZGFzaCBtYXRjaGVzXShodHRwczovL2xvZGFzaC5jb20vZG9jcy80LjE3LjE1I21hdGNoZXMpXG4gICAqIGNvbnN0IHByZWRpY2F0ZSA9IHsgbGFiZWw6ICdncm91cDInIH07XG4gICAqIGNvbnN0IGNoaWxkTm9kZSA9IHBhcmVudE5vZGUuZmluZChwcmVkaWNhdGUpO1xuICAgKiBgYGBcbiAgICovXG4gIGZpbmQocHJlZGljYXRlKSB7XG4gICAgaWYgKHR5cGVvZiBwcmVkaWNhdGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICBjb25zdCBjb21wYXJlTGFiZWwgPSBwcmVkaWNhdGUudG9Mb2NhbGVMb3dlckNhc2UoKTtcbiAgICAgIHByZWRpY2F0ZSA9ICh7IGxhYmVsIH0pID0+IGNvbXBhcmVMYWJlbCA9PT0gbGFiZWwudG9Mb3dlckNhc2UoKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBwcmVkaWNhdGUgPT09ICdvYmplY3QnKSB7XG4gICAgICBwcmVkaWNhdGUgPSBtYXRjaGVzKHByZWRpY2F0ZSk7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgcHJlZGljYXRlICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgc2VhcmNoIHByZWRpY2F0ZScpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5jaGlsZHJlbi5yZWR1Y2UoXG4gICAgICAoZm91bmQsIGNoaWxkKSA9PiBmb3VuZCB8fCBjaGlsZC5maW5kKHByZWRpY2F0ZSksXG4gICAgICB0aGlzLmNoaWxkcmVuLmZpbmQocHJlZGljYXRlKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBjaGlsZHJlbiBub2Rlcy5cbiAgICovXG4gIGVtcHR5KCkge1xuICAgIHRoaXMuY2hpbGRyZW4ubGVuZ3RoID0gMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBAaWdub3JlXG4gICAqL1xuICBjbGljayhvcHRpb25zOiBDbGlja09wdGlvbnMgPSB7fSkge1xuICAgIC8vIGRvIG5vdGhpbmdcbiAgfVxuXG4gIC8qKlxuICAgKiBUaGlzIGV2ZW50IGlzIGZpcmVkIHdoZW4gYW4gZWxlbWVudCBpcyBkcm9wcGVkIG9uIGEgdmFsaWQgZHJvcCB0YXJnZXQuXG4gICAqIEBwYXJhbSAkZXZlbnQgRE9NIGV2ZW50LlxuICAgKi9cbiAgZHJvcCgkZXZlbnQpIHtcbiAgICAkZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgY2xlYXJUaW1lb3V0KHRoaXMuZXhwYW5kRHJhZ1RpbWVvdXQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiB0aGUgdXNlciBzdGFydHMgZHJhZ2dpbmcgYW4gZWxlbWVudC5cbiAgICogQHBhcmFtICRldmVudCBET00gZXZlbnQuXG4gICAqL1xuICBkcmFnU3RhcnQoJGV2ZW50KSB7XG4gICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIC8vIHdlIGNhbid0IHBhc3MgYSBvYmplY3QgdG8gc2V0RGF0YSwgc28gd2UgZG8gaXQgdmlhIHNlcnZpY2VcbiAgICAvLyBzZXQgZGF0YSBpcyBzdGlsbCBuZWVkZWQsIHRvIG1ha2UgdGhlIGRyYWcmZHJvcCB3b3JrXG4gICAgJGV2ZW50LmRhdGFUcmFuc2Zlci5zZXREYXRhKCdub2RlJywgJ25vZGUnKTtcbiAgICB0aGlzLmRyYWdnZWQgPSB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiBhIGRyYWcgb3BlcmF0aW9uIGhhcyBlbmRlZC5cbiAgICogQHBhcmFtICRldmVudCBET00gZXZlbnQuXG4gICAqL1xuICBkcmFnRW5kKCRldmVudCkge1xuICAgICRldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB0aGlzLmRyYWdnZWQgPSBmYWxzZTtcbiAgICAkZXZlbnQuZGF0YVRyYW5zZmVyLmNsZWFyRGF0YSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgaW5mb3JtYXRpb24gd2hldGhlciB0aGUgbmF2aWdhdG9yIG5vZGUgaXMgZHJvcHBhYmxlLlxuICAgKiBAcmVhZG9ubHlcbiAgICovXG4gIGdldCBjYW5Ecm9wKCkge1xuICAgIHJldHVybiB0aGlzLmRyb3BwYWJsZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGluZm9ybWF0aW9uIHdoZXRoZXIgbmF2aWdhdGlvbiBpcyBwb3NzaWJsZS5cbiAgICogQHJlYWRvbmx5XG4gICAqL1xuICBnZXQgY2FuTmF2aWdhdGUoKSB7XG4gICAgcmV0dXJuIHR5cGVvZiB0aGlzLnBhdGggIT09ICd1bmRlZmluZWQnO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiBhIGRyYWdnZWQgZWxlbWVudCBlbnRlcnMgYSB2YWxpZCBkcm9wIHRhcmdldC5cbiAgICogQHBhcmFtICRldmVudCBET00gZXZlbnQuXG4gICAqL1xuICBkcmFnRW50ZXIoJGV2ZW50KSB7XG4gICAgJGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMuZHJhZ2dlZEhvdmVyID0gdHJ1ZTtcbiAgICBpZiAoIXRoaXMub3Blbikge1xuICAgICAgdGhpcy5leHBhbmREcmFnVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4gdGhpcy5leHBhbmQoKSwgMTAwMCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiBhIGRyYWdnZWQgZWxlbWVudCBsZWF2ZXMgYSB2YWxpZCBkcm9wIHRhcmdldC5cbiAgICogQHBhcmFtICRldmVudCBET00gZXZlbnQuXG4gICAqL1xuICBkcmFnTGVhdmUoJGV2ZW50KSB7XG4gICAgJGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgJGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIHRoaXMuZHJhZ2dlZEhvdmVyID0gZmFsc2U7XG4gICAgY2xlYXJUaW1lb3V0KHRoaXMuZXhwYW5kRHJhZ1RpbWVvdXQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4cGFuZHMgdGhlIG5hdmlnYXRvciBub2RlIGlmIGl0IGlzIGNvbGxhcHNlZC5cbiAgICovXG4gIGV4cGFuZCgpIHtcbiAgICBpZiAoIXRoaXMub3Blbikge1xuICAgICAgdGhpcy5vcGVuID0gdHJ1ZTtcbiAgICAgIHRoaXMuY2xpY2soeyBvcGVuOiB0cnVlLCBleHBhbmRlcjogdHJ1ZSB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybXMgYSBjYWxsYmFjayBmdW5jdGlvbiByZWN1cnNpdmVseSBvbiBlYWNoIG9mIHRoZSBuYXZpZ2F0b3Igbm9kZSdzIGNoaWxkcmVuIGRvd24gdGhlIGhpZXJhcmNoeS5cbiAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgRnVuY3Rpb24gdG8gYmUgY2FsbGVkLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKiBgYGB0c1xuICAgKiBjb25zdCBleHBhbmRDaGlsZCA9IChjaGlsZE5vZGUpID0+IGNoaWxkTm9kZS5leHBhbmQoKTtcbiAgICogcGFyZW50Tm9kZS50cmF2ZXJzZShleHBhbmRDaGlsZCk7XG4gICAqIGBgYFxuICAgKi9cbiAgdHJhdmVyc2UoY2FsbGJhY2spIHtcbiAgICBpZiAodGhpcy5jaGlsZHJlbikge1xuICAgICAgdGhpcy5jaGlsZHJlbi5mb3JFYWNoKGNoaWxkID0+IHtcbiAgICAgICAgY2FsbGJhY2soY2hpbGQpO1xuICAgICAgICBjaGlsZC50cmF2ZXJzZShjYWxsYmFjayk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQGlnbm9yZVxuICAgKi9cbiAgZGVzdHJveSgpIHtcbiAgICAvLyBub3RoaW5nIHRvZG8gaGVyZVxuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgdGhlIG5hdmlnYXRvciBub2RlIGJ5IHNvcnRpbmcgaXRzIGNoaWxkcmVuIGFuZCBhbHNvIGNoZWNraW5nIHRoZWlyIHZpc2liaWxpdHkuXG4gICAqL1xuICBwcm90ZWN0ZWQgdXBkYXRlQ2hpbGRyZW4oKSB7XG4gICAgdGhpcy5zb3J0KCk7XG4gICAgdGhpcy51cGRhdGVIaWRkZW4oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTb3J0cyB0aGUgY2hpbGRyZW4gb2YgdGhlIG5hdmlnYXRvciBub2RlLCBieSBwcmlvcml0eSBhbmQgbmFtZSAoQVNDKS5cbiAgICogVGhlIGhpZ2hlciB0aGUgcHJpb3JpdHksIHRoZSBoaWdoZXIgdGhlIHBvc2l0aW9uIGluIHRoZSBoaWVyYXJjaHkuXG4gICAqIEZvciB0aGUgc2FtZSBwcmlvcml0eSB2YWx1ZXMsIHRoZSBhbHBoYWJldGljYWwgb3JkZXIgd2lsbCB0YWtlIHByZWNlZGVuY2UuXG4gICAqL1xuICBwcm90ZWN0ZWQgc29ydCgpIHtcbiAgICB0aGlzLmNoaWxkcmVuLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgIGlmIChhLnByaW9yaXR5ID4gYi5wcmlvcml0eSkge1xuICAgICAgICByZXR1cm4gLTE7XG4gICAgICB9IGVsc2UgaWYgKGEucHJpb3JpdHkgPCBiLnByaW9yaXR5KSB7XG4gICAgICAgIHJldHVybiAxO1xuICAgICAgfSBlbHNlIGlmICgoYS5sYWJlbCB8fCAnJykudG9Mb3dlckNhc2UoKSA8IChiLmxhYmVsIHx8ICcnKS50b0xvd2VyQ2FzZSgpKSB7XG4gICAgICAgIHJldHVybiAtMTtcbiAgICAgIH0gZWxzZSBpZiAoKGEubGFiZWwgfHwgJycpLnRvTG93ZXJDYXNlKCkgPiAoYi5sYWJlbCB8fCAnJykudG9Mb3dlckNhc2UoKSkge1xuICAgICAgICByZXR1cm4gMTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrcyBpZiB0aGUgbmF2aWdhdG9yIG5vZGUgc2hvdWxkIGJlIGhpZGRlbiBiYXNlZCBvbiB0aGUgdmlzaWJpbGl0eSBvZiBpdHMgY2hpbGQgbm9kZXMuXG4gICAqL1xuICBwcm90ZWN0ZWQgdXBkYXRlSGlkZGVuKCkge1xuICAgIGlmICh0eXBlb2YgdGhpcy5wYXRoID09PSAndW5kZWZpbmVkJykge1xuICAgICAgdGhpcy5oaWRkZW4gPSAhdGhpcy5jaGlsZHJlbi5zb21lKCh7IGhpZGRlbiB9KSA9PiAhaGlkZGVuKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==