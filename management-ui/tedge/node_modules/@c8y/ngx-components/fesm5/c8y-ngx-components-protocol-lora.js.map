{"version":3,"file":"c8y-ngx-components-protocol-lora.js","sources":["ng://@c8y/ngx-components/protocol-lora/lora-set-device-protocol.service.ts","ng://@c8y/ngx-components/protocol-lora/lora-set-device-protocol.component.ts","ng://@c8y/ngx-components/protocol-lora/lora-agent.guard.ts","ng://@c8y/ngx-components/protocol-lora/lora-protocol.module.ts","ng://@c8y/ngx-components/protocol-lora/c8y-ngx-components-protocol-lora.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { IManagedObject, InventoryService, IResultList } from '@c8y/client';\n\n@Injectable()\nexport class LoraSetDeviceProtocolService {\n  constructor(\n    private inventoryService: InventoryService) { }\n\n  async getCurrentProtocol(device: IManagedObject) {\n    const protocolId = device.c8y_LpwanDevice.type\n      ? device.c8y_LpwanDevice.type.split('/')[2]\n      : null;\n    if (!protocolId) {\n      return null;\n    }\n    const { data } = await this.inventoryService.detail(protocolId);\n    return data;\n  }\n\n  async applyProtocol(device: IManagedObject, selectedProtocol: IManagedObject) {\n    device.c8y_LpwanDevice.type = 'inventory/managedObjects/' + selectedProtocol.id;\n    device.type = selectedProtocol.name;\n    return this.inventoryService.update(device);\n  }\n\n  async getAvailableProtocols(): Promise<IResultList<IManagedObject>> {\n    const query = {\n      type: {\n        __in: ['c8y_ActilityDeviceType', 'c8y_LoraDeviceType']\n      }\n    };\n    return this.inventoryService.listQuery(query);\n  }\n}\n","import { Component, OnInit, ViewChild } from '@angular/core';\nimport { LoraSetDeviceProtocolService } from './lora-set-device-protocol.service';\nimport { AlertService, gettext } from '@c8y/ngx-components';\nimport { IManagedObject, InventoryService, IResultList } from '@c8y/client';\nimport { Router } from '@angular/router';\nimport { pipe } from 'rxjs';\nimport { map } from 'rxjs/operators';\n\n@Component({\n  selector: 'set-device-protocol',\n  templateUrl: './lora-set-device-protocol.component.html'\n})\n\nexport class LoraAssignDeviceProtocolComponent implements OnInit {\n  loading: boolean;\n  device: IManagedObject;\n  currentProtocol: IManagedObject;\n  availableProtocols: IResultList<IManagedObject>;\n  newProtocol: IManagedObject;\n\n  filterCurrentProtocol = pipe(\n    map((protocols: IManagedObject[]) =>\n      protocols.filter(protocol => !this.currentProtocol || this.currentProtocol.id !== protocol.id)\n    )\n  );\n  @ViewChild('loraSetDeviceProtocolForm', { static: false }) loraSetDeviceProtocolForm: any;\n\n  constructor(\n    private loraService: LoraSetDeviceProtocolService,\n    private alertService: AlertService,\n    private router: Router,\n    private inventoryService: InventoryService\n  ) { }\n  async ngOnInit() {\n    await this.reload();\n  }\n\n  async reload() {\n    this.loading = true;\n    this.newProtocol = null;\n    try {\n      await this.loadDevice();\n      this.availableProtocols = await this.loraService.getAvailableProtocols();\n      this.currentProtocol = await this.loraService.getCurrentProtocol(this.device);\n    } catch (ex) {\n      this.alertService.addServerFailure(ex);\n    } finally {\n      this.loading = false;\n    }\n  }\n\n  async loadDevice() {\n    const deviceId = this.router.routerState.snapshot.url.match(/\\d+/)[0];\n    const { data } = await this.inventoryService.detail(deviceId);\n    this.device = data;\n  }\n\n  async apply(selectedProtocol) {\n    try {\n      await this.loraService.applyProtocol(this.device, selectedProtocol);\n      await this.reload();\n      this.alertService.success(gettext('Device protocol set.'));\n      this.loraSetDeviceProtocolForm.reset('dirty');\n    } catch (ex) {\n      this.alertService.danger(gettext('Could not set device protocol.'));\n    }\n  }\n}\n","import { Injectable } from '@angular/core';\nimport { ActivatedRouteSnapshot, CanActivate } from '@angular/router';\nimport {\n  isUndefined\n} from 'lodash-es';\nimport { Observable } from 'rxjs';\n\n@Injectable()\nexport class LoraAgentGuard implements CanActivate {\n  canActivate(route: ActivatedRouteSnapshot): boolean {\n    const contextData = route.data.contextData || route.parent.data.contextData;\n    return contextData && !isUndefined(contextData.c8y_LpwanDevice) && (contextData.c8y_LpwanDevice.lpwanDeviceType === 'Lora');\n  }\n}\n","import { NgModule } from '@angular/core';\nimport {\n  CoreModule,\n  FormsModule,\n  gettext,\n  HOOK_ONCE_ROUTE,\n  Route,\n  ViewContext\n} from '@c8y/ngx-components';\nimport { LoraAssignDeviceProtocolComponent } from './lora-set-device-protocol.component';\nimport { LoraAgentGuard } from './lora-agent.guard';\nimport { LoraSetDeviceProtocolService } from './lora-set-device-protocol.service';\n\nconst routes: Route[] = [\n  {\n    context: ViewContext.Device,\n    path: 'assign-protocol',\n    component: LoraAssignDeviceProtocolComponent,\n    label: gettext('LPWAN'),\n    icon: 'c8y-device-protocols',\n    canActivate: [LoraAgentGuard]\n  }\n];\n\n@NgModule({\n  declarations: [\n    LoraAssignDeviceProtocolComponent\n  ],\n  imports: [\n    CoreModule,\n    FormsModule\n  ],\n  entryComponents: [LoraAssignDeviceProtocolComponent],\n  providers: [\n    LoraAgentGuard,\n    LoraSetDeviceProtocolService,\n    {\n      provide: HOOK_ONCE_ROUTE,\n      useValue: routes,\n      multi: true\n    }\n  ]\n})\nexport class LoraProtocolModule { }\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n\nexport {LoraAgentGuard as ɵb} from './lora-agent.guard';\nexport {LoraSetDeviceProtocolService as ɵa} from './lora-set-device-protocol.service';"],"names":["tslib_1.__decorate"],"mappings":"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"}