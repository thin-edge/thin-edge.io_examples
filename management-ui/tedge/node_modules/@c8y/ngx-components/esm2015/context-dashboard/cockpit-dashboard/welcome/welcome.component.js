import * as tslib_1 from "tslib";
import { Component, Input } from '@angular/core';
import { gettext, DocsService, DocLink, NavigatorService, NavigatorNode } from '@c8y/ngx-components';
import { Router } from '@angular/router';
import { TenantService, ApplicationService, IApplication } from '@c8y/client';
let WelcomeToCockpit = class WelcomeToCockpit {
    constructor(tenantService, docs, router, navigator, applicationService) {
        this.tenantService = tenantService;
        this.docs = docs;
        this.router = router;
        this.navigator = navigator;
        this.applicationService = applicationService;
        this.quickLinks = [];
        this.CONFIGURATION_NODE = 'Configuration';
        this.TRIAL = 'TRIAL';
    }
    ngOnInit() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.tenantType = yield this.tenantService.currentTenantType();
            this.setMessage();
            this.navSubscription = this.navigator.items$.subscribe(nodes => {
                this.navNodes = nodes;
                this.configurationNode = nodes.find((node) => node.label === this.CONFIGURATION_NODE);
            });
            this.docsSubscription = this.docs.items$.subscribe(links => {
                this.links = links;
            });
            // <---TRIAL & REGULAR TENANT --->
            this.createConnectSmartphoneQuickLink();
            yield this.createQuicklinkRegisterDevice();
            // <--- TRIAL TENANT --->
            if (this.tenantType === this.TRIAL) {
                this.createQuicklinkUserGuide();
                return;
            }
            // <--- REGULAR TENANT --->
            this.createQuicklinkAddGroup();
            this.createQuickLinkReports();
            this.createQuickLinkExports();
            this.createQuicklinkSmartRules();
        });
    }
    ngOnDestroy() {
        if (this.docsSubscription && !this.docsSubscription.closed) {
            this.docsSubscription.unsubscribe();
        }
        if (this.navSubscription && !this.navSubscription.closed) {
            this.navSubscription.unsubscribe();
        }
    }
    setMessage() {
        if (this.tenantType === this.TRIAL) {
            this.welcomeMessage = gettext(`
        The Cockpit application allows you to build IoT applications in minutes.
        To get started, connect any device to the platform.
        If you do not have an IoT device to hand, you can start by connecting your smartphone.
        Click below to be guided through the process.
      `);
        }
        else {
            this.welcomeMessage = gettext(`
        The Cockpit application provides you with options to manage
        and monitor Internet of Things assets and data from business perspective.
      `);
        }
    }
    createQuicklinkAddGroup() {
        // comes from angularJS factory c8yQuickLinks
        const addGroup = this.links.find(link => link.label === 'Add group');
        if (addGroup) {
            this.quickLinks.push(addGroup);
        }
    }
    createConnectSmartphoneQuickLink() {
        // Provider in SensorPhoneModule defines the
        // 'Connect smartphone' quicklink.
        const connectSmartphone = this.links.find(link => link.label === 'Connect smartphone');
        if (connectSmartphone) {
            this.quickLinks.push(connectSmartphone);
        }
    }
    createQuickLinkReports() {
        const label = gettext('Reports');
        const reports = {
            icon: 'th',
            label,
            url: '/reports'
        };
        const reportsNode = this.findNavigatorNode(label, this.navNodes);
        if (reportsNode) {
            reports.click = () => {
                reportsNode.open = true;
                this.router.navigateByUrl(reports.url);
            };
            this.quickLinks.push(reports);
        }
    }
    createQuickLinkExports() {
        const label = gettext('Exports');
        const exports = {
            icon: 'c8y-reports',
            label,
            url: '/export'
        };
        if (this.isConfigChildNodeShown(label)) {
            exports.click = () => {
                this.configurationNode.open = true;
                this.router.navigateByUrl(exports.url);
            };
            this.quickLinks.push(exports);
        }
    }
    createQuicklinkSmartRules() {
        const label = gettext('Smart rules');
        const smartRules = {
            icon: 'c8y-smart-rules',
            label,
            url: '/rules'
        };
        if (this.isConfigChildNodeShown('Global smart rules')) {
            smartRules.click = () => {
                this.configurationNode.open = true;
                this.router.navigateByUrl(smartRules.url);
            };
            this.quickLinks.push(smartRules);
        }
    }
    createQuicklinkRegisterDevice() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const { data } = yield this.applicationService.listByUser();
            if (data) {
                const deviceManagement = data.find(app => app.contextPath === 'devicemanagement');
                if (deviceManagement) {
                    const deviceMgmtUrl = this.applicationService.getHref(deviceManagement);
                    const registerDevice = {
                        icon: 'c8y-device-connect',
                        label: gettext('Register device'),
                        click: () => window.open(`${deviceMgmtUrl}/#/deviceregistration`, '_self')
                    };
                    this.quickLinks.push(registerDevice);
                }
            }
        });
    }
    createQuicklinkUserGuide() {
        const userGuide = {
            icon: 'c8y-user',
            label: gettext('User guide'),
            url: '/users-guide/getting-started',
            click: () => {
                const userGuideURL = this.docs.getUserGuideLink(userGuide.url);
                window.open(userGuideURL);
            }
        };
        this.quickLinks.push(userGuide);
    }
    isConfigChildNodeShown(nodeName) {
        if (this.configurationNode && this.configurationNode.show) {
            const navNode = this.findNavigatorNode(nodeName, this.configurationNode.children);
            return !!navNode && navNode.show;
        }
        return false;
    }
    findNavigatorNode(nodeName, navNodes) {
        if (navNodes && navNodes.length > 0) {
            return navNodes.find((node) => node.label === nodeName);
        }
        return undefined;
    }
};
WelcomeToCockpit.ctorParameters = () => [
    { type: TenantService },
    { type: DocsService },
    { type: Router },
    { type: NavigatorService },
    { type: ApplicationService }
];
tslib_1.__decorate([
    Input()
], WelcomeToCockpit.prototype, "config", void 0);
WelcomeToCockpit = tslib_1.__decorate([
    Component({
        selector: 'c8y-welcome-to-cockpit',
        template: "<div class=\"welcome-widget welcome-cockpit\">\n  <div class=\"flex-row\">\n    <div class=\"col-xs-12 col-md-5 flex-item-v-stretch p-24\">\n      <h2 class=\"text-light\">{{ 'Welcome to Cockpit' | translate }}</h2>\n      <p class=\"text-16 text-light p-t-16 p-b-24\">{{ welcomeMessage | translate }}</p>\n      <div class=\"card-group interact-grid tight-grid\">\n        <div *ngFor=\"let link of quickLinks\" class=\"col-sm-4 col-xs-6\">\n          <c8y-quick-link\n            (click)=\"link.click ? link.click() : false\"\n            [icon]=\"link.icon\"\n            [label]=\"link.label\"\n            class=\"card\"\n            c8yProductExperience\n            [actionName]=\"'welcomeWidgetClicked'\"\n            [actionData]=\"{ link: link.label }\"\n          >\n          </c8y-quick-link>\n        </div>\n      </div>\n    </div>\n    <!-- <div class=\"col-sm-6 welcome-illustration flex-item-v-stretch\"></div> -->\n  </div>\n</div>\n"
    })
], WelcomeToCockpit);
export { WelcomeToCockpit };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2VsY29tZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYzh5L25neC1jb21wb25lbnRzL2NvbnRleHQtZGFzaGJvYXJkLyIsInNvdXJjZXMiOlsiY29ja3BpdC1kYXNoYm9hcmQvd2VsY29tZS93ZWxjb21lLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQXFCLE1BQU0sZUFBZSxDQUFDO0FBQ3BFLE9BQU8sRUFDTCxPQUFPLEVBQ1AsV0FBVyxFQUNYLE9BQU8sRUFDUCxnQkFBZ0IsRUFDaEIsYUFBYSxFQUNkLE1BQU0scUJBQXFCLENBQUM7QUFDN0IsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRXpDLE9BQU8sRUFBRSxhQUFhLEVBQUUsa0JBQWtCLEVBQUUsWUFBWSxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBTTlFLElBQWEsZ0JBQWdCLEdBQTdCLE1BQWEsZ0JBQWdCO0lBYzNCLFlBQ1UsYUFBNEIsRUFDNUIsSUFBaUIsRUFDakIsTUFBYyxFQUNkLFNBQTJCLEVBQzNCLGtCQUFzQztRQUp0QyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixTQUFJLEdBQUosSUFBSSxDQUFhO1FBQ2pCLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDZCxjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUMzQix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBaEJoRCxlQUFVLEdBQUcsRUFBRSxDQUFDO1FBRUMsdUJBQWtCLEdBQVcsZUFBZSxDQUFDO1FBQzdDLFVBQUssR0FBVyxPQUFPLENBQUM7SUFjdEMsQ0FBQztJQUVFLFFBQVE7O1lBQ1osSUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztZQUMvRCxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDbEIsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENB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QTVMWSxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIElucHV0LCBPbkluaXQsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgZ2V0dGV4dCxcbiAgRG9jc1NlcnZpY2UsXG4gIERvY0xpbmssXG4gIE5hdmlnYXRvclNlcnZpY2UsXG4gIE5hdmlnYXRvck5vZGVcbn0gZnJvbSAnQGM4eS9uZ3gtY29tcG9uZW50cyc7XG5pbXBvcnQgeyBSb3V0ZXIgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBUZW5hbnRTZXJ2aWNlLCBBcHBsaWNhdGlvblNlcnZpY2UsIElBcHBsaWNhdGlvbiB9IGZyb20gJ0BjOHkvY2xpZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnYzh5LXdlbGNvbWUtdG8tY29ja3BpdCcsXG4gIHRlbXBsYXRlVXJsOiAnLi93ZWxjb21lLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBXZWxjb21lVG9Db2NrcGl0IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICBASW5wdXQoKSBjb25maWc7XG4gIHdlbGNvbWVNZXNzYWdlO1xuICBxdWlja0xpbmtzID0gW107XG5cbiAgcHJpdmF0ZSByZWFkb25seSBDT05GSUdVUkFUSU9OX05PREU6IHN0cmluZyA9ICdDb25maWd1cmF0aW9uJztcbiAgcHJpdmF0ZSByZWFkb25seSBUUklBTDogc3RyaW5nID0gJ1RSSUFMJztcbiAgcHJpdmF0ZSB0ZW5hbnRUeXBlOiBzdHJpbmc7XG4gIHByaXZhdGUgbmF2Tm9kZXM6IE5hdmlnYXRvck5vZGVbXTtcbiAgcHJpdmF0ZSBjb25maWd1cmF0aW9uTm9kZTogYW55O1xuICBwcml2YXRlIGxpbmtzOiBEb2NMaW5rW107XG4gIHByaXZhdGUgZG9jc1N1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICBwcml2YXRlIG5hdlN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdGVuYW50U2VydmljZTogVGVuYW50U2VydmljZSxcbiAgICBwcml2YXRlIGRvY3M6IERvY3NTZXJ2aWNlLFxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXG4gICAgcHJpdmF0ZSBuYXZpZ2F0b3I6IE5hdmlnYXRvclNlcnZpY2UsXG4gICAgcHJpdmF0ZSBhcHBsaWNhdGlvblNlcnZpY2U6IEFwcGxpY2F0aW9uU2VydmljZVxuICApIHt9XG5cbiAgYXN5bmMgbmdPbkluaXQoKSB7XG4gICAgdGhpcy50ZW5hbnRUeXBlID0gYXdhaXQgdGhpcy50ZW5hbnRTZXJ2aWNlLmN1cnJlbnRUZW5hbnRUeXBlKCk7XG4gICAgdGhpcy5zZXRNZXNzYWdlKCk7XG4gICAgdGhpcy5uYXZTdWJzY3JpcHRpb24gPSB0aGlzLm5hdmlnYXRvci5pdGVtcyQuc3Vic2NyaWJlKG5vZGVzID0+IHtcbiAgICAgIHRoaXMubmF2Tm9kZXMgPSBub2RlcztcbiAgICAgIHRoaXMuY29uZmlndXJhdGlvbk5vZGUgPSBub2Rlcy5maW5kKChub2RlOiBhbnkpID0+IG5vZGUubGFiZWwgPT09IHRoaXMuQ09ORklHVVJBVElPTl9OT0RFKTtcbiAgICB9KTtcbiAgICB0aGlzLmRvY3NTdWJzY3JpcHRpb24gPSB0aGlzLmRvY3MuaXRlbXMkLnN1YnNjcmliZShsaW5rcyA9PiB7XG4gICAgICB0aGlzLmxpbmtzID0gbGlua3M7XG4gICAgfSk7XG5cbiAgICAvLyA8LS0tVFJJQUwgJiBSRUdVTEFSIFRFTkFOVCAtLS0+XG4gICAgdGhpcy5jcmVhdGVDb25uZWN0U21hcnRwaG9uZVF1aWNrTGluaygpO1xuICAgIGF3YWl0IHRoaXMuY3JlYXRlUXVpY2tsaW5rUmVnaXN0ZXJEZXZpY2UoKTtcblxuICAgIC8vIDwtLS0gVFJJQUwgVEVOQU5UIC0tLT5cbiAgICBpZiAodGhpcy50ZW5hbnRUeXBlID09PSB0aGlzLlRSSUFMKSB7XG4gICAgICB0aGlzLmNyZWF0ZVF1aWNrbGlua1VzZXJHdWlkZSgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIDwtLS0gUkVHVUxBUiBURU5BTlQgLS0tPlxuICAgIHRoaXMuY3JlYXRlUXVpY2tsaW5rQWRkR3JvdXAoKTtcbiAgICB0aGlzLmNyZWF0ZVF1aWNrTGlua1JlcG9ydHMoKTtcbiAgICB0aGlzLmNyZWF0ZVF1aWNrTGlua0V4cG9ydHMoKTtcbiAgICB0aGlzLmNyZWF0ZVF1aWNrbGlua1NtYXJ0UnVsZXMoKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIGlmICh0aGlzLmRvY3NTdWJzY3JpcHRpb24gJiYgIXRoaXMuZG9jc1N1YnNjcmlwdGlvbi5jbG9zZWQpIHtcbiAgICAgIHRoaXMuZG9jc1N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLm5hdlN1YnNjcmlwdGlvbiAmJiAhdGhpcy5uYXZTdWJzY3JpcHRpb24uY2xvc2VkKSB7XG4gICAgICB0aGlzLm5hdlN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0TWVzc2FnZSgpIHtcbiAgICBpZiAodGhpcy50ZW5hbnRUeXBlID09PSB0aGlzLlRSSUFMKSB7XG4gICAgICB0aGlzLndlbGNvbWVNZXNzYWdlID0gZ2V0dGV4dChgXG4gICAgICAgIFRoZSBDb2NrcGl0IGFwcGxpY2F0aW9uIGFsbG93cyB5b3UgdG8gYnVpbGQgSW9UIGFwcGxpY2F0aW9ucyBpbiBtaW51dGVzLlxuICAgICAgICBUbyBnZXQgc3RhcnRlZCwgY29ubmVjdCBhbnkgZGV2aWNlIHRvIHRoZSBwbGF0Zm9ybS5cbiAgICAgICAgSWYgeW91IGRvIG5vdCBoYXZlIGFuIElvVCBkZXZpY2UgdG8gaGFuZCwgeW91IGNhbiBzdGFydCBieSBjb25uZWN0aW5nIHlvdXIgc21hcnRwaG9uZS5cbiAgICAgICAgQ2xpY2sgYmVsb3cgdG8gYmUgZ3VpZGVkIHRocm91Z2ggdGhlIHByb2Nlc3MuXG4gICAgICBgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy53ZWxjb21lTWVzc2FnZSA9IGdldHRleHQoYFxuICAgICAgICBUaGUgQ29ja3BpdCBhcHBsaWNhdGlvbiBwcm92aWRlcyB5b3Ugd2l0aCBvcHRpb25zIHRvIG1hbmFnZVxuICAgICAgICBhbmQgbW9uaXRvciBJbnRlcm5ldCBvZiBUaGluZ3MgYXNzZXRzIGFuZCBkYXRhIGZyb20gYnVzaW5lc3MgcGVyc3BlY3RpdmUuXG4gICAgICBgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZVF1aWNrbGlua0FkZEdyb3VwKCkge1xuICAgIC8vIGNvbWVzIGZyb20gYW5ndWxhckpTIGZhY3RvcnkgYzh5UXVpY2tMaW5rc1xuICAgIGNvbnN0IGFkZEdyb3VwOiBQYXJ0aWFsPERvY0xpbms+ID0gdGhpcy5saW5rcy5maW5kKGxpbmsgPT4gbGluay5sYWJlbCA9PT0gJ0FkZCBncm91cCcpO1xuICAgIGlmIChhZGRHcm91cCkge1xuICAgICAgdGhpcy5xdWlja0xpbmtzLnB1c2goYWRkR3JvdXApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQ29ubmVjdFNtYXJ0cGhvbmVRdWlja0xpbmsoKSB7XG4gICAgLy8gUHJvdmlkZXIgaW4gU2Vuc29yUGhvbmVNb2R1bGUgZGVmaW5lcyB0aGVcbiAgICAvLyAnQ29ubmVjdCBzbWFydHBob25lJyBxdWlja2xpbmsuXG4gICAgY29uc3QgY29ubmVjdFNtYXJ0cGhvbmUgPSB0aGlzLmxpbmtzLmZpbmQobGluayA9PiBsaW5rLmxhYmVsID09PSAnQ29ubmVjdCBzbWFydHBob25lJyk7XG4gICAgaWYgKGNvbm5lY3RTbWFydHBob25lKSB7XG4gICAgICB0aGlzLnF1aWNrTGlua3MucHVzaChjb25uZWN0U21hcnRwaG9uZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVRdWlja0xpbmtSZXBvcnRzKCkge1xuICAgIGNvbnN0IGxhYmVsID0gZ2V0dGV4dCgnUmVwb3J0cycpO1xuICAgIGNvbnN0IHJlcG9ydHM6IFBhcnRpYWw8RG9jTGluaz4gPSB7XG4gICAgICBpY29uOiAndGgnLFxuICAgICAgbGFiZWwsXG4gICAgICB1cmw6ICcvcmVwb3J0cydcbiAgICB9O1xuICAgIGNvbnN0IHJlcG9ydHNOb2RlID0gdGhpcy5maW5kTmF2aWdhdG9yTm9kZShsYWJlbCwgdGhpcy5uYXZOb2Rlcyk7XG4gICAgaWYgKHJlcG9ydHNOb2RlKSB7XG4gICAgICByZXBvcnRzLmNsaWNrID0gKCkgPT4ge1xuICAgICAgICByZXBvcnRzTm9kZS5vcGVuID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybChyZXBvcnRzLnVybCk7XG4gICAgICB9O1xuICAgICAgdGhpcy5xdWlja0xpbmtzLnB1c2gocmVwb3J0cyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVRdWlja0xpbmtFeHBvcnRzKCkge1xuICAgIGNvbnN0IGxhYmVsID0gZ2V0dGV4dCgnRXhwb3J0cycpO1xuICAgIGNvbnN0IGV4cG9ydHM6IFBhcnRpYWw8RG9jTGluaz4gPSB7XG4gICAgICBpY29uOiAnYzh5LXJlcG9ydHMnLFxuICAgICAgbGFiZWwsXG4gICAgICB1cmw6ICcvZXhwb3J0J1xuICAgIH07XG5cbiAgICBpZiAodGhpcy5pc0NvbmZpZ0NoaWxkTm9kZVNob3duKGxhYmVsKSkge1xuICAgICAgZXhwb3J0cy5jbGljayA9ICgpID0+IHtcbiAgICAgICAgdGhpcy5jb25maWd1cmF0aW9uTm9kZS5vcGVuID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGVCeVVybChleHBvcnRzLnVybCk7XG4gICAgICB9O1xuICAgICAgdGhpcy5xdWlja0xpbmtzLnB1c2goZXhwb3J0cyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVRdWlja2xpbmtTbWFydFJ1bGVzKCkge1xuICAgIGNvbnN0IGxhYmVsID0gZ2V0dGV4dCgnU21hcnQgcnVsZXMnKTtcbiAgICBjb25zdCBzbWFydFJ1bGVzOiBQYXJ0aWFsPERvY0xpbms+ID0ge1xuICAgICAgaWNvbjogJ2M4eS1zbWFydC1ydWxlcycsXG4gICAgICBsYWJlbCxcbiAgICAgIHVybDogJy9ydWxlcydcbiAgICB9O1xuICAgIGlmICh0aGlzLmlzQ29uZmlnQ2hpbGROb2RlU2hvd24oJ0dsb2JhbCBzbWFydCBydWxlcycpKSB7XG4gICAgICBzbWFydFJ1bGVzLmNsaWNrID0gKCkgPT4ge1xuICAgICAgICB0aGlzLmNvbmZpZ3VyYXRpb25Ob2RlLm9wZW4gPSB0cnVlO1xuICAgICAgICB0aGlzLnJvdXRlci5uYXZpZ2F0ZUJ5VXJsKHNtYXJ0UnVsZXMudXJsKTtcbiAgICAgIH07XG4gICAgICB0aGlzLnF1aWNrTGlua3MucHVzaChzbWFydFJ1bGVzKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNyZWF0ZVF1aWNrbGlua1JlZ2lzdGVyRGV2aWNlKCkge1xuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5hcHBsaWNhdGlvblNlcnZpY2UubGlzdEJ5VXNlcigpO1xuICAgIGlmIChkYXRhKSB7XG4gICAgICBjb25zdCBkZXZpY2VNYW5hZ2VtZW50OiBJQXBwbGljYXRpb24gPSBkYXRhLmZpbmQoXG4gICAgICAgIGFwcCA9PiBhcHAuY29udGV4dFBhdGggPT09ICdkZXZpY2VtYW5hZ2VtZW50J1xuICAgICAgKTtcbiAgICAgIGlmIChkZXZpY2VNYW5hZ2VtZW50KSB7XG4gICAgICAgIGNvbnN0IGRldmljZU1nbXRVcmwgPSB0aGlzLmFwcGxpY2F0aW9uU2VydmljZS5nZXRIcmVmKGRldmljZU1hbmFnZW1lbnQpO1xuICAgICAgICBjb25zdCByZWdpc3RlckRldmljZTogUGFydGlhbDxEb2NMaW5rPiA9IHtcbiAgICAgICAgICBpY29uOiAnYzh5LWRldmljZS1jb25uZWN0JyxcbiAgICAgICAgICBsYWJlbDogZ2V0dGV4dCgnUmVnaXN0ZXIgZGV2aWNlJyksXG4gICAgICAgICAgY2xpY2s6ICgpID0+IHdpbmRvdy5vcGVuKGAke2RldmljZU1nbXRVcmx9LyMvZGV2aWNlcmVnaXN0cmF0aW9uYCwgJ19zZWxmJylcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5xdWlja0xpbmtzLnB1c2gocmVnaXN0ZXJEZXZpY2UpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUXVpY2tsaW5rVXNlckd1aWRlKCkge1xuICAgIGNvbnN0IHVzZXJHdWlkZTogUGFydGlhbDxEb2NMaW5rPiA9IHtcbiAgICAgIGljb246ICdjOHktdXNlcicsXG4gICAgICBsYWJlbDogZ2V0dGV4dCgnVXNlciBndWlkZScpLFxuICAgICAgdXJsOiAnL3VzZXJzLWd1aWRlL2dldHRpbmctc3RhcnRlZCcsXG4gICAgICBjbGljazogKCkgPT4ge1xuICAgICAgICBjb25zdCB1c2VyR3VpZGVVUkwgPSB0aGlzLmRvY3MuZ2V0VXNlckd1aWRlTGluayh1c2VyR3VpZGUudXJsKSBhcyBzdHJpbmc7XG4gICAgICAgIHdpbmRvdy5vcGVuKHVzZXJHdWlkZVVSTCk7XG4gICAgICB9XG4gICAgfTtcbiAgICB0aGlzLnF1aWNrTGlua3MucHVzaCh1c2VyR3VpZGUpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0NvbmZpZ0NoaWxkTm9kZVNob3duKG5vZGVOYW1lKSB7XG4gICAgaWYgKHRoaXMuY29uZmlndXJhdGlvbk5vZGUgJiYgdGhpcy5jb25maWd1cmF0aW9uTm9kZS5zaG93KSB7XG4gICAgICBjb25zdCBuYXZOb2RlID0gdGhpcy5maW5kTmF2aWdhdG9yTm9kZShub2RlTmFtZSwgdGhpcy5jb25maWd1cmF0aW9uTm9kZS5jaGlsZHJlbik7XG4gICAgICByZXR1cm4gISFuYXZOb2RlICYmIG5hdk5vZGUuc2hvdztcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kTmF2aWdhdG9yTm9kZShub2RlTmFtZTogc3RyaW5nLCBuYXZOb2RlczogTmF2aWdhdG9yTm9kZVtdKSB7XG4gICAgaWYgKG5hdk5vZGVzICYmIG5hdk5vZGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiBuYXZOb2Rlcy5maW5kKChub2RlOiBhbnkpID0+IG5vZGUubGFiZWwgPT09IG5vZGVOYW1lKSBhcyBhbnk7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbn1cbiJdfQ==