import * as tslib_1 from "tslib";
import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { ControlContainer, NgModelGroup } from '@angular/forms';
import { AlertService, gettext } from '@c8y/ngx-components';
import { isEmpty, assign, unset, get, set, cloneDeep, isEqual } from 'lodash-es';
import { OpcuaDeviceProtocolObjectMapping } from './opcua-device-protocol-object-mapping.component';
import { AddressSpaceService } from './address-space.service';
let OpcuaDeviceProtocolMapping = class OpcuaDeviceProtocolMapping {
    constructor(alertService, addressSpaceService) {
        this.alertService = alertService;
        this.addressSpaceService = addressSpaceService;
        this.onAction = new EventEmitter();
        this.isPathFocused = false;
        this.isBrowsePathUniq = true;
        this.dataReporting = 'default';
        this.isTreeOpen = false;
        this.isNew = false;
        this.resetModel = false;
        this.moId = '';
        this.getMappings = () => this.getParentAttr('mappings');
    }
    toggleDetail() {
        this.isDetailOpen = !this.isDetailOpen;
        if (this.resetModel) {
            this.initialFormSetup();
        }
    }
    ngOnInit() {
        this.dataReportingName = 'ReportingMode' + this.index;
        this.initialFormSetup();
    }
    ngOnChanges(changes) {
        if (changes._model.previousValue &&
            !isEqual(this._model, changes._model.previousValue.SimpleChange)) {
            if (this.mapping && this.mapping.name === this._model.name) {
                this.mapping.id = this._model.id;
            }
        }
    }
    initialFormSetup() {
        const mapping = {
            id: '',
            browsePath: [],
            name: '',
            subscriptionType: {
                type: 'None'
            }
        };
        const customAction = {
            headers: [{ key: 'Authorization', value: '' }, { key: 'Content-Type', value: '' }],
            bodyTemplate: '',
            type: 'HttpPost',
            endpoint: ''
        };
        this.mapping = assign({}, mapping, cloneDeep(this._model));
        if (isEmpty(this.mapping.browsePath)) {
            this.isNew = true;
            this.isDetailOpen = true;
        }
        else {
            this.browsePath = this.stringfyBrowsePath(this.mapping.browsePath);
            this.nodeDisplayName = this.mapping.name;
        }
        if (this.referencedRootNodeId) {
            this.referencedNode = { nodeId: this.referencedRootNodeId };
            this.addressSpaceService.triggerNodeToOpen({
                node: {
                    nodeId: this.referencedRootNodeId,
                    children: [],
                    expanded: false,
                    absolutePaths: [[]]
                },
                selectedAncestorIds: []
            });
        }
        else {
            this.referencedNode = { nodeId: '' };
        }
        if (get(this.mapping, 'customAction')) {
            this.customAction = assign(customAction, get(this.mapping, 'customAction'));
            this.customAction.headers = this.mapHeadersObjectToList(get(this.customAction, 'headers'));
        }
        else {
            this.customAction = assign({}, customAction);
        }
        unset(this.mapping, 'customAction');
        if (get(this._model, 'subscriptionType')) {
            this.dataReporting = 'custom';
        }
        else {
            this.dataReporting = 'default';
        }
        this.resetModel = false;
    }
    showAddressSpaceTree() {
        return !isEmpty(this.referencedServerId);
    }
    ngAfterViewInit() {
        if (get(this.mapping, 'subscriptionType') &&
            get(this.mapping, 'subscriptionType.type') !== 'None') {
            this.dataReporting = 'custom';
        }
    }
    mapHeadersObjectToList(headers) {
        if (Object.keys(headers).length > 0) {
            return Object.keys(headers).map(item => {
                return { key: item, value: headers[item] };
            });
        }
    }
    stringfyBrowsePath(path) {
        return JSON.stringify(path);
    }
    updateBrowsePath(node) {
        this.mapping.browsePath = node.relativePath;
        this.nodeDisplayName = node.displayName;
        this.mapping.name = this.nodeDisplayName;
        this.browsePath = this.stringfyBrowsePath(this.mapping.browsePath);
        this.browsePathModel.control.markAsDirty();
    }
    updateDisplayname() {
        this.mapping.name = this.nodeDisplayName;
    }
    updateBrowsePathInput() {
        if (this.browsePath) {
            try {
                this.mapping.browsePath = JSON.parse(this.browsePath);
            }
            catch (error) {
                return;
            }
        }
    }
    save() {
        if (this.dataReporting === 'default') {
            unset(this.mapping, 'subscriptionType');
        }
        if (get(this.mapping, 'measurementCreation')) {
            const { measurementCreation } = this.mapping;
            set(measurementCreation, 'fragmentName', get(measurementCreation, 'type'));
        }
        const { customAction } = this.subFormRef.value;
        let modifiedCustomAction;
        if (customAction.hasCustomAction) {
            const reducedHeaders = this.customAction.headers.reduce((result, item) => {
                result[item.key] = item.value;
                return result;
            }, {});
            modifiedCustomAction = assign({}, this.customAction, { headers: reducedHeaders });
        }
        this.onAction.emit({
            action: 'save',
            data: assign({}, this.mapping, { customAction: modifiedCustomAction })
        });
        this.isDetailOpen = false;
    }
    cancel() {
        this.isDetailOpen = false;
        this.resetModel = true;
        if (this.mapping.id === 'new') {
            this.onAction.emit({ action: 'delete', data: assign({}, this.mapping) });
        }
    }
    onDelete() {
        this.onAction.emit({ action: 'delete', data: this.mapping });
    }
    canSave(variableForm) {
        const areValid = () => variableForm.valid && this.objectMappingForm.$componentScope.mappingForm.$valid;
        const areDirty = () => variableForm.dirty || this.objectMappingForm.$componentScope.mappingForm.$dirty;
        return areValid() && areDirty();
    }
    isActive() {
        return this.isDetailOpen;
    }
    setTreeFromRefNode() {
        if (this.referencedRootNodeId) {
            this.addressSpaceService.triggerNodeToOpen({
                node: {
                    nodeId: this.referencedRootNodeId,
                    children: [],
                    expanded: false,
                    absolutePaths: [[]]
                },
                selectedAncestorIds: []
            });
        }
    }
};
OpcuaDeviceProtocolMapping.ctorParameters = () => [
    { type: AlertService },
    { type: AddressSpaceService }
];
tslib_1.__decorate([
    ViewChild(OpcuaDeviceProtocolObjectMapping, { static: false })
], OpcuaDeviceProtocolMapping.prototype, "objectMappingForm", void 0);
tslib_1.__decorate([
    ViewChild('variableForm', { static: false })
], OpcuaDeviceProtocolMapping.prototype, "subFormRef", void 0);
tslib_1.__decorate([
    ViewChild('browsePathModel', { static: false })
], OpcuaDeviceProtocolMapping.prototype, "browsePathModel", void 0);
tslib_1.__decorate([
    Input('resource')
], OpcuaDeviceProtocolMapping.prototype, "_model", void 0);
tslib_1.__decorate([
    Input()
], OpcuaDeviceProtocolMapping.prototype, "index", void 0);
tslib_1.__decorate([
    Input()
], OpcuaDeviceProtocolMapping.prototype, "getParentAttr", void 0);
tslib_1.__decorate([
    Input()
], OpcuaDeviceProtocolMapping.prototype, "referencedServerId", void 0);
tslib_1.__decorate([
    Input()
], OpcuaDeviceProtocolMapping.prototype, "referencedRootNodeId", void 0);
tslib_1.__decorate([
    Output()
], OpcuaDeviceProtocolMapping.prototype, "onAction", void 0);
OpcuaDeviceProtocolMapping = tslib_1.__decorate([
    Component({
        selector: 'opcua-device-protocol-mapping',
        template: "<div class=\"list-group-item collapsible\" [ngClass]=\"{ expanded: isDetailOpen }\">\n  <div class=\"flex-row\" (click)=\"toggleDetail()\">\n    <div class=\"list-item-actions\">\n      <button class=\"btn btn-clean showOnHover flex-item-right\" title=\"{{ 'Delete' | translate }}\">\n        <i c8yIcon=\"minus-circle\" class=\"text-danger\" (click)=\"onDelete()\"></i>\n      </button>\n      <button\n        type=\"button\"\n        title=\"{{ 'Expand' | translate }}\"\n        class=\"collapse-btn\"\n        [ngClass]=\"{ active: isDetailOpen }\"\n      >\n        <i c8yIcon=\"chevron-down\"></i>\n      </button>\n    </div>\n\n    <div class=\"list-item-icon\">\n      <i c8yIcon=\"sliders\"></i>\n    </div>\n\n    <div class=\"list-item-body\">\n      <div class=\"row flex-row\">\n        <div class=\"col-sm-7 col-xs-12\">\n          <p>\n            {{ nodeDisplayName }}<br />\n            <small\n              *ngIf=\"mapping.browsePath.length > 0\"\n              class=\"text-muted text-truncate\"\n              title=\"{{ mapping.browsePath | json }}\"\n              >{{ mapping.browsePath | json }}</small\n            >\n          </p>\n          <p></p>\n        </div>\n        <div class=\"col-sm-4 col-xs-10\">\n          <div class=\"list-functionalities\">\n            <label class=\"small m-r-8 hidden-xs\" translate>Functionalities</label>&nbsp;\n            <c8y-object-mapping-status-icons [mapping]=\"mapping\"></c8y-object-mapping-status-icons>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class=\"detail\" [collapse]=\"!isDetailOpen\" [isAnimated]=\"true\">\n    <div class=\"form\" [ngModelGroup]=\"index\" #variableForm=\"ngModelGroup\" *ngIf=\"isDetailOpen\">\n      <div class=\"row p-t-8\">\n        <c8y-form-group class=\"col-md-4\" [status]=\"!isBrowsePathUniq ? 'error' : ''\">\n          <label translate>Path</label>\n          <div\n            class=\"dropdown\"\n            dropdown\n            #dropdown=\"bs-dropdown\"\n            [insideClick]=\"true\"\n            style=\"width:100%;\"\n          >\n            <input\n              class=\"form-control\"\n              c8yBrowsePathValidator\n              [getMappings]=\"getMappings\"\n              [model]=\"mapping\"\n              type=\"text\"\n              name=\"browsePath\"\n              dropdownToggle\n              placeholder=\"{{ 'e.g.' | translate }} {{ ['2:Node1', '2:SubNode1'] | json }}\"\n              [(ngModel)]=\"browsePath\"\n              (change)=\"updateBrowsePathInput()\"\n              (focus)=\"setTreeFromRefNode()\"\n              required\n              #browsePathModel=\"ngModel\"\n              autocomplete=\"off\"\n            />\n            <div\n              *dropdownMenu\n              class=\"dropdown-menu panel-inner-scroll\"\n              style=\"max-height:200px; width: 100%;\"\n            >\n              <opcua-address-space-tree\n                *ngIf=\"showAddressSpaceTree()\"\n                [node]=\"referencedNode\"\n                [moId]=\"referencedServerId\"\n                (selectedNode)=\"updateBrowsePath($event); dropdown.hide()\"\n              ></opcua-address-space-tree>\n            </div>\n          </div>\n          <c8y-messages>\n            <c8y-message\n              name=\"invalidBrowsePathNotation\"\n              text=\"{{ 'Must be a valid array of strings.' | translate }}\"\n            ></c8y-message>\n            <c8y-message\n              name=\"browsePathNotUnique\"\n              text=\"{{ 'Variable with this path is already added.' | translate }}\"\n            ></c8y-message>\n          </c8y-messages>\n        </c8y-form-group>\n\n        <c8y-form-group class=\"col-md-4\">\n          <label translate>Name</label>\n          <div class=\"input-group\">\n            <input\n              class=\"form-control\"\n              type=\"test\"\n              name=\"displayName\"\n              placeholder=\"{{ 'e.g. childDevice2' | translate }} \"\n              required\n              [(ngModel)]=\"nodeDisplayName\"\n              (change)=\"updateDisplayname()\"\n              autocomplete=\"off\"\n            />\n          </div>\n        </c8y-form-group>\n      </div>\n      <div class=\"row\" ngModelGroup=\"dataReportingSection\">\n        <c8y-form-group class=\"col-sm-4 col-md-3 col-lg-2\">\n          <label>\n            <span translate>Data reporting</span>\n          </label>\n          <div class=\"input-group\">\n            <label title=\"{{ 'Default' | translate }}\" class=\"c8y-radio radio-inline\">\n              <input\n                type=\"radio\"\n                [(ngModel)]=\"dataReporting\"\n                name=\"{{ dataReportingName }}\"\n                value=\"default\"\n              />\n              <span></span>\n              <span>{{ 'Default' | translate }}</span>\n            </label>\n            <label title=\"{{ 'Custom' | translate }}\" class=\"c8y-radio radio-inline\">\n              <input\n                type=\"radio\"\n                [(ngModel)]=\"dataReporting\"\n                name=\"{{ dataReportingName }}\"\n                value=\"custom\"\n              />\n              <span></span>\n              <span>{{ 'Custom' | translate }}</span>\n            </label>\n          </div>\n        </c8y-form-group>\n        <div\n          class=\"col-sm-8 col-md-9 col-lg-10\"\n          *ngIf=\"dataReporting === 'custom'\"\n          ngModelGroup=\"overriddenSubscription\"\n        >\n          <opcua-device-protocol-data-reporting\n            [model]=\"mapping\"\n          ></opcua-device-protocol-data-reporting>\n        </div>\n      </div>\n\n      <c8y-object-mapping [mapping]=\"mapping\" [hideAutoObserve]=\"true\"></c8y-object-mapping>\n      <div ngModelGroup=\"customAction\">\n        <opcua-device-protocol-mapping-customaction\n          [customAction]=\"customAction\"\n        ></opcua-device-protocol-mapping-customaction>\n      </div>\n      <button\n        title=\"{{ 'Cancel' | translate }}\"\n        id=\"cancelBtn\"\n        class=\"btn btn-default m-t-16 m-b-16\"\n        (click)=\"cancel()\"\n      >\n        {{ 'Cancel' | translate }}\n      </button>\n      <button\n        title=\"{{ 'Save' | translate }}\"\n        id=\"saveBtn\"\n        class=\"btn btn-primary m-t-16 m-b-16\"\n        (click)=\"save()\"\n        [disabled]=\"!canSave(variableForm)\"\n      >\n        {{ 'Save' | translate }}\n      </button>\n    </div>\n  </div>\n</div>\n",
        viewProviders: [{ provide: ControlContainer, useExisting: NgModelGroup }]
    })
], OpcuaDeviceProtocolMapping);
export { OpcuaDeviceProtocolMapping };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BjdWEtZGV2aWNlLXByb3RvY29sLW1hcHBpbmcuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGM4eS9uZ3gtY29tcG9uZW50cy9wcm90b2NvbC1vcGN1YS8iLCJzb3VyY2VzIjpbIm9wY3VhLWRldmljZS1wcm90b2NvbC1tYXBwaW5nLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFFVCxZQUFZLEVBQ1osS0FBSyxFQUNMLE1BQU0sRUFDTixTQUFTLEVBR1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFVLGdCQUFnQixFQUFlLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JGLE9BQU8sRUFBRSxZQUFZLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDNUQsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQWdCLFNBQVMsRUFBRSxPQUFPLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDL0YsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sa0RBQWtELENBQUM7QUFDcEcsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFPOUQsSUFBYSwwQkFBMEIsR0FBdkMsTUFBYSwwQkFBMEI7SUE0QnJDLFlBQ1UsWUFBMEIsRUFDMUIsbUJBQXdDO1FBRHhDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBQzFCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFwQnhDLGFBQVEsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQU9oRSxrQkFBYSxHQUFHLEtBQUssQ0FBQztRQUl0QixxQkFBZ0IsR0FBRyxJQUFJLENBQUM7UUFDeEIsa0JBQWEsR0FBRyxTQUFTLENBQUM7UUFDMUIsZUFBVSxHQUFHLEtBQUssQ0FBQztRQUNuQixVQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ2QsZUFBVSxHQUFHLEtBQUss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QUNaLFFBQVEsRUFBRSxLQUFLO29CQUNmLGFBQWEsRUFBRSxDQUFDLEVBQUUsQ0FBQztpQkFDcEI7Z0JBQ0QsbUJBQW1CLEVBQUUsRUFBRTthQUN4QixDQUFDLENBQUM7U0FDSjtJQUNILENBQUM7Q0FDRixDQUFBOztZQXZNeUIsWUFBWTtZQUNMLG1CQUFtQjs7QUE3QmM7SUFBL0QsU0FBUyxDQUFDLGdDQUFnQyxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDO3FFQUF3QjtBQUN6QztJQUE3QyxTQUFTLENBQUMsY0FBYyxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxDQUFDOzhEQUFpQjtBQUNiO0lBQWhELFNBQVMsQ0FBQyxpQkFBaUIsRUFBRSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQzttRUFBc0I7QUFFbkQ7SUFBbEIsS0FBSyxDQUFDLFVBQVUsQ0FBQzswREFBUTtBQUNqQjtJQUFSLEtBQUssRUFBRTt5REFBTztBQUNOO0lBQVIsS0FBSyxFQUFFO2lFQUFlO0FBQ2Q7SUFBUixLQUFLLEVBQUU7c0VBQW9CO0FBQ25CO0lBQVIsS0FBSyxFQUFFO3dFQUFzQjtBQUNwQjtJQUFULE1BQU0sRUFBRTs0REFBdUQ7QUFWckQsMEJBQTBCO0lBTHRDLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSwrQkFBK0I7UUFDekMsNDNNQUFtRDtRQUNuRCxhQUFhLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLENBQUM7S0FDMUUsQ0FBQztHQUNXLDBCQUEwQixDQW9PdEM7U0FwT1ksMEJBQTBCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBPbkluaXQsXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIE91dHB1dCxcbiAgVmlld0NoaWxkLFxuICBPbkNoYW5nZXMsXG4gIFNpbXBsZUNoYW5nZXNcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBOZ0Zvcm0sIENvbnRyb2xDb250YWluZXIsIEZvcm1Db250cm9sLCBOZ01vZGVsR3JvdXAgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBBbGVydFNlcnZpY2UsIGdldHRleHQgfSBmcm9tICdAYzh5L25neC1jb21wb25lbnRzJztcbmltcG9ydCB7IGlzRW1wdHksIGFzc2lnbiwgdW5zZXQsIGdldCwgc2V0LCByZWplY3QsIGZpbmQsIGNsb25lRGVlcCwgaXNFcXVhbCB9IGZyb20gJ2xvZGFzaC1lcyc7XG5pbXBvcnQgeyBPcGN1YURldmljZVByb3RvY29sT2JqZWN0TWFwcGluZyB9IGZyb20gJy4vb3BjdWEtZGV2aWNlLXByb3RvY29sLW9iamVjdC1tYXBwaW5nLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBBZGRyZXNzU3BhY2VTZXJ2aWNlIH0gZnJvbSAnLi9hZGRyZXNzLXNwYWNlLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdvcGN1YS1kZXZpY2UtcHJvdG9jb2wtbWFwcGluZycsXG4gIHRlbXBsYXRlVXJsOiAnLi9vcGN1YS1kZXZpY2UtcHJvdG9jb2wtbWFwcGluZy5odG1sJyxcbiAgdmlld1Byb3ZpZGVyczogW3sgcHJvdmlkZTogQ29udHJvbENvbnRhaW5lciwgdXNlRXhpc3Rpbmc6IE5nTW9kZWxHcm91cCB9XVxufSlcbmV4cG9ydCBjbGFzcyBPcGN1YURldmljZVByb3RvY29sTWFwcGluZyBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcbiAgQFZpZXdDaGlsZChPcGN1YURldmljZVByb3RvY29sT2JqZWN0TWFwcGluZywgeyBzdGF0aWM6IGZhbHNlIH0pIG9iamVjdE1hcHBpbmdGb3JtOiBhbnk7XG4gIEBWaWV3Q2hpbGQoJ3ZhcmlhYmxlRm9ybScsIHsgc3RhdGljOiBmYWxzZSB9KSBzdWJGb3JtUmVmOiBhbnk7XG4gIEBWaWV3Q2hpbGQoJ2Jyb3dzZVBhdGhNb2RlbCcsIHsgc3RhdGljOiBmYWxzZSB9KSBicm93c2VQYXRoTW9kZWw6IGFueTtcblxuICBASW5wdXQoJ3Jlc291cmNlJykgX21vZGVsO1xuICBASW5wdXQoKSBpbmRleDtcbiAgQElucHV0KCkgZ2V0UGFyZW50QXR0cjtcbiAgQElucHV0KCkgcmVmZXJlbmNlZFNlcnZlcklkO1xuICBASW5wdXQoKSByZWZlcmVuY2VkUm9vdE5vZGVJZDtcbiAgQE91dHB1dCgpIG9uQWN0aW9uOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIG1hcHBpbmc7XG5cbiAgaXNEZXRhaWxPcGVuO1xuICBjdXN0b21BY3Rpb247XG4gIHJlZmVyZW5jZWROb2RlO1xuICBpc1BhdGhGb2N1c2VkID0gZmFsc2U7XG4gIGdyb3VwTmFtZTogc3RyaW5nO1xuICBicm93c2VQYXRoOiBzdHJpbmc7XG4gIG5vZGVEaXNwbGF5TmFtZTogc3RyaW5nO1xuICBpc0Jyb3dzZVBhdGhVbmlxID0gdHJ1ZTtcbiAgZGF0YVJlcG9ydGluZyA9ICdkZWZhdWx0JztcbiAgaXNUcmVlT3BlbiA9IGZhbHNlO1xuICBpc05ldyA9IGZhbHNlO1xuICByZXNldE1vZGVsID0gZmFsc2U7XG4gIGRhdGFSZXBvcnRpbmdOYW1lO1xuICBwcml2YXRlIG1vSWQ6IHN0cmluZyA9ICcnO1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFsZXJ0U2VydmljZTogQWxlcnRTZXJ2aWNlLFxuICAgIHByaXZhdGUgYWRkcmVzc1NwYWNlU2VydmljZTogQWRkcmVzc1NwYWNlU2VydmljZVxuICApIHt9XG5cbiAgdG9nZ2xlRGV0YWlsKCkge1xuICAgIHRoaXMuaXNEZXRhaWxPcGVuID0gIXRoaXMuaXNEZXRhaWxPcGVuO1xuICAgIGlmICh0aGlzLnJlc2V0TW9kZWwpIHtcbiAgICAgIHRoaXMuaW5pdGlhbEZvcm1TZXR1cCgpO1xuICAgIH1cbiAgfVxuXG4gIGdldE1hcHBpbmdzID0gKCkgPT4gdGhpcy5nZXRQYXJlbnRBdHRyKCdtYXBwaW5ncycpO1xuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuZGF0YVJlcG9ydGluZ05hbWUgPSAnUmVwb3J0aW5nTW9kZScgKyB0aGlzLmluZGV4O1xuICAgIHRoaXMuaW5pdGlhbEZvcm1TZXR1cCgpO1xuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcykge1xuICAgIGlmIChcbiAgICAgIGNoYW5nZXMuX21vZGVsLnByZXZpb3VzVmFsdWUgJiZcbiAgICAgICFpc0VxdWFsKHRoaXMuX21vZGVsLCBjaGFuZ2VzLl9tb2RlbC5wcmV2aW91c1ZhbHVlLlNpbXBsZUNoYW5nZSlcbiAgICApIHtcbiAgICAgIGlmICh0aGlzLm1hcHBpbmcgJiYgdGhpcy5tYXBwaW5nLm5hbWUgPT09IHRoaXMuX21vZGVsLm5hbWUpIHtcbiAgICAgICAgdGhpcy5tYXBwaW5nLmlkID0gdGhpcy5fbW9kZWwuaWQ7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaW5pdGlhbEZvcm1TZXR1cCgpIHtcbiAgICBjb25zdCBtYXBwaW5nID0ge1xuICAgICAgaWQ6ICcnLFxuICAgICAgYnJvd3NlUGF0aDogW10sXG4gICAgICBuYW1lOiAnJyxcbiAgICAgIHN1YnNjcmlwdGlvblR5cGU6IHtcbiAgICAgICAgdHlwZTogJ05vbmUnXG4gICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IGN1c3RvbUFjdGlvbiA9IHtcbiAgICAgIGhlYWRlcnM6IFt7IGtleTogJ0F1dGhvcml6YXRpb24nLCB2YWx1ZTogJycgfSwgeyBrZXk6ICdDb250ZW50LVR5cGUnLCB2YWx1ZTogJycgfV0sXG4gICAgICBib2R5VGVtcGxhdGU6ICcnLFxuICAgICAgdHlwZTogJ0h0dHBQb3N0JyxcbiAgICAgIGVuZHBvaW50OiAnJ1xuICAgIH07XG5cbiAgICB0aGlzLm1hcHBpbmcgPSBhc3NpZ24oe30sIG1hcHBpbmcsIGNsb25lRGVlcCh0aGlzLl9tb2RlbCkpO1xuXG4gICAgaWYgKGlzRW1wdHkodGhpcy5tYXBwaW5nLmJyb3dzZVBhdGgpKSB7XG4gICAgICB0aGlzLmlzTmV3ID0gdHJ1ZTtcbiAgICAgIHRoaXMuaXNEZXRhaWxPcGVuID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5icm93c2VQYXRoID0gdGhpcy5zdHJpbmdmeUJyb3dzZVBhdGgodGhpcy5tYXBwaW5nLmJyb3dzZVBhdGgpO1xuICAgICAgdGhpcy5ub2RlRGlzcGxheU5hbWUgPSB0aGlzLm1hcHBpbmcubmFtZTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5yZWZlcmVuY2VkUm9vdE5vZGVJZCkge1xuICAgICAgdGhpcy5yZWZlcmVuY2VkTm9kZSA9IHsgbm9kZUlkOiB0aGlzLnJlZmVyZW5jZWRSb290Tm9kZUlkIH07XG4gICAgICB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2UudHJpZ2dlck5vZGVUb09wZW4oe1xuICAgICAgICBub2RlOiB7XG4gICAgICAgICAgbm9kZUlkOiB0aGlzLnJlZmVyZW5jZWRSb290Tm9kZUlkLFxuICAgICAgICAgIGNoaWxkcmVuOiBbXSxcbiAgICAgICAgICBleHBhbmRlZDogZmFsc2UsXG4gICAgICAgICAgYWJzb2x1dGVQYXRoczogW1tdXVxuICAgICAgICB9LFxuICAgICAgICBzZWxlY3RlZEFuY2VzdG9ySWRzOiBbXVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucmVmZXJlbmNlZE5vZGUgPSB7IG5vZGVJZDogJycgfTtcbiAgICB9XG5cbiAgICBpZiAoZ2V0KHRoaXMubWFwcGluZywgJ2N1c3RvbUFjdGlvbicpKSB7XG4gICAgICB0aGlzLmN1c3RvbUFjdGlvbiA9IGFzc2lnbihjdXN0b21BY3Rpb24sIGdldCh0aGlzLm1hcHBpbmcsICdjdXN0b21BY3Rpb24nKSk7XG4gICAgICB0aGlzLmN1c3RvbUFjdGlvbi5oZWFkZXJzID0gdGhpcy5tYXBIZWFkZXJzT2JqZWN0VG9MaXN0KGdldCh0aGlzLmN1c3RvbUFjdGlvbiwgJ2hlYWRlcnMnKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY3VzdG9tQWN0aW9uID0gYXNzaWduKHt9LCBjdXN0b21BY3Rpb24pO1xuICAgIH1cblxuICAgIHVuc2V0KHRoaXMubWFwcGluZywgJ2N1c3RvbUFjdGlvbicpO1xuICAgIGlmIChnZXQodGhpcy5fbW9kZWwsICdzdWJzY3JpcHRpb25UeXBlJykpIHtcbiAgICAgIHRoaXMuZGF0YVJlcG9ydGluZyA9ICdjdXN0b20nO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRhdGFSZXBvcnRpbmcgPSAnZGVmYXVsdCc7XG4gICAgfVxuICAgIHRoaXMucmVzZXRNb2RlbCA9IGZhbHNlO1xuICB9XG5cbiAgc2hvd0FkZHJlc3NTcGFjZVRyZWUoKSB7XG4gICAgcmV0dXJuICFpc0VtcHR5KHRoaXMucmVmZXJlbmNlZFNlcnZlcklkKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICBpZiAoXG4gICAgICBnZXQodGhpcy5tYXBwaW5nLCAnc3Vic2NyaXB0aW9uVHlwZScpICYmXG4gICAgICBnZXQodGhpcy5tYXBwaW5nLCAnc3Vic2NyaXB0aW9uVHlwZS50eXBlJykgIT09ICdOb25lJ1xuICAgICkge1xuICAgICAgdGhpcy5kYXRhUmVwb3J0aW5nID0gJ2N1c3RvbSc7XG4gICAgfVxuICB9XG5cbiAgbWFwSGVhZGVyc09iamVjdFRvTGlzdChoZWFkZXJzKSB7XG4gICAgaWYgKE9iamVjdC5rZXlzKGhlYWRlcnMpLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiBPYmplY3Qua2V5cyhoZWFkZXJzKS5tYXAoaXRlbSA9PiB7XG4gICAgICAgIHJldHVybiB7IGtleTogaXRlbSwgdmFsdWU6IGhlYWRlcnNbaXRlbV0gfTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHN0cmluZ2Z5QnJvd3NlUGF0aChwYXRoKSB7XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHBhdGgpO1xuICB9XG5cbiAgdXBkYXRlQnJvd3NlUGF0aChub2RlKSB7XG4gICAgdGhpcy5tYXBwaW5nLmJyb3dzZVBhdGggPSBub2RlLnJlbGF0aXZlUGF0aDtcbiAgICB0aGlzLm5vZGVEaXNwbGF5TmFtZSA9IG5vZGUuZGlzcGxheU5hbWU7XG4gICAgdGhpcy5tYXBwaW5nLm5hbWUgPSB0aGlzLm5vZGVEaXNwbGF5TmFtZTtcbiAgICB0aGlzLmJyb3dzZVBhdGggPSB0aGlzLnN0cmluZ2Z5QnJvd3NlUGF0aCh0aGlzLm1hcHBpbmcuYnJvd3NlUGF0aCk7XG4gICAgdGhpcy5icm93c2VQYXRoTW9kZWwuY29udHJvbC5tYXJrQXNEaXJ0eSgpO1xuICB9XG5cbiAgdXBkYXRlRGlzcGxheW5hbWUoKSB7XG4gICAgdGhpcy5tYXBwaW5nLm5hbWUgPSB0aGlzLm5vZGVEaXNwbGF5TmFtZTtcbiAgfVxuXG4gIHVwZGF0ZUJyb3dzZVBhdGhJbnB1dCgpIHtcbiAgICBpZiAodGhpcy5icm93c2VQYXRoKSB7XG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLm1hcHBpbmcuYnJvd3NlUGF0aCA9IEpTT04ucGFyc2UodGhpcy5icm93c2VQYXRoKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzYXZlKCkge1xuICAgIGlmICh0aGlzLmRhdGFSZXBvcnRpbmcgPT09ICdkZWZhdWx0Jykge1xuICAgICAgdW5zZXQodGhpcy5tYXBwaW5nLCAnc3Vic2NyaXB0aW9uVHlwZScpO1xuICAgIH1cblxuICAgIGlmIChnZXQodGhpcy5tYXBwaW5nLCAnbWVhc3VyZW1lbnRDcmVhdGlvbicpKSB7XG4gICAgICBjb25zdCB7IG1lYXN1cmVtZW50Q3JlYXRpb24gfSA9IHRoaXMubWFwcGluZztcbiAgICAgIHNldChtZWFzdXJlbWVudENyZWF0aW9uLCAnZnJhZ21lbnROYW1lJywgZ2V0KG1lYXN1cmVtZW50Q3JlYXRpb24sICd0eXBlJykpO1xuICAgIH1cblxuICAgIGNvbnN0IHsgY3VzdG9tQWN0aW9uIH0gPSB0aGlzLnN1YkZvcm1SZWYudmFsdWU7XG4gICAgbGV0IG1vZGlmaWVkQ3VzdG9tQWN0aW9uO1xuICAgIGlmIChjdXN0b21BY3Rpb24uaGFzQ3VzdG9tQWN0aW9uKSB7XG4gICAgICBjb25zdCByZWR1Y2VkSGVhZGVycyA9IHRoaXMuY3VzdG9tQWN0aW9uLmhlYWRlcnMucmVkdWNlKChyZXN1bHQsIGl0ZW0pID0+IHtcbiAgICAgICAgcmVzdWx0W2l0ZW0ua2V5XSA9IGl0ZW0udmFsdWU7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9LCB7fSk7XG5cbiAgICAgIG1vZGlmaWVkQ3VzdG9tQWN0aW9uID0gYXNzaWduKHt9LCB0aGlzLmN1c3RvbUFjdGlvbiwgeyBoZWFkZXJzOiByZWR1Y2VkSGVhZGVycyB9KTtcbiAgICB9XG5cbiAgICB0aGlzLm9uQWN0aW9uLmVtaXQoe1xuICAgICAgYWN0aW9uOiAnc2F2ZScsXG4gICAgICBkYXRhOiBhc3NpZ24oe30sIHRoaXMubWFwcGluZywgeyBjdXN0b21BY3Rpb246IG1vZGlmaWVkQ3VzdG9tQWN0aW9uIH0pXG4gICAgfSk7XG4gICAgdGhpcy5pc0RldGFpbE9wZW4gPSBmYWxzZTtcbiAgfVxuXG4gIGNhbmNlbCgpIHtcbiAgICB0aGlzLmlzRGV0YWlsT3BlbiA9IGZhbHNlO1xuICAgIHRoaXMucmVzZXRNb2RlbCA9IHRydWU7XG4gICAgaWYgKHRoaXMubWFwcGluZy5pZCA9PT0gJ25ldycpIHtcbiAgICAgIHRoaXMub25BY3Rpb24uZW1pdCh7IGFjdGlvbjogJ2RlbGV0ZScsIGRhdGE6IGFzc2lnbih7fSwgdGhpcy5tYXBwaW5nKSB9KTtcbiAgICB9XG4gIH1cblxuICBvbkRlbGV0ZSgpIHtcbiAgICB0aGlzLm9uQWN0aW9uLmVtaXQoeyBhY3Rpb246ICdkZWxldGUnLCBkYXRhOiB0aGlzLm1hcHBpbmcgfSk7XG4gIH1cblxuICBjYW5TYXZlKHZhcmlhYmxlRm9ybSkge1xuICAgIGNvbnN0IGFyZVZhbGlkID0gKCkgPT5cbiAgICAgIHZhcmlhYmxlRm9ybS52YWxpZCAmJiB0aGlzLm9iamVjdE1hcHBpbmdGb3JtLiRjb21wb25lbnRTY29wZS5tYXBwaW5nRm9ybS4kdmFsaWQ7XG4gICAgY29uc3QgYXJlRGlydHkgPSAoKSA9PlxuICAgICAgdmFyaWFibGVGb3JtLmRpcnR5IHx8IHRoaXMub2JqZWN0TWFwcGluZ0Zvcm0uJGNvbXBvbmVudFNjb3BlLm1hcHBpbmdGb3JtLiRkaXJ0eTtcbiAgICByZXR1cm4gYXJlVmFsaWQoKSAmJiBhcmVEaXJ0eSgpO1xuICB9XG5cbiAgaXNBY3RpdmUoKSB7XG4gICAgcmV0dXJuIHRoaXMuaXNEZXRhaWxPcGVuO1xuICB9XG5cbiAgc2V0VHJlZUZyb21SZWZOb2RlKCkge1xuICAgIGlmICh0aGlzLnJlZmVyZW5jZWRSb290Tm9kZUlkKSB7XG4gICAgICB0aGlzLmFkZHJlc3NTcGFjZVNlcnZpY2UudHJpZ2dlck5vZGVUb09wZW4oe1xuICAgICAgICBub2RlOiB7XG4gICAgICAgICAgbm9kZUlkOiB0aGlzLnJlZmVyZW5jZWRSb290Tm9kZUlkLFxuICAgICAgICAgIGNoaWxkcmVuOiBbXSxcbiAgICAgICAgICBleHBhbmRlZDogZmFsc2UsXG4gICAgICAgICAgYWJzb2x1dGVQYXRoczogW1tdXVxuICAgICAgICB9LFxuICAgICAgICBzZWxlY3RlZEFuY2VzdG9ySWRzOiBbXVxuICAgICAgfSk7XG4gICAgfVxuICB9XG59XG4iXX0=