import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import { FormArray, FormBuilder, FormGroup } from '@angular/forms';
import { AlertService, gettext } from '@c8y/ngx-components';
import { DefaultSubscriptionsService } from './default-subscriptions.service';
/**
 * The component shows the main view for managing default subscriptions configuration.
 */
let DefaultSubscriptionsComponent = class DefaultSubscriptionsComponent {
    constructor(fb, defaultSubscriptionsService, alertService) {
        this.fb = fb;
        this.defaultSubscriptionsService = defaultSubscriptionsService;
        this.alertService = alertService;
    }
    /** Initializes the loading of the form and the current settings. */
    ngOnInit() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.loading = true;
            yield this.initForm();
            yield this.loadDefaultSubscriptions();
            this.loading = false;
        });
    }
    /** Loads the list of apps, builds the form and hooks value change events for override switches. */
    initForm() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.form = this.fb.group({
                overrideOnCreationSubscriptions: [''],
                overrideOnUpgradeSubscriptions: [''],
                appRows: this.fb.array([])
            });
            const apps = yield this.defaultSubscriptionsService.getSubscribableTenantApps();
            const appRows = this.form.controls.appRows;
            apps.forEach(app => {
                appRows.push(this.fb.group({
                    app: [app],
                    subscribedOnCreation: [''],
                    subscribedOnUpgrade: ['']
                }));
            });
            this.form
                .get('overrideOnCreationSubscriptions')
                .valueChanges.subscribe(value => this.onOverrideOnCreationSubscriptionsChange(value));
            this.form
                .get('overrideOnUpgradeSubscriptions')
                .valueChanges.subscribe(value => this.onOverrideOnUpgradeSubscriptionsChange(value));
        });
    }
    /**
     * Checks if given application row should be displayed.
     * The row is displayed when any of its checkboxes is selected or any of the lists is being overridden.
     */
    shouldShowAppRow(appRowRawValue) {
        const { subscribedOnCreation, subscribedOnUpgrade } = appRowRawValue;
        const { overrideOnCreationSubscriptions, overrideOnUpgradeSubscriptions } = this.form.value;
        return (subscribedOnCreation ||
            subscribedOnUpgrade ||
            overrideOnCreationSubscriptions ||
            overrideOnUpgradeSubscriptions);
    }
    /** Checks if there are no application rows to be displayed. */
    isEmptyView() {
        return !this.form
            .getRawValue()
            .appRows.some(appRowRawValue => this.shouldShowAppRow(appRowRawValue));
    }
    /**
     * Checks if given application is subscribed (present in the given list of applications).
     * @param app Application object to check.
     * @param subscribedApps The list of application objects to check against.
     * @returns True, if the application is present in the list.
     */
    isSubscribed(app, subscribedApps) {
        return subscribedApps && subscribedApps.some(subscribedApp => subscribedApp.name === app.name);
    }
    /** Saves the current value of form object to backend. */
    save() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const defaultSubscriptions = this.getDefaultSubscriptionsForSave();
                yield this.defaultSubscriptionsService.saveDefaultSubscriptionsToCurrentTenant(defaultSubscriptions);
                this.alertService.success(gettext('Saved.'));
            }
            catch (ex) {
                this.alertService.addServerFailure(ex);
            }
        });
    }
    onOverrideOnCreationSubscriptionsChange(overrideOnCreationSubscriptions) {
        const appRowsControls = this.form.controls.appRows.controls;
        if (overrideOnCreationSubscriptions) {
            this.enableSubscribeOnCreationCheckboxes();
            return;
        }
        this.disableSubscribeOnCreationCheckboxes();
        this.restoreSubscribeOnCreationFromParent();
    }
    enableSubscribeOnCreationCheckboxes() {
        const appRowsControls = this.form.controls.appRows.controls;
        appRowsControls.forEach(appRowControl => {
            appRowControl.get('subscribedOnCreation').enable({ emitEvent: false });
        });
    }
    disableSubscribeOnCreationCheckboxes() {
        const appRowsControls = this.form.controls.appRows.controls;
        appRowsControls.forEach(appRowControl => {
            appRowControl.get('subscribedOnCreation').disable({ emitEvent: false });
        });
    }
    restoreSubscribeOnCreationFromParent() {
        const appRowsControls = this.form.controls.appRows.controls;
        appRowsControls.forEach(appRowControl => {
            appRowControl.patchValue({
                subscribedOnCreation: this.isSubscribed(appRowControl.value.app, this.parentDefaultSubscriptions.onCreationSubscriptions)
            });
        });
    }
    onOverrideOnUpgradeSubscriptionsChange(overrideOnUpgradeSubscriptions) {
        const appRowsControls = this.form.controls.appRows.controls;
        if (overrideOnUpgradeSubscriptions) {
            this.enableSubscribeOnUpgradeCheckboxes();
            return;
        }
        this.disableSubscribeOnUpgradeCheckboxes();
        this.restoreSubscribeOnUpgradeFromParent();
    }
    enableSubscribeOnUpgradeCheckboxes() {
        const appRowsControls = this.form.controls.appRows.controls;
        appRowsControls.forEach(appRowControl => {
            appRowControl.get('subscribedOnUpgrade').enable({ emitEvent: false });
        });
    }
    disableSubscribeOnUpgradeCheckboxes() {
        const appRowsControls = this.form.controls.appRows.controls;
        appRowsControls.forEach(appRowControl => {
            appRowControl.get('subscribedOnUpgrade').disable({ emitEvent: false });
        });
    }
    restoreSubscribeOnUpgradeFromParent() {
        const appRowsControls = this.form.controls.appRows.controls;
        appRowsControls.forEach(appRowControl => {
            appRowControl.patchValue({
                subscribedOnUpgrade: this.isSubscribed(appRowControl.value.app, this.parentDefaultSubscriptions.onUpgradeSubscriptions)
            });
        });
    }
    loadDefaultSubscriptions() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this.parentDefaultSubscriptions = yield this.defaultSubscriptionsService.getDefaultSubscriptionsEvaluatedFromParentTenant();
            this.currentDefaultSubscriptions = yield this.defaultSubscriptionsService.getDefaultSubscriptionsFromCurrentTenant();
            const { overrideOnCreationSubscriptions, overrideOnUpgradeSubscriptions } = this.currentDefaultSubscriptions;
            const onCreationSubscriptions = overrideOnCreationSubscriptions
                ? this.currentDefaultSubscriptions.onCreationSubscriptions
                : this.parentDefaultSubscriptions.onCreationSubscriptions;
            const onUpgradeSubscriptions = overrideOnUpgradeSubscriptions
                ? this.currentDefaultSubscriptions.onUpgradeSubscriptions
                : this.parentDefaultSubscriptions.onUpgradeSubscriptions;
            this.form.patchValue({
                overrideOnCreationSubscriptions,
                overrideOnUpgradeSubscriptions
            });
            this.form.controls.appRows.controls.forEach(appRowControl => {
                appRowControl.patchValue({
                    subscribedOnCreation: this.isSubscribed(appRowControl.value.app, onCreationSubscriptions),
                    subscribedOnUpgrade: this.isSubscribed(appRowControl.value.app, onUpgradeSubscriptions)
                });
            });
        });
    }
    getDefaultSubscriptionsForSave() {
        const { value } = this.form;
        return {
            overrideOnCreationSubscriptions: value.overrideOnCreationSubscriptions,
            onCreationSubscriptions: value.overrideOnCreationSubscriptions
                ? value.appRows.filter(app => app.subscribedOnCreation).map(app => app.app)
                : null,
            overrideOnUpgradeSubscriptions: value.overrideOnUpgradeSubscriptions,
            onUpgradeSubscriptions: value.overrideOnUpgradeSubscriptions
                ? value.appRows.filter(app => app.subscribedOnUpgrade).map(app => app.app)
                : null
        };
    }
};
DefaultSubscriptionsComponent.ctorParameters = () => [
    { type: FormBuilder },
    { type: DefaultSubscriptionsService },
    { type: AlertService }
];
DefaultSubscriptionsComponent = tslib_1.__decorate([
    Component({
        selector: 'c8y-default-subscriptions',
        template: "<c8y-title>{{ 'Default subscriptions' | translate }}</c8y-title>\n\n<form [formGroup]=\"form\" (ngSubmit)=\"save()\">\n  <div class=\"card card--fullpage\">\n    <div class=\"card-header separator\">\n      <h4 class=\"card-title\" translate>Default subscriptions</h4>\n    </div>\n    <div class=\"inner-scroll\">\n      <div class=\"card--grid grid__col--2-8-2--md grid__col--3-6-3\">\n        <div class=\"card-block large-padding bg-gray-white sticky-top separator-bottom p-b-0\">\n          <p><strong translate>Applications subscribed to a tenant on creation</strong></p>\n          <div class=\"text-center\">\n            <label class=\"c8y-switch\">\n              <input type=\"checkbox\" formControlName=\"overrideOnCreationSubscriptions\" />\n              <span></span> {{ 'Override inherited' | translate }}\n            </label>\n          </div>\n        </div>\n        <div class=\"card-block bg-white sticky-top separator-bottom\">\n          <p><b translate>Applications</b></p>\n          <p translate>\n            Configure default subscriptions in the platform, both for tenant creation and for platform upgrade. To display a full list of available applications, override inherited settings.\n          </p>\n        </div>\n        <div class=\"card-block large-padding bg-gray-white sticky-top separator-bottom p-b-0\">\n          <p><strong translate>Applications subscribed to a tenant on platform upgrade</strong></p>\n          <div class=\"text-center\">\n            <label class=\"c8y-switch\">\n              <input type=\"checkbox\" formControlName=\"overrideOnUpgradeSubscriptions\" />\n              <span></span> {{ 'Override inherited' | translate }}\n            </label>\n          </div>\n        </div>\n        <div class=\"card-block bg-gray-white\" *ngIf=\"loading\"></div>\n        <div class=\"card-block bg-white\" *ngIf=\"loading\">\n          <div class=\"p-r-48 p-b-24 d-inline-block p-relative\">\n            <div class=\"spinner\">\n              <div class=\"rect1\"></div>\n              <div class=\"rect2\"></div>\n              <div class=\"rect3\"></div>\n              <div class=\"rect4\"></div>\n              <div class=\"rect5\"></div>\n            </div>\n          </div>\n          <span translate>Loading application subscriptions\u2026</span>\n        </div>\n        <div class=\"card-block bg-gray-white\" *ngIf=\"loading\"></div>\n        <ng-container formArrayName=\"appRows\" class=\"d-contents\">\n          <div class=\"bg-gray-white\" *ngIf=\"!loading && isEmptyView()\"></div>\n          <div class=\"card-block bg-white\" *ngIf=\"!loading && isEmptyView()\">\n            <div class=\"c8y-empty-state\">\n              <h1 class=\"c8y-icon c8y-icon-c8y-data c8y-icon-duocolor\"></h1>\n              <h3 translate>No application subscriptions yet.</h3>\n              <p translate>\n                Select \"Override inherited\" to define the list of subscribed applications.\n              </p>\n            </div>\n          </div>\n          <div class=\"bg-gray-white\" *ngIf=\"!loading && isEmptyView()\"></div>\n\n          <div\n            *ngFor=\"let appRowControl of form.get('appRows')['controls']; let i = index\"\n            class=\"d-contents\"\n          >\n            <ng-container\n              *ngIf=\"shouldShowAppRow(appRowControl.getRawValue())\"\n              formArrayName=\"{{ i }}\"\n              class=\"d-contents\"\n            >\n              <div class=\"c8y-list__item d-flex d-col bg-gray-white text-center\">\n                <div class=\"flex-item-middle\">\n                  <label\n                    class=\"c8y-checkbox d-inline-block\"\n                    [ngClass]=\"{ disabled: appRowControl.controls.subscribedOnCreation.disabled }\"\n                  >\n                    <input type=\"checkbox\" formControlName=\"subscribedOnCreation\" />\n                    <span></span>\n                  </label>\n                </div>\n              </div>\n\n              <div class=\"c8y-list__item bg-white\">\n                <div class=\"c8y-list__item__block\">\n                  <div class=\"c8y-list__item__appicon\">\n                    <c8y-app-icon\n                      [app]=\"appRowControl.value.app\"\n                      [name]=\"appRowControl.value.app.name\"\n                      [contextPath]=\"appRowControl.value.app.contextPath\"\n                    ></c8y-app-icon>\n                  </div>\n                  <div class=\"c8y-list__item__body\">\n                    <div class=\"content-flex-50\">\n                      <div class=\"col-6\">\n                        <p\n                          class=\"text-truncate\"\n                          title=\"{{ appRowControl.value.app | humanizeAppName | async }}\"\n                        >\n                          {{ appRowControl.value.app | humanizeAppName | async }}\n                        </p>\n                        <small class=\"text-muted\">{{ appRowControl.value.app.contextPath }}</small>\n                      </div>\n                      <div class=\"col-6\">\n                        <p>\n                          <span class=\"text-label-small m-r-4\" translate>\n                            Tenant ID\n                          </span>\n                          {{ appRowControl.value.app.owner.tenant.id }}\n                        </p>\n                        <!-- TODO: uncomment when company name is available\n                          <p>\n                          <span class=\"text-label-small m-r-4\" translate>Company</span>\n                          <small class=\"text-muted\">company name</small>\n                        </p> -->\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n              <div class=\"c8y-list__item d-flex d-col bg-gray-white text-center\">\n                <div class=\"flex-item-middle\">\n                  <label\n                    class=\"c8y-checkbox d-inline-block\"\n                    [ngClass]=\"{ disabled: appRowControl.controls.subscribedOnUpgrade.disabled }\"\n                  >\n                    <input type=\"checkbox\" formControlName=\"subscribedOnUpgrade\" />\n                    <span></span>\n                  </label>\n                </div>\n              </div>\n            </ng-container>\n          </div>\n        </ng-container>\n      </div>\n    </div>\n    <div class=\"card-footer separator\">\n      <button\n        type=\"submit\"\n        class=\"btn btn-primary\"\n        [disabled]=\"form.invalid || form.pristine\"\n        title=\"{{ 'Save default subscriptions' | translate }}\"\n      >\n        {{ 'Save' | translate }}\n      </button>\n    </div>\n  </div>\n</form>\n"
    })
], DefaultSubscriptionsComponent);
export { DefaultSubscriptionsComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1zdWJzY3JpcHRpb25zLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BjOHkvbmd4LWNvbXBvbmVudHMvZGVmYXVsdC1zdWJzY3JpcHRpb25zLyIsInNvdXJjZXMiOlsiZGVmYXVsdC1zdWJzY3JpcHRpb25zLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxQyxPQUFPLEVBQUUsU0FBUyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVuRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRTVELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBRTlFOztHQUVHO0FBS0gsSUFBYSw2QkFBNkIsR0FBMUMsTUFBYSw2QkFBNkI7SUFVeEMsWUFDVSxFQUFlLEVBQ2YsMkJBQXdELEVBQ3hELFlBQTBCO1FBRjFCLE9BQUUsR0FBRixFQUFFLENBQWE7UUFDZixnQ0FBMkIsR0FBM0IsMkJBQTJCLENBQTZCO1FBQ3hELGlCQUFZLEdBQVosWUFBWSxDQUFjO0lBQ2pDLENBQUM7SUFFSixvRUFBb0U7SUFDOUQsUUFBUTs7WUFDWixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztZQUNwQixNQUFNLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUN0QixNQUFNLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO1lBQ3RDLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLENBQUM7S0FBQTtJQUVELG1HQUFtRztJQUM3RixRQUFROztZQUNaLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUM7Z0JBQ3hCLCtCQUErQixFQUFFLENBQUMsRUFBRSxDQUFDO2dCQUNyQyw4QkFBOEIsRUFBRSxDQUFDLEVB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QUMsR0FBRyxFQUFFLHNCQUFzQixDQUFDO2lCQUN4RixDQUFDLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7S0FBQTtJQUVPLDhCQUE4QjtRQUNwQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUM1QixPQUFPO1lBQ0wsK0JBQStCLEVBQUUsS0FBSyxDQUFDLCtCQUErQjtZQUN0RSx1QkFBdUIsRUFBRSxLQUFLLENBQUMsK0JBQStCO2dCQUM1RCxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO2dCQUMzRSxDQUFDLENBQUMsSUFBSTtZQUNSLDhCQUE4QixFQUFFLEtBQUssQ0FBQyw4QkFBOEI7WUFDcEUsc0JBQXNCLEVBQUUsS0FBSyxDQUFDLDhCQUE4QjtnQkFDMUQsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztnQkFDMUUsQ0FBQyxDQUFDLElBQUk7U0FDVCxDQUFDO0lBQ0osQ0FBQztDQUNGLENBQUE7O1lBeE1lLFdBQVc7WUFDYywyQkFBMkI7WUFDMUMsWUFBWTs7QUFiekIsNkJBQTZCO0lBSnpDLFNBQVMsQ0FBQztRQUNULFFBQVEsRUFBRSwyQkFBMkI7UUFDckMsZ3BOQUFxRDtLQUN0RCxDQUFDO0dBQ1csNkJBQTZCLENBbU56QztTQW5OWSw2QkFBNkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEZvcm1BcnJheSwgRm9ybUJ1aWxkZXIsIEZvcm1Hcm91cCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IElBcHBsaWNhdGlvbiB9IGZyb20gJ0BjOHkvY2xpZW50JztcbmltcG9ydCB7IEFsZXJ0U2VydmljZSwgZ2V0dGV4dCB9IGZyb20gJ0BjOHkvbmd4LWNvbXBvbmVudHMnO1xuaW1wb3J0IHsgRGVmYXVsdFN1YnNjcmlwdGlvbnMsIFBhcnRpYWxBcHBzTGlzdCB9IGZyb20gJy4vZGVmYXVsdC1zdWJzY3JpcHRpb25zLm1vZGVsJztcbmltcG9ydCB7IERlZmF1bHRTdWJzY3JpcHRpb25zU2VydmljZSB9IGZyb20gJy4vZGVmYXVsdC1zdWJzY3JpcHRpb25zLnNlcnZpY2UnO1xuXG4vKipcbiAqIFRoZSBjb21wb25lbnQgc2hvd3MgdGhlIG1haW4gdmlldyBmb3IgbWFuYWdpbmcgZGVmYXVsdCBzdWJzY3JpcHRpb25zIGNvbmZpZ3VyYXRpb24uXG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2M4eS1kZWZhdWx0LXN1YnNjcmlwdGlvbnMnLFxuICB0ZW1wbGF0ZVVybDogJy4vZGVmYXVsdC1zdWJzY3JpcHRpb25zLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBEZWZhdWx0U3Vic2NyaXB0aW9uc0NvbXBvbmVudCB7XG4gIC8qKiBEZWZhdWx0IHN1YnNjcmlwdGlvbnMgaW5oZXJpdGVkIGZyb20gcGFyZW50IHRlbmFudC4gKi9cbiAgcGFyZW50RGVmYXVsdFN1YnNjcmlwdGlvbnM6IERlZmF1bHRTdWJzY3JpcHRpb25zO1xuICAvKiogRGVmYXVsdCBzdWJzY3JpcHRpb25zIGRlZmluZWQgaW4gdGhlIGN1cnJlbnQgdGVuYW50LiAqL1xuICBjdXJyZW50RGVmYXVsdFN1YnNjcmlwdGlvbnM6IERlZmF1bHRTdWJzY3JpcHRpb25zO1xuICAvKiogRm9ybSBvYmplY3QuICovXG4gIGZvcm06IEZvcm1Hcm91cDtcbiAgLyoqIFdoZXRoZXIgdGhlIGNvbmZpZ3VyYXRpb24gaXMgYmVpbmcgbG9hZGVkLiAqL1xuICBsb2FkaW5nOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZmI6IEZvcm1CdWlsZGVyLFxuICAgIHByaXZhdGUgZGVmYXVsdFN1YnNjcmlwdGlvbnNTZXJ2aWNlOiBEZWZhdWx0U3Vic2NyaXB0aW9uc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBhbGVydFNlcnZpY2U6IEFsZXJ0U2VydmljZVxuICApIHt9XG5cbiAgLyoqIEluaXRpYWxpemVzIHRoZSBsb2FkaW5nIG9mIHRoZSBmb3JtIGFuZCB0aGUgY3VycmVudCBzZXR0aW5ncy4gKi9cbiAgYXN5bmMgbmdPbkluaXQoKSB7XG4gICAgdGhpcy5sb2FkaW5nID0gdHJ1ZTtcbiAgICBhd2FpdCB0aGlzLmluaXRGb3JtKCk7XG4gICAgYXdhaXQgdGhpcy5sb2FkRGVmYXVsdFN1YnNjcmlwdGlvbnMoKTtcbiAgICB0aGlzLmxvYWRpbmcgPSBmYWxzZTtcbiAgfVxuXG4gIC8qKiBMb2FkcyB0aGUgbGlzdCBvZiBhcHBzLCBidWlsZHMgdGhlIGZvcm0gYW5kIGhvb2tzIHZhbHVlIGNoYW5nZSBldmVudHMgZm9yIG92ZXJyaWRlIHN3aXRjaGVzLiAqL1xuICBhc3luYyBpbml0Rm9ybSgpIHtcbiAgICB0aGlzLmZvcm0gPSB0aGlzLmZiLmdyb3VwKHtcbiAgICAgIG92ZXJyaWRlT25DcmVhdGlvblN1YnNjcmlwdGlvbnM6IFsnJ10sXG4gICAgICBvdmVycmlkZU9uVXBncmFkZVN1YnNjcmlwdGlvbnM6IFsnJ10sXG4gICAgICBhcHBSb3dzOiB0aGlzLmZiLmFycmF5KFtdKVxuICAgIH0pO1xuXG4gICAgY29uc3QgYXBwcyA9IGF3YWl0IHRoaXMuZGVmYXVsdFN1YnNjcmlwdGlvbnNTZXJ2aWNlLmdldFN1YnNjcmliYWJsZVRlbmFudEFwcHMoKTtcbiAgICBjb25zdCBhcHBSb3dzID0gdGhpcy5mb3JtLmNvbnRyb2xzLmFwcFJvd3MgYXMgRm9ybUFycmF5O1xuICAgIGFwcHMuZm9yRWFjaChhcHAgPT4ge1xuICAgICAgYXBwUm93cy5wdXNoKFxuICAgICAgICB0aGlzLmZiLmdyb3VwKHtcbiAgICAgICAgICBhcHA6IFthcHBdLFxuICAgICAgICAgIHN1YnNjcmliZWRPbkNyZWF0aW9uOiBbJyddLFxuICAgICAgICAgIHN1YnNjcmliZWRPblVwZ3JhZGU6IFsnJ11cbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICB0aGlzLmZvcm1cbiAgICAgIC5nZXQoJ292ZXJyaWRlT25DcmVhdGlvblN1YnNjcmlwdGlvbnMnKVxuICAgICAgLnZhbHVlQ2hhbmdlcy5zdWJzY3JpYmUodmFsdWUgPT4gdGhpcy5vbk92ZXJyaWRlT25DcmVhdGlvblN1YnNjcmlwdGlvbnNDaGFuZ2UodmFsdWUpKTtcblxuICAgIHRoaXMuZm9ybVxuICAgICAgLmdldCgnb3ZlcnJpZGVPblVwZ3JhZGVTdWJzY3JpcHRpb25zJylcbiAgICAgIC52YWx1ZUNoYW5nZXMuc3Vic2NyaWJlKHZhbHVlID0+IHRoaXMub25PdmVycmlkZU9uVXBncmFkZVN1YnNjcmlwdGlvbnNDaGFuZ2UodmFsdWUpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYgZ2l2ZW4gYXBwbGljYXRpb24gcm93IHNob3VsZCBiZSBkaXNwbGF5ZWQuXG4gICAqIFRoZSByb3cgaXMgZGlzcGxheWVkIHdoZW4gYW55IG9mIGl0cyBjaGVja2JveGVzIGlzIHNlbGVjdGVkIG9yIGFueSBvZiB0aGUgbGlzdHMgaXMgYmVpbmcgb3ZlcnJpZGRlbi5cbiAgICovXG4gIHNob3VsZFNob3dBcHBSb3coYXBwUm93UmF3VmFsdWUpOiBib29sZWFuIHtcbiAgICBjb25zdCB7IHN1YnNjcmliZWRPbkNyZWF0aW9uLCBzdWJzY3JpYmVkT25VcGdyYWRlIH0gPSBhcHBSb3dSYXdWYWx1ZTtcbiAgICBjb25zdCB7IG92ZXJyaWRlT25DcmVhdGlvblN1YnNjcmlwdGlvbnMsIG92ZXJyaWRlT25VcGdyYWRlU3Vic2NyaXB0aW9ucyB9ID0gdGhpcy5mb3JtLnZhbHVlO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIHN1YnNjcmliZWRPbkNyZWF0aW9uIHx8XG4gICAgICBzdWJzY3JpYmVkT25VcGdyYWRlIHx8XG4gICAgICBvdmVycmlkZU9uQ3JlYXRpb25TdWJzY3JpcHRpb25zIHx8XG4gICAgICBvdmVycmlkZU9uVXBncmFkZVN1YnNjcmlwdGlvbnNcbiAgICApO1xuICB9XG5cbiAgLyoqIENoZWNrcyBpZiB0aGVyZSBhcmUgbm8gYXBwbGljYXRpb24gcm93cyB0byBiZSBkaXNwbGF5ZWQuICovXG4gIGlzRW1wdHlWaWV3KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhdGhpcy5mb3JtXG4gICAgICAuZ2V0UmF3VmFsdWUoKVxuICAgICAgLmFwcFJvd3Muc29tZShhcHBSb3dSYXdWYWx1ZSA9PiB0aGlzLnNob3VsZFNob3dBcHBSb3coYXBwUm93UmF3VmFsdWUpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYgZ2l2ZW4gYXBwbGljYXRpb24gaXMgc3Vic2NyaWJlZCAocHJlc2VudCBpbiB0aGUgZ2l2ZW4gbGlzdCBvZiBhcHBsaWNhdGlvbnMpLlxuICAgKiBAcGFyYW0gYXBwIEFwcGxpY2F0aW9uIG9iamVjdCB0byBjaGVjay5cbiAgICogQHBhcmFtIHN1YnNjcmliZWRBcHBzIFRoZSBsaXN0IG9mIGFwcGxpY2F0aW9uIG9iamVjdHMgdG8gY2hlY2sgYWdhaW5zdC5cbiAgICogQHJldHVybnMgVHJ1ZSwgaWYgdGhlIGFwcGxpY2F0aW9uIGlzIHByZXNlbnQgaW4gdGhlIGxpc3QuXG4gICAqL1xuICBpc1N1YnNjcmliZWQoYXBwOiBJQXBwbGljYXRpb24sIHN1YnNjcmliZWRBcHBzOiBQYXJ0aWFsQXBwc0xpc3QpOiBib29sZWFuIHtcbiAgICByZXR1cm4gc3Vic2NyaWJlZEFwcHMgJiYgc3Vic2NyaWJlZEFwcHMuc29tZShzdWJzY3JpYmVkQXBwID0+IHN1YnNjcmliZWRBcHAubmFtZSA9PT0gYXBwLm5hbWUpO1xuICB9XG5cbiAgLyoqIFNhdmVzIHRoZSBjdXJyZW50IHZhbHVlIG9mIGZvcm0gb2JqZWN0IHRvIGJhY2tlbmQuICovXG4gIGFzeW5jIHNhdmUoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRlZmF1bHRTdWJzY3JpcHRpb25zID0gdGhpcy5nZXREZWZhdWx0U3Vic2NyaXB0aW9uc0ZvclNhdmUoKTtcbiAgICAgIGF3YWl0IHRoaXMuZGVmYXVsdFN1YnNjcmlwdGlvbnNTZXJ2aWNlLnNhdmVEZWZhdWx0U3Vic2NyaXB0aW9uc1RvQ3VycmVudFRlbmFudChcbiAgICAgICAgZGVmYXVsdFN1YnNjcmlwdGlvbnNcbiAgICAgICk7XG4gICAgICB0aGlzLmFsZXJ0U2VydmljZS5zdWNjZXNzKGdldHRleHQoJ1NhdmVkLicpKTtcbiAgICB9IGNhdGNoIChleCkge1xuICAgICAgdGhpcy5hbGVydFNlcnZpY2UuYWRkU2VydmVyRmFpbHVyZShleCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvbk92ZXJyaWRlT25DcmVhdGlvblN1YnNjcmlwdGlvbnNDaGFuZ2Uob3ZlcnJpZGVPbkNyZWF0aW9uU3Vic2NyaXB0aW9uczogYm9vbGVhbikge1xuICAgIGNvbnN0IGFwcFJvd3NDb250cm9scyA9ICh0aGlzLmZvcm0uY29udHJvbHMuYXBwUm93cyBhcyBGb3JtQXJyYXkpLmNvbnRyb2xzO1xuICAgIGlmIChvdmVycmlkZU9uQ3JlYXRpb25TdWJzY3JpcHRpb25zKSB7XG4gICAgICB0aGlzLmVuYWJsZVN1YnNjcmliZU9uQ3JlYXRpb25DaGVja2JveGVzKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuZGlzYWJsZVN1YnNjcmliZU9uQ3JlYXRpb25DaGVja2JveGVzKCk7XG4gICAgdGhpcy5yZXN0b3JlU3Vic2NyaWJlT25DcmVhdGlvbkZyb21QYXJlbnQoKTtcbiAgfVxuXG4gIHByaXZhdGUgZW5hYmxlU3Vic2NyaWJlT25DcmVhdGlvbkNoZWNrYm94ZXMoKSB7XG4gICAgY29uc3QgYXBwUm93c0NvbnRyb2xzID0gKHRoaXMuZm9ybS5jb250cm9scy5hcHBSb3dzIGFzIEZvcm1BcnJheSkuY29udHJvbHM7XG4gICAgYXBwUm93c0NvbnRyb2xzLmZvckVhY2goYXBwUm93Q29udHJvbCA9PiB7XG4gICAgICBhcHBSb3dDb250cm9sLmdldCgnc3Vic2NyaWJlZE9uQ3JlYXRpb24nKS5lbmFibGUoeyBlbWl0RXZlbnQ6IGZhbHNlIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBkaXNhYmxlU3Vic2NyaWJlT25DcmVhdGlvbkNoZWNrYm94ZXMoKSB7XG4gICAgY29uc3QgYXBwUm93c0NvbnRyb2xzID0gKHRoaXMuZm9ybS5jb250cm9scy5hcHBSb3dzIGFzIEZvcm1BcnJheSkuY29udHJvbHM7XG4gICAgYXBwUm93c0NvbnRyb2xzLmZvckVhY2goYXBwUm93Q29udHJvbCA9PiB7XG4gICAgICBhcHBSb3dDb250cm9sLmdldCgnc3Vic2NyaWJlZE9uQ3JlYXRpb24nKS5kaXNhYmxlKHsgZW1pdEV2ZW50OiBmYWxzZSB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgcmVzdG9yZVN1YnNjcmliZU9uQ3JlYXRpb25Gcm9tUGFyZW50KCkge1xuICAgIGNvbnN0IGFwcFJvd3NDb250cm9scyA9ICh0aGlzLmZvcm0uY29udHJvbHMuYXBwUm93cyBhcyBGb3JtQXJyYXkpLmNvbnRyb2xzO1xuICAgIGFwcFJvd3NDb250cm9scy5mb3JFYWNoKGFwcFJvd0NvbnRyb2wgPT4ge1xuICAgICAgYXBwUm93Q29udHJvbC5wYXRjaFZhbHVlKHtcbiAgICAgICAgc3Vic2NyaWJlZE9uQ3JlYXRpb246IHRoaXMuaXNTdWJzY3JpYmVkKFxuICAgICAgICAgIGFwcFJvd0NvbnRyb2wudmFsdWUuYXBwLFxuICAgICAgICAgIHRoaXMucGFyZW50RGVmYXVsdFN1YnNjcmlwdGlvbnMub25DcmVhdGlvblN1YnNjcmlwdGlvbnNcbiAgICAgICAgKVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIG9uT3ZlcnJpZGVPblVwZ3JhZGVTdWJzY3JpcHRpb25zQ2hhbmdlKG92ZXJyaWRlT25VcGdyYWRlU3Vic2NyaXB0aW9uczogYm9vbGVhbikge1xuICAgIGNvbnN0IGFwcFJvd3NDb250cm9scyA9ICh0aGlzLmZvcm0uY29udHJvbHMuYXBwUm93cyBhcyBGb3JtQXJyYXkpLmNvbnRyb2xzO1xuICAgIGlmIChvdmVycmlkZU9uVXBncmFkZVN1YnNjcmlwdGlvbnMpIHtcbiAgICAgIHRoaXMuZW5hYmxlU3Vic2NyaWJlT25VcGdyYWRlQ2hlY2tib3hlcygpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmRpc2FibGVTdWJzY3JpYmVPblVwZ3JhZGVDaGVja2JveGVzKCk7XG4gICAgdGhpcy5yZXN0b3JlU3Vic2NyaWJlT25VcGdyYWRlRnJvbVBhcmVudCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBlbmFibGVTdWJzY3JpYmVPblVwZ3JhZGVDaGVja2JveGVzKCkge1xuICAgIGNvbnN0IGFwcFJvd3NDb250cm9scyA9ICh0aGlzLmZvcm0uY29udHJvbHMuYXBwUm93cyBhcyBGb3JtQXJyYXkpLmNvbnRyb2xzO1xuICAgIGFwcFJvd3NDb250cm9scy5mb3JFYWNoKGFwcFJvd0NvbnRyb2wgPT4ge1xuICAgICAgYXBwUm93Q29udHJvbC5nZXQoJ3N1YnNjcmliZWRPblVwZ3JhZGUnKS5lbmFibGUoeyBlbWl0RXZlbnQ6IGZhbHNlIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBkaXNhYmxlU3Vic2NyaWJlT25VcGdyYWRlQ2hlY2tib3hlcygpIHtcbiAgICBjb25zdCBhcHBSb3dzQ29udHJvbHMgPSAodGhpcy5mb3JtLmNvbnRyb2xzLmFwcFJvd3MgYXMgRm9ybUFycmF5KS5jb250cm9scztcbiAgICBhcHBSb3dzQ29udHJvbHMuZm9yRWFjaChhcHBSb3dDb250cm9sID0+IHtcbiAgICAgIGFwcFJvd0NvbnRyb2wuZ2V0KCdzdWJzY3JpYmVkT25VcGdyYWRlJykuZGlzYWJsZSh7IGVtaXRFdmVudDogZmFsc2UgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHJlc3RvcmVTdWJzY3JpYmVPblVwZ3JhZGVGcm9tUGFyZW50KCkge1xuICAgIGNvbnN0IGFwcFJvd3NDb250cm9scyA9ICh0aGlzLmZvcm0uY29udHJvbHMuYXBwUm93cyBhcyBGb3JtQXJyYXkpLmNvbnRyb2xzO1xuICAgIGFwcFJvd3NDb250cm9scy5mb3JFYWNoKGFwcFJvd0NvbnRyb2wgPT4ge1xuICAgICAgYXBwUm93Q29udHJvbC5wYXRjaFZhbHVlKHtcbiAgICAgICAgc3Vic2NyaWJlZE9uVXBncmFkZTogdGhpcy5pc1N1YnNjcmliZWQoXG4gICAgICAgICAgYXBwUm93Q29udHJvbC52YWx1ZS5hcHAsXG4gICAgICAgICAgdGhpcy5wYXJlbnREZWZhdWx0U3Vic2NyaXB0aW9ucy5vblVwZ3JhZGVTdWJzY3JpcHRpb25zXG4gICAgICAgIClcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkRGVmYXVsdFN1YnNjcmlwdGlvbnMoKSB7XG4gICAgdGhpcy5wYXJlbnREZWZhdWx0U3Vic2NyaXB0aW9ucyA9IGF3YWl0IHRoaXMuZGVmYXVsdFN1YnNjcmlwdGlvbnNTZXJ2aWNlLmdldERlZmF1bHRTdWJzY3JpcHRpb25zRXZhbHVhdGVkRnJvbVBhcmVudFRlbmFudCgpO1xuICAgIHRoaXMuY3VycmVudERlZmF1bHRTdWJzY3JpcHRpb25zID0gYXdhaXQgdGhpcy5kZWZhdWx0U3Vic2NyaXB0aW9uc1NlcnZpY2UuZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbnNGcm9tQ3VycmVudFRlbmFudCgpO1xuXG4gICAgY29uc3Qge1xuICAgICAgb3ZlcnJpZGVPbkNyZWF0aW9uU3Vic2NyaXB0aW9ucyxcbiAgICAgIG92ZXJyaWRlT25VcGdyYWRlU3Vic2NyaXB0aW9uc1xuICAgIH0gPSB0aGlzLmN1cnJlbnREZWZhdWx0U3Vic2NyaXB0aW9ucztcbiAgICBjb25zdCBvbkNyZWF0aW9uU3Vic2NyaXB0aW9ucyA9IG92ZXJyaWRlT25DcmVhdGlvblN1YnNjcmlwdGlvbnNcbiAgICAgID8gdGhpcy5jdXJyZW50RGVmYXVsdFN1YnNjcmlwdGlvbnMub25DcmVhdGlvblN1YnNjcmlwdGlvbnNcbiAgICAgIDogdGhpcy5wYXJlbnREZWZhdWx0U3Vic2NyaXB0aW9ucy5vbkNyZWF0aW9uU3Vic2NyaXB0aW9ucztcbiAgICBjb25zdCBvblVwZ3JhZGVTdWJzY3JpcHRpb25zID0gb3ZlcnJpZGVPblVwZ3JhZGVTdWJzY3JpcHRpb25zXG4gICAgICA/IHRoaXMuY3VycmVudERlZmF1bHRTdWJzY3JpcHRpb25zLm9uVXBncmFkZVN1YnNjcmlwdGlvbnNcbiAgICAgIDogdGhpcy5wYXJlbnREZWZhdWx0U3Vic2NyaXB0aW9ucy5vblVwZ3JhZGVTdWJzY3JpcHRpb25zO1xuXG4gICAgdGhpcy5mb3JtLnBhdGNoVmFsdWUoe1xuICAgICAgb3ZlcnJpZGVPbkNyZWF0aW9uU3Vic2NyaXB0aW9ucyxcbiAgICAgIG92ZXJyaWRlT25VcGdyYWRlU3Vic2NyaXB0aW9uc1xuICAgIH0pO1xuICAgICh0aGlzLmZvcm0uY29udHJvbHMuYXBwUm93cyBhcyBGb3JtQXJyYXkpLmNvbnRyb2xzLmZvckVhY2goYXBwUm93Q29udHJvbCA9PiB7XG4gICAgICBhcHBSb3dDb250cm9sLnBhdGNoVmFsdWUoe1xuICAgICAgICBzdWJzY3JpYmVkT25DcmVhdGlvbjogdGhpcy5pc1N1YnNjcmliZWQoYXBwUm93Q29udHJvbC52YWx1ZS5hcHAsIG9uQ3JlYXRpb25TdWJzY3JpcHRpb25zKSxcbiAgICAgICAgc3Vic2NyaWJlZE9uVXBncmFkZTogdGhpcy5pc1N1YnNjcmliZWQoYXBwUm93Q29udHJvbC52YWx1ZS5hcHAsIG9uVXBncmFkZVN1YnNjcmlwdGlvbnMpXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGVmYXVsdFN1YnNjcmlwdGlvbnNGb3JTYXZlKCk6IERlZmF1bHRTdWJzY3JpcHRpb25zIHtcbiAgICBjb25zdCB7IHZhbHVlIH0gPSB0aGlzLmZvcm07XG4gICAgcmV0dXJuIHtcbiAgICAgIG92ZXJyaWRlT25DcmVhdGlvblN1YnNjcmlwdGlvbnM6IHZhbHVlLm92ZXJyaWRlT25DcmVhdGlvblN1YnNjcmlwdGlvbnMsXG4gICAgICBvbkNyZWF0aW9uU3Vic2NyaXB0aW9uczogdmFsdWUub3ZlcnJpZGVPbkNyZWF0aW9uU3Vic2NyaXB0aW9uc1xuICAgICAgICA/IHZhbHVlLmFwcFJvd3MuZmlsdGVyKGFwcCA9PiBhcHAuc3Vic2NyaWJlZE9uQ3JlYXRpb24pLm1hcChhcHAgPT4gYXBwLmFwcClcbiAgICAgICAgOiBudWxsLFxuICAgICAgb3ZlcnJpZGVPblVwZ3JhZGVTdWJzY3JpcHRpb25zOiB2YWx1ZS5vdmVycmlkZU9uVXBncmFkZVN1YnNjcmlwdGlvbnMsXG4gICAgICBvblVwZ3JhZGVTdWJzY3JpcHRpb25zOiB2YWx1ZS5vdmVycmlkZU9uVXBncmFkZVN1YnNjcmlwdGlvbnNcbiAgICAgICAgPyB2YWx1ZS5hcHBSb3dzLmZpbHRlcihhcHAgPT4gYXBwLnN1YnNjcmliZWRPblVwZ3JhZGUpLm1hcChhcHAgPT4gYXBwLmFwcClcbiAgICAgICAgOiBudWxsXG4gICAgfTtcbiAgfVxufVxuIl19